import{r as w}from"./index-f1f749bf.js";function X(e){return e.op==="SYNC"}function Y(e){return e.op==="INSERT"}function Q(e){return e.op==="INVALIDATE"}function Z(e){return e.op==="DELETE"}function tt(e){return e.type==="m.room.create"}function et(e){return e.type==="m.room.avatar"}function nt(e){return e.type==="m.space.child"}function ot(e){return e.type==="m.space.parent"}class L{constructor(t,n){this.roomID=t,this.hostname=n}events=[];stateEvents=[];name="Unknown Room";notification_count=0;notification_highlight_count=0;joined_count=0;invited_count=0;addEvents(t){this.events.push(...t)}addStateEvents(t){this.stateEvents.push(...t)}getAvatarURL(){let t;return this.stateEvents.forEach(n=>{if(et(n)){const o=n.content.url;o?.startsWith("mxc://")&&(t=`${this.hostname}/_matrix/media/r0/download/${o.substring(6)}`)}}),t}isSpace(){let t=!1;return this.stateEvents.forEach(n=>{t=tt(n)&&n.content.type==="m.space"}),t}setName(t){this.name=t}getName(){return this.name}setNotificationCount(t){this.notification_count=t}getNotificationCount(){return this.notification_count}setNotificationHighlightCount(t){this.notification_highlight_count=t}getNotificationHighlightCount(){return this.notification_highlight_count}setJoinedCount(t){this.joined_count=t}getJoinedCount(){return this.joined_count}setInvitedCount(t){this.invited_count=t}getInvitedCount(){return this.invited_count}getSpaceChildrenIDs(){const t=[];return this.stateEvents.forEach(n=>{nt(n)&&t.push(n.state_key)}),t}getSpaceParentIDs(){const t=[];return this.stateEvents.forEach(n=>{ot(n)&&t.push({roomID:n.state_key,canonical:n.content.canonical||!1})}),t}isDM(){return!1}isOnline(){return!1}}var S={},st={get exports(){return S},set exports(e){S=e}},b=typeof Reflect=="object"?Reflect:null,P=b&&typeof b.apply=="function"?b.apply:function(t,n,o){return Function.prototype.apply.call(t,n,o)},E;b&&typeof b.ownKeys=="function"?E=b.ownKeys:Object.getOwnPropertySymbols?E=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:E=function(t){return Object.getOwnPropertyNames(t)};function it(e){console&&console.warn&&console.warn(e)}var B=Number.isNaN||function(t){return t!==t};function l(){l.init.call(this)}st.exports=l;S.once=ft;l.EventEmitter=l;l.prototype._events=void 0;l.prototype._eventsCount=0;l.prototype._maxListeners=void 0;var M=10;function R(e){if(typeof e!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}Object.defineProperty(l,"defaultMaxListeners",{enumerable:!0,get:function(){return M},set:function(e){if(typeof e!="number"||e<0||B(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");M=e}});l.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};l.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||B(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function $(e){return e._maxListeners===void 0?l.defaultMaxListeners:e._maxListeners}l.prototype.getMaxListeners=function(){return $(this)};l.prototype.emit=function(t){for(var n=[],o=1;o<arguments.length;o++)n.push(arguments[o]);var s=t==="error",r=this._events;if(r!==void 0)s=s&&r.error===void 0;else if(!s)return!1;if(s){var i;if(n.length>0&&(i=n[0]),i instanceof Error)throw i;var c=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw c.context=i,c}var a=r[t];if(a===void 0)return!1;if(typeof a=="function")P(a,this,n);else for(var u=a.length,f=J(a,u),o=0;o<u;++o)P(f[o],this,n);return!0};function V(e,t,n,o){var s,r,i;if(R(n),r=e._events,r===void 0?(r=e._events=Object.create(null),e._eventsCount=0):(r.newListener!==void 0&&(e.emit("newListener",t,n.listener?n.listener:n),r=e._events),i=r[t]),i===void 0)i=r[t]=n,++e._eventsCount;else if(typeof i=="function"?i=r[t]=o?[n,i]:[i,n]:o?i.unshift(n):i.push(n),s=$(e),s>0&&i.length>s&&!i.warned){i.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=i.length,it(c)}return e}l.prototype.addListener=function(t,n){return V(this,t,n,!1)};l.prototype.on=l.prototype.addListener;l.prototype.prependListener=function(t,n){return V(this,t,n,!0)};function rt(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function W(e,t,n){var o={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},s=rt.bind(o);return s.listener=n,o.wrapFn=s,s}l.prototype.once=function(t,n){return R(n),this.on(t,W(this,t,n)),this};l.prototype.prependOnceListener=function(t,n){return R(n),this.prependListener(t,W(this,t,n)),this};l.prototype.removeListener=function(t,n){var o,s,r,i,c;if(R(n),s=this._events,s===void 0)return this;if(o=s[t],o===void 0)return this;if(o===n||o.listener===n)--this._eventsCount===0?this._events=Object.create(null):(delete s[t],s.removeListener&&this.emit("removeListener",t,o.listener||n));else if(typeof o!="function"){for(r=-1,i=o.length-1;i>=0;i--)if(o[i]===n||o[i].listener===n){c=o[i].listener,r=i;break}if(r<0)return this;r===0?o.shift():at(o,r),o.length===1&&(s[t]=o[0]),s.removeListener!==void 0&&this.emit("removeListener",t,c||n)}return this};l.prototype.off=l.prototype.removeListener;l.prototype.removeAllListeners=function(t){var n,o,s;if(o=this._events,o===void 0)return this;if(o.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):o[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete o[t]),this;if(arguments.length===0){var r=Object.keys(o),i;for(s=0;s<r.length;++s)i=r[s],i!=="removeListener"&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(n=o[t],typeof n=="function")this.removeListener(t,n);else if(n!==void 0)for(s=n.length-1;s>=0;s--)this.removeListener(t,n[s]);return this};function F(e,t,n){var o=e._events;if(o===void 0)return[];var s=o[t];return s===void 0?[]:typeof s=="function"?n?[s.listener||s]:[s]:n?ct(s):J(s,s.length)}l.prototype.listeners=function(t){return F(this,t,!0)};l.prototype.rawListeners=function(t){return F(this,t,!1)};l.listenerCount=function(e,t){return typeof e.listenerCount=="function"?e.listenerCount(t):K.call(e,t)};l.prototype.listenerCount=K;function K(e){var t=this._events;if(t!==void 0){var n=t[e];if(typeof n=="function")return 1;if(n!==void 0)return n.length}return 0}l.prototype.eventNames=function(){return this._eventsCount>0?E(this._events):[]};function J(e,t){for(var n=new Array(t),o=0;o<t;++o)n[o]=e[o];return n}function at(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function ct(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}function ft(e,t){return new Promise(function(n,o){function s(i){e.removeListener(t,r),o(i)}function r(){typeof e.removeListener=="function"&&e.removeListener("error",s),n([].slice.call(arguments))}q(e,t,r,{once:!0}),t!=="error"&&ut(e,s,{once:!0})})}function ut(e,t,n){typeof e.on=="function"&&q(e,"error",t,n)}function q(e,t,n,o){if(typeof e.on=="function")o.once?e.once(t,n):e.on(t,n);else if(typeof e.addEventListener=="function")e.addEventListener(t,function s(r){o.once&&e.removeEventListener(t,s),n(r)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}const ht=(e,t)=>t.some(n=>e instanceof n);let A,H;function lt(){return A||(A=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function dt(){return H||(H=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const z=new WeakMap,N=new WeakMap,G=new WeakMap,D=new WeakMap,k=new WeakMap;function mt(e){const t=new Promise((n,o)=>{const s=()=>{e.removeEventListener("success",r),e.removeEventListener("error",i)},r=()=>{n(_(e.result)),s()},i=()=>{o(e.error),s()};e.addEventListener("success",r),e.addEventListener("error",i)});return t.then(n=>{n instanceof IDBCursor&&z.set(n,e)}).catch(()=>{}),k.set(t,e),t}function gt(e){if(N.has(e))return;const t=new Promise((n,o)=>{const s=()=>{e.removeEventListener("complete",r),e.removeEventListener("error",i),e.removeEventListener("abort",i)},r=()=>{n(),s()},i=()=>{o(e.error||new DOMException("AbortError","AbortError")),s()};e.addEventListener("complete",r),e.addEventListener("error",i),e.addEventListener("abort",i)});N.set(e,t)}let j={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return N.get(e);if(t==="objectStoreNames")return e.objectStoreNames||G.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return _(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function pt(e){j=e(j)}function vt(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...n){const o=e.call(C(this),t,...n);return G.set(o,t.sort?t.sort():[t]),_(o)}:dt().includes(e)?function(...t){return e.apply(C(this),t),_(z.get(this))}:function(...t){return _(e.apply(C(this),t))}}function wt(e){return typeof e=="function"?vt(e):(e instanceof IDBTransaction&&gt(e),ht(e,lt())?new Proxy(e,j):e)}function _(e){if(e instanceof IDBRequest)return mt(e);if(D.has(e))return D.get(e);const t=wt(e);return t!==e&&(D.set(e,t),k.set(t,e)),t}const C=e=>k.get(e);function yt(e,t,{blocked:n,upgrade:o,blocking:s,terminated:r}={}){const i=indexedDB.open(e,t),c=_(i);return o&&i.addEventListener("upgradeneeded",a=>{o(_(i.result),a.oldVersion,a.newVersion,_(i.transaction),a)}),n&&i.addEventListener("blocked",a=>n(a.oldVersion,a.newVersion,a)),c.then(a=>{r&&a.addEventListener("close",()=>r()),s&&a.addEventListener("versionchange",u=>s(u.oldVersion,u.newVersion,u))}).catch(()=>{}),c}const _t=["get","getKey","getAll","getAllKeys","count"],It=["put","add","delete","clear"],T=new Map;function U(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(T.get(t))return T.get(t);const n=t.replace(/FromIndex$/,""),o=t!==n,s=It.includes(n);if(!(n in(o?IDBIndex:IDBObjectStore).prototype)||!(s||_t.includes(n)))return;const r=async function(i,...c){const a=this.transaction(i,s?"readwrite":"readonly");let u=a.store;return o&&(u=u.index(c.shift())),(await Promise.all([u[n](...c),s&&a.done]))[0]};return T.set(t,r),r}pt(e=>({...e,get:(t,n,o)=>U(t,n)||e.get(t,n,o),has:(t,n)=>!!U(t,n)||e.has(t,n)}));class bt extends S{static _instance;access_token;device_id;mxid;hostname;slidingSyncHostname;syncing=!1;roomsInView=[];roomToRoom=new Map;syncPos;initialSync=!0;database;profileInfo;lastRanges;lastTxnID;get isLoggedIn(){return this.access_token!==void 0}static async Instance(){let t=this._instance;if(!t){t=this._instance=new this,t.database||await t.createDatabase();const n=t.database?.transaction("loginInfo","readonly"),o=await n?.store.getAll();if(await n?.done,o&&o.length>0){t.mxid=o[0].userId,t.hostname=o[0].hostname,t.slidingSyncHostname=o[0].slidingSyncHostname,t.access_token=o[0].access_token,t.device_id=o[0].device_id,t.profileInfo={avatar_url:o[0].avatarUrl,displayname:o[0].displayName};const s=t.database?.transaction("syncInfo","readonly"),r=await s?.store.get(t.mxid);await s?.done,r&&(t.syncPos=r.syncPos,t.initialSync=r.initialSync,t.lastRanges=r.lastRanges,t.lastTxnID=r.lastTxnID);const i=t.database?.transaction("rooms","readonly"),c=await i?.store.getAll();if(await i?.done,c){for(const a of c){const u=new L(a.roomID,t.hostname);u.setInvitedCount(a.invited_count),u.setJoinedCount(a.joined_count),u.setNotificationCount(a.notification_count),u.setNotificationHighlightCount(a.highlight_count),u.setName(a.name),a.events&&u.addEvents(a.events),a.stateEvents&&u.addStateEvents(a.stateEvents),t.roomToRoom.set(a.windowID,u)}t.emit("rooms",new Set(t.roomToRoom.values()))}}}return t}async createDatabase(){this.database=await yt("matrix",2,{upgrade(t,n){n<1&&(t.createObjectStore("rooms",{keyPath:"windowID"}).createIndex("by-windowID","windowID"),t.createObjectStore("loginInfo",{keyPath:"userId"}),t.createObjectStore("syncInfo",{keyPath:"userId"}))}})}findNextFreeIndex(){const t=Array.from(this.roomToRoom.keys()),n=Math.max(...t),o=0;let s=n+1;console.log("Max:",n),console.log("Min:",o),console.log("Keys:",t);for(let r=o;r<=n;r++)if(!t.includes(r)){console.log("Missing:",r),s=r;break}return s}async setHostname(t){if(!t.startsWith("https://"))throw Error("Hostname must start with 'https://'");this.database||await this.createDatabase();const n=this.database?.transaction("loginInfo","readwrite");await n?.store.put({userId:this.mxid,hostname:t,slidingSyncHostname:this.slidingSyncHostname,access_token:this.access_token,device_id:this.device_id}),await n?.done,this.hostname=t}async startSync(){if(!this.isLoggedIn)throw Error("Not logged in");if(this.database||await this.createDatabase(),!this.syncing)for(this.syncing=!0;this.syncing;)try{await this.sync()}catch(t){console.error(t);return}}stopSync(){this.syncing=!1}async sync(){if(!this.isLoggedIn)throw Error("Not logged in");if(!this.slidingSyncHostname)throw Error("Hostname must be set first");let t={overview:[[0,10]]},n=1;if(!this.initialSync){n=10;const a=[...this.roomToRoom.entries()].filter(([f,h])=>this.roomsInView.includes(h.roomID)).map(([f])=>f).sort();a.push(a[a.length-1]+1),t={overview:a.reduce((f,h,d,m)=>d===0?(f.push([h,h]),f):h===m[d-1]+1?(f[f.length-1][1]=h,f):(f.push([h,h]),f),[])}}this.lastRanges&&Object.entries(t).toString()!==Object.entries(this.lastRanges).toString()&&(console.log("Ranges changed, resetting sync txn_id"),this.lastRanges=t,this.lastTxnID=Date.now().toString()),this.lastRanges||(this.lastRanges=t,this.lastTxnID=Date.now().toString());let o=`${this.slidingSyncHostname}/_matrix/client/unstable/org.matrix.msc3575/sync?timeout=30000`;this.syncPos&&(o=`${this.slidingSyncHostname}/_matrix/client/unstable/org.matrix.msc3575/sync?timeout=30000&pos=${this.syncPos}`);const s=await fetch(o,{method:"POST",headers:{Authorization:`Bearer ${this.access_token}`},body:JSON.stringify({txn_id:this.lastTxnID,lists:{spaces:{slow_get_all_rooms:!0,sort:["by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.avatar","*"]],timeline_limit:n,filters:{room_types:["m.space"]}},overview:{ranges:this.lastRanges.overview,sort:["by_notification_level","by_recency","by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.avatar","*"]],timeline_limit:n,filters:{}}},bump_event_types:["m.room.message","m.room.encrypted"]})});if(!s.ok)throw console.error(s),Error("Error syncing. See console for error.");const r=await s.json();this.syncPos=r.pos;const i=this.database?.transaction("syncInfo","readwrite");await i?.store.put({userId:this.mxid,syncPos:this.syncPos,initialSync:this.initialSync,lastRanges:this.lastRanges,lastTxnID:this.lastTxnID}),await i?.done;for(const a in r.lists){const u=r.lists[a];if(u.ops){for(const f of u.ops)if(X(f)){const h=this.database?.transaction("rooms","readwrite");for(let d=f.range[0];d<=f.range[1];d++){await h?.store.delete(d),this.roomToRoom.delete(d);const m=new L(f.room_ids[d],this.hostname);m.setName("Unknown Room"),this.roomToRoom.set(d,m),await h?.store.put({windowID:d,roomID:m.roomID,name:m.getName(),notification_count:m.getNotificationCount(),highlight_count:m.getNotificationHighlightCount(),joined_count:m.getJoinedCount(),invited_count:m.getInvitedCount(),avatarUrl:m.getAvatarURL(),isSpace:m.isSpace()})}await h?.done}else if(Y(f)){console.log("Got INSERT OP",f),console.log("List",this.roomToRoom);const h=f.index,d=this.findNextFreeIndex();if(console.log("Empty spot",d),console.log("Position",h),d!==h){const y=Math.max(...this.roomToRoom.keys()),I=Math.min(...this.roomToRoom.keys()),p=this.database?.transaction("rooms","readwrite");if(d>h&&d<=y){console.log("Shifting right");for(let g=0;g<d&&g>=I&&g<=y;g++){console.log(g);const v=this.roomToRoom.get(g);v!==void 0&&(await p?.store.put({windowID:g+1,roomID:v.roomID,name:v.getName(),notification_count:v.getNotificationCount(),highlight_count:v.getNotificationHighlightCount(),joined_count:v.getJoinedCount(),invited_count:v.getInvitedCount(),avatarUrl:v.getAvatarURL(),isSpace:v.isSpace()}),this.roomToRoom.delete(g),this.roomToRoom.set(g+1,v))}console.log("List",this.roomToRoom)}else if(d<h&&d<=y){console.log("Shifting left");for(let g=0;g>d&&g>=I&&g<=y;g--){const v=this.roomToRoom.get(g);v!==void 0&&(await p?.store.put({windowID:g-1,roomID:v.roomID,name:v.getName(),notification_count:v.getNotificationCount(),highlight_count:v.getNotificationHighlightCount(),joined_count:v.getJoinedCount(),invited_count:v.getInvitedCount(),avatarUrl:v.getAvatarURL(),isSpace:v.isSpace()}),this.roomToRoom.delete(g),this.roomToRoom.set(g-1,v))}console.log("List",this.roomToRoom)}console.log("Shifting done"),console.log("Empty spot",this.findNextFreeIndex()),console.log("Position",h),console.log("List",this.roomToRoom),await p?.done}this.roomToRoom.get(h)!==void 0&&console.error("Shifting failed");const m=new L(f.room_id,this.hostname);console.log(m),m.setName("Unknown Room"),this.roomToRoom.set(h,m);const x=this.database?.transaction("rooms","readwrite");await x?.store.put({windowID:h,roomID:f.room_id,name:m.getName(),notification_count:m.getNotificationCount(),highlight_count:m.getNotificationHighlightCount(),joined_count:m.getJoinedCount(),invited_count:m.getInvitedCount(),avatarUrl:m.getAvatarURL(),isSpace:m.isSpace()}),await x?.done}else if(Z(f)){console.log("Got DELETE OP",f);const h=this.database?.transaction("rooms","readwrite");await h?.store.delete(f.index),await h?.done,this.roomToRoom.delete(f.index)}else if(Q(f)){const h=this.database?.transaction("rooms","readwrite");for(let d=f.range[0];d<=f.range[1];d++)await h?.store.delete(d),this.roomToRoom.delete(d);await h?.done}}}const c=this.database?.transaction("rooms","readwrite");for(const a in r.rooms){const u=r.rooms[a],f=u.name,h=u.notification_count,d=u.highlight_count,m=u.joined_count,x=u.invited_count,y=u.timeline,I=u.required_state,p=[...this.roomToRoom.values()].find(g=>g.roomID===a);if(!p){console.error("Could not find roomObj for roomID",a);continue}f&&p.setName(f),p.setNotificationCount(h),p.setNotificationHighlightCount(d),p.setJoinedCount(m),p.setInvitedCount(x),y&&p.addEvents(y),I&&p.addStateEvents(I),await c?.store.put({windowID:[...this.roomToRoom.keys()].find(g=>this.roomToRoom.get(g)===p),roomID:p.roomID,name:p.getName(),notification_count:p.getNotificationCount(),highlight_count:p.getNotificationHighlightCount(),joined_count:p.getJoinedCount(),invited_count:p.getInvitedCount(),events:y,stateEvents:I,avatarUrl:p.getAvatarURL(),isSpace:p.isSpace()})}await c?.done,r.rooms&&Object.keys(r.rooms).length>0&&this.emit("rooms",new Set(this.roomToRoom.values()))}addInViewRoom(t){this.roomsInView.push(t)}removeInViewRoom(t){this.roomsInView=this.roomsInView.filter(n=>n!==t)}getRooms(){return new Set(this.roomToRoom.values())}getSpaces(){return[...this.roomToRoom.values()].filter(t=>t.isSpace())}getSpacesWithRooms(){const t=this.getSpaces(),n=new Set;for(const o of t){const s=o.getSpaceChildrenIDs(),r=new Set([...this.getRooms()].filter(i=>s.includes(i.roomID)));n.add({spaceRoom:o,children:r})}for(const o of this.getRooms()){const s=o.getSpaceParentIDs();for(const r of s){const i=[...this.getRooms()].find(a=>a.roomID===r.roomID);if(!i)continue;const c=[...n].find(a=>a.spaceRoom.roomID===i.roomID);if(c){[...c.children].find(a=>a.roomID===o.roomID)||c.children.add(o);continue}n.add({spaceRoom:i,children:new Set([o])})}}return n}async getLoginFlows(){if(!this.hostname)throw Error("Hostname must be set first");const t=await fetch(`${this.hostname}/_matrix/client/v3/login`);if(!t.ok)throw console.error(t),Error("Error requesting login flows. See console for error.");return await t.json()}async getWellKnown(){if(!this.hostname)throw Error("Hostname must be set first");const t=await fetch(`${this.hostname}/.well-known/matrix/client`);if(!t.ok)throw console.error(t),Error("Error requesting login flows. See console for error.");return await t.json()}async passwordLogin(t,n,o=5){if(this.database||await this.createDatabase(),!t)throw Error("Username must be set");if(!n)throw Error("Password must be set");this.mxid=t,await this.setHostname(`https://${t.split(":")[1]}`);try{const c=await this.getWellKnown();if(c["m.homeserver"]?.base_url&&await this.setHostname(c["m.homeserver"].base_url),c["org.matrix.msc3575.proxy"]?.url){const a=this.database?.transaction("loginInfo","readwrite");await a?.store.put({userId:this.mxid,hostname:this.hostname,slidingSyncHostname:c["org.matrix.msc3575.proxy"].url,access_token:this.access_token,device_id:this.device_id}),await a?.done,this.slidingSyncHostname=c["org.matrix.msc3575.proxy"].url}else throw Error("No sliding sync proxy found")}catch(c){console.warn(`No well-known found for ${this.hostname}:
${c}`)}if(((await this.getLoginFlows()).flows.filter(c=>c.type==="m.login.password")?.length||0)==0)throw Error("Password login is not supported by this homeserver");const r=await fetch(`${this.hostname}/_matrix/client/r0/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"m.login.password",identifier:{type:"m.id.user",user:t},user:t,password:n})});if(!r.ok)throw console.error(r),Error("Error logging in. See console for error.");const i=await r.json();if(St(i))throw Error(`Error logging in: ${i.errcode}: ${i.error}`);if(xt(i)&&(console.error(`Rate limited. Retrying in ${i.retry_after_ms}ms. ${o} tries left.`),await this.passwordLogin(t,n,o-1)),Et(i)){const c=this.database?.transaction("loginInfo","readwrite");await c?.store.put({userId:i.user_id,hostname:this.hostname,slidingSyncHostname:this.slidingSyncHostname,access_token:i.access_token,device_id:i.device_id}),await c?.done,this.access_token=i.access_token,this.device_id=i.device_id,this.mxid=i.user_id}}async fetchProfileInfo(t){if(this.profileInfo)return this.profileInfo;if(!this.hostname)throw Error("Hostname must be set first");if(this.database||await this.createDatabase(),!this.access_token)throw Error("Access token must be set first");const n=await fetch(`${this.hostname}/_matrix/client/r0/profile/${t}`,{headers:{Authorization:`Bearer ${this.access_token}`}});if(!n.ok){if(n.status===404||n.status===403)return{};throw console.error(n),Error("Error fetching profile info. See console for error.")}const o=await n.json();o.avatar_url=o.avatar_url?.replace("mxc://",`${this.hostname}/_matrix/media/r0/download/`),this.profileInfo=o;const s=this.database?.transaction("loginInfo","readwrite");return await s?.store.put({userId:this.mxid,device_id:this.device_id,hostname:this.hostname,slidingSyncHostname:this.slidingSyncHostname,access_token:this.access_token,displayName:o.displayname,avatarUrl:o.avatar_url}),await s?.done,o}}function xt(e){return e.retry_after_ms!==void 0}function Et(e){return e.access_token!==void 0}function St(e){return e.errcode!==void 0}const Rt=await bt.Instance(),O=w.createContext(Rt);function Dt(){const e=w.useContext(O),[t,n]=w.useState(e.getRooms());return w.useEffect(()=>{const o=s=>{n(s)};return e.on("rooms",o),e.startSync(),()=>{e.removeListener("rooms",o)}},[]),t}function Ct(){const e=w.useContext(O),[t,n]=w.useState(e.getSpacesWithRooms());return w.useEffect(()=>{const o=s=>{n(e.getSpacesWithRooms())};return e.on("rooms",o),e.startSync(),()=>{e.removeListener("rooms",o)}},[]),t}function Tt(){const e=w.useContext(O),[t,n]=w.useState({displayname:e.mxid||"Unknown"});return w.useEffect(()=>{e.fetchProfileInfo(e.mxid).then(o=>{o.displayname||(o.displayname=e.mxid||"Unknown"),n(o)})},[]),t}export{O as M,Ct as a,Dt as b,Tt as u};
//# sourceMappingURL=client-771c9973.js.map
