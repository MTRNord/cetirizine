import{r as _}from"./index-f1f749bf.js";function z(e){return e.op==="SYNC"}function Y(e){return e.op==="INSERT"}function Q(e){return e.op==="INVALIDATE"}function Z(e){return e.op==="DELETE"}function tt(e){return e.type==="m.room.create"}function et(e){return e.type==="m.room.avatar"}function nt(e){return e.type==="m.space.child"}function ot(e){return e.type==="m.space.parent"}class L{constructor(t,n){this.roomID=t,this.hostname=n}events=[];stateEvents=[];name;notification_count=0;notification_highlight_count=0;joined_count=0;invited_count=0;windowPos={};addEvents(t){this.events.push(...t)}addStateEvents(t){this.stateEvents.push(...t)}getAvatarURL(){let t;return this.stateEvents.forEach(n=>{if(et(n)){const o=n.content.url;o?.startsWith("mxc://")&&(t=`${this.hostname}/_matrix/media/r0/download/${o.substring(6)}`)}}),t}isSpace(){let t=!1;return this.stateEvents.forEach(n=>{tt(n)&&(t=n.content.type==="m.space")}),t}setName(t){this.name=t}getName(){return this.name?this.name:this.roomID}setNotificationCount(t){this.notification_count=t}getNotificationCount(){return this.notification_count}setNotificationHighlightCount(t){this.notification_highlight_count=t}getNotificationHighlightCount(){return this.notification_highlight_count}setJoinedCount(t){this.joined_count=t}getJoinedCount(){return this.joined_count}setInvitedCount(t){this.invited_count=t}getInvitedCount(){return this.invited_count}getSpaceChildrenIDs(){const t=[];return this.stateEvents.forEach(n=>{nt(n)&&t.push(n.state_key)}),t}getSpaceParentIDs(){const t=[];return this.stateEvents.forEach(n=>{ot(n)&&t.push({roomID:n.state_key,canonical:n.content.canonical||!1})}),t}isDM(){return!1}isOnline(){return!1}}var x={},st={get exports(){return x},set exports(e){x=e}},b=typeof Reflect=="object"?Reflect:null,k=b&&typeof b.apply=="function"?b.apply:function(t,n,o){return Function.prototype.apply.call(t,n,o)},E;b&&typeof b.ownKeys=="function"?E=b.ownKeys:Object.getOwnPropertySymbols?E=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:E=function(t){return Object.getOwnPropertyNames(t)};function it(e){console&&console.warn&&console.warn(e)}var B=Number.isNaN||function(t){return t!==t};function d(){d.init.call(this)}st.exports=d;x.once=ft;d.EventEmitter=d;d.prototype._events=void 0;d.prototype._eventsCount=0;d.prototype._maxListeners=void 0;var T=10;function S(e){if(typeof e!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}Object.defineProperty(d,"defaultMaxListeners",{enumerable:!0,get:function(){return T},set:function(e){if(typeof e!="number"||e<0||B(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");T=e}});d.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};d.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||B(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function $(e){return e._maxListeners===void 0?d.defaultMaxListeners:e._maxListeners}d.prototype.getMaxListeners=function(){return $(this)};d.prototype.emit=function(t){for(var n=[],o=1;o<arguments.length;o++)n.push(arguments[o]);var s=t==="error",r=this._events;if(r!==void 0)s=s&&r.error===void 0;else if(!s)return!1;if(s){var i;if(n.length>0&&(i=n[0]),i instanceof Error)throw i;var a=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw a.context=i,a}var f=r[t];if(f===void 0)return!1;if(typeof f=="function")k(f,this,n);else for(var c=f.length,v=J(f,c),o=0;o<c;++o)k(v[o],this,n);return!0};function W(e,t,n,o){var s,r,i;if(S(n),r=e._events,r===void 0?(r=e._events=Object.create(null),e._eventsCount=0):(r.newListener!==void 0&&(e.emit("newListener",t,n.listener?n.listener:n),r=e._events),i=r[t]),i===void 0)i=r[t]=n,++e._eventsCount;else if(typeof i=="function"?i=r[t]=o?[n,i]:[i,n]:o?i.unshift(n):i.push(n),s=$(e),s>0&&i.length>s&&!i.warned){i.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=e,a.type=t,a.count=i.length,it(a)}return e}d.prototype.addListener=function(t,n){return W(this,t,n,!1)};d.prototype.on=d.prototype.addListener;d.prototype.prependListener=function(t,n){return W(this,t,n,!0)};function rt(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function U(e,t,n){var o={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},s=rt.bind(o);return s.listener=n,o.wrapFn=s,s}d.prototype.once=function(t,n){return S(n),this.on(t,U(this,t,n)),this};d.prototype.prependOnceListener=function(t,n){return S(n),this.prependListener(t,U(this,t,n)),this};d.prototype.removeListener=function(t,n){var o,s,r,i,a;if(S(n),s=this._events,s===void 0)return this;if(o=s[t],o===void 0)return this;if(o===n||o.listener===n)--this._eventsCount===0?this._events=Object.create(null):(delete s[t],s.removeListener&&this.emit("removeListener",t,o.listener||n));else if(typeof o!="function"){for(r=-1,i=o.length-1;i>=0;i--)if(o[i]===n||o[i].listener===n){a=o[i].listener,r=i;break}if(r<0)return this;r===0?o.shift():at(o,r),o.length===1&&(s[t]=o[0]),s.removeListener!==void 0&&this.emit("removeListener",t,a||n)}return this};d.prototype.off=d.prototype.removeListener;d.prototype.removeAllListeners=function(t){var n,o,s;if(o=this._events,o===void 0)return this;if(o.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):o[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete o[t]),this;if(arguments.length===0){var r=Object.keys(o),i;for(s=0;s<r.length;++s)i=r[s],i!=="removeListener"&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(n=o[t],typeof n=="function")this.removeListener(t,n);else if(n!==void 0)for(s=n.length-1;s>=0;s--)this.removeListener(t,n[s]);return this};function V(e,t,n){var o=e._events;if(o===void 0)return[];var s=o[t];return s===void 0?[]:typeof s=="function"?n?[s.listener||s]:[s]:n?ct(s):J(s,s.length)}d.prototype.listeners=function(t){return V(this,t,!0)};d.prototype.rawListeners=function(t){return V(this,t,!1)};d.listenerCount=function(e,t){return typeof e.listenerCount=="function"?e.listenerCount(t):F.call(e,t)};d.prototype.listenerCount=F;function F(e){var t=this._events;if(t!==void 0){var n=t[e];if(typeof n=="function")return 1;if(n!==void 0)return n.length}return 0}d.prototype.eventNames=function(){return this._eventsCount>0?E(this._events):[]};function J(e,t){for(var n=new Array(t),o=0;o<t;++o)n[o]=e[o];return n}function at(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function ct(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}function ft(e,t){return new Promise(function(n,o){function s(i){e.removeListener(t,r),o(i)}function r(){typeof e.removeListener=="function"&&e.removeListener("error",s),n([].slice.call(arguments))}K(e,t,r,{once:!0}),t!=="error"&&ut(e,s,{once:!0})})}function ut(e,t,n){typeof e.on=="function"&&K(e,"error",t,n)}function K(e,t,n,o){if(typeof e.on=="function")o.once?e.once(t,n):e.on(t,n);else if(typeof e.addEventListener=="function")e.addEventListener(t,function s(r){o.once&&e.removeEventListener(t,s),n(r)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}const dt=(e,t)=>t.some(n=>e instanceof n);let A,M;function ht(){return A||(A=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function lt(){return M||(M=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const q=new WeakMap,C=new WeakMap,G=new WeakMap,D=new WeakMap,j=new WeakMap;function mt(e){const t=new Promise((n,o)=>{const s=()=>{e.removeEventListener("success",r),e.removeEventListener("error",i)},r=()=>{n(I(e.result)),s()},i=()=>{o(e.error),s()};e.addEventListener("success",r),e.addEventListener("error",i)});return t.then(n=>{n instanceof IDBCursor&&q.set(n,e)}).catch(()=>{}),j.set(t,e),t}function gt(e){if(C.has(e))return;const t=new Promise((n,o)=>{const s=()=>{e.removeEventListener("complete",r),e.removeEventListener("error",i),e.removeEventListener("abort",i)},r=()=>{n(),s()},i=()=>{o(e.error||new DOMException("AbortError","AbortError")),s()};e.addEventListener("complete",r),e.addEventListener("error",i),e.addEventListener("abort",i)});C.set(e,t)}let N={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return C.get(e);if(t==="objectStoreNames")return e.objectStoreNames||G.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return I(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function pt(e){N=e(N)}function wt(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...n){const o=e.call(R(this),t,...n);return G.set(o,t.sort?t.sort():[t]),I(o)}:lt().includes(e)?function(...t){return e.apply(R(this),t),I(q.get(this))}:function(...t){return I(e.apply(R(this),t))}}function vt(e){return typeof e=="function"?wt(e):(e instanceof IDBTransaction&&gt(e),dt(e,ht())?new Proxy(e,N):e)}function I(e){if(e instanceof IDBRequest)return mt(e);if(D.has(e))return D.get(e);const t=vt(e);return t!==e&&(D.set(e,t),j.set(t,e)),t}const R=e=>j.get(e);function yt(e,t,{blocked:n,upgrade:o,blocking:s,terminated:r}={}){const i=indexedDB.open(e,t),a=I(i);return o&&i.addEventListener("upgradeneeded",f=>{o(I(i.result),f.oldVersion,f.newVersion,I(i.transaction),f)}),n&&i.addEventListener("blocked",f=>n(f.oldVersion,f.newVersion,f)),a.then(f=>{r&&f.addEventListener("close",()=>r()),s&&f.addEventListener("versionchange",c=>s(c.oldVersion,c.newVersion,c))}).catch(()=>{}),a}const _t=["get","getKey","getAll","getAllKeys","count"],It=["put","add","delete","clear"],P=new Map;function H(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(P.get(t))return P.get(t);const n=t.replace(/FromIndex$/,""),o=t!==n,s=It.includes(n);if(!(n in(o?IDBIndex:IDBObjectStore).prototype)||!(s||_t.includes(n)))return;const r=async function(i,...a){const f=this.transaction(i,s?"readwrite":"readonly");let c=f.store;return o&&(c=c.index(a.shift())),(await Promise.all([c[n](...a),s&&f.done]))[0]};return P.set(t,r),r}pt(e=>({...e,get:(t,n,o)=>H(t,n)||e.get(t,n,o),has:(t,n)=>!!H(t,n)||e.has(t,n)}));class bt extends x{static _instance;access_token;device_id;mxid;hostname;slidingSyncHostname;syncing=!1;roomsInView=[];rooms=new Set;syncPos;initialSync=!0;database;profileInfo;lastRanges;lastTxnID;get isLoggedIn(){return this.access_token!==void 0}static async Instance(){let t=this._instance;if(!t){t=this._instance=new this,t.database||await t.createDatabase();const n=t.database?.transaction("loginInfo","readonly"),o=await n?.store.getAll();if(await n?.done,o&&o.length>0){t.mxid=o[0].userId,t.hostname=o[0].hostname,t.slidingSyncHostname=o[0].slidingSyncHostname,t.access_token=o[0].access_token,t.device_id=o[0].device_id,t.profileInfo={avatar_url:o[0].avatarUrl,displayname:o[0].displayName};const s=t.database?.transaction("syncInfo","readonly"),r=await s?.store.get(t.mxid);await s?.done,r&&(t.syncPos=r.syncPos,t.initialSync=r.initialSync,t.lastRanges=r.lastRanges,t.lastTxnID=r.lastTxnID);const i=t.database?.transaction("rooms","readonly"),a=await i?.store.getAll();await i?.done,a&&(t.rooms=new Set(a.map(f=>{const c=new L(f.roomID,t.hostname);return c.windowPos=f.windowPos,c.setInvitedCount(f.invited_count),c.setJoinedCount(f.joined_count),c.setNotificationCount(f.notification_count),c.setNotificationHighlightCount(f.highlight_count),c.setName(f.name),f.events&&c.addEvents(f.events),f.stateEvents&&c.addStateEvents(f.stateEvents),c})),t.emit("rooms",t.rooms))}}return t}async createDatabase(){this.database=await yt("matrix",3,{upgrade(t){t.objectStoreNames.contains("rooms")&&t.deleteObjectStore("rooms"),t.objectStoreNames.contains("syncInfo")&&t.deleteObjectStore("syncInfo"),t.createObjectStore("rooms",{keyPath:"roomID"}),t.createObjectStore("loginInfo",{keyPath:"userId"}),t.createObjectStore("syncInfo",{keyPath:"userId"})}})}async setHostname(t){if(!t.startsWith("https://"))throw Error("Hostname must start with 'https://'");this.database||await this.createDatabase();const n=this.database?.transaction("loginInfo","readwrite");await n?.store.put({userId:this.mxid,hostname:t,slidingSyncHostname:this.slidingSyncHostname,access_token:this.access_token,device_id:this.device_id}),await n?.done,this.hostname=t}async startSync(){if(!this.isLoggedIn)throw Error("Not logged in");if(this.database||await this.createDatabase(),!this.syncing)for(this.syncing=!0;this.syncing;)try{await this.sync()}catch(t){console.error(t);return}}stopSync(){this.syncing=!1}isIndexInRange(t,n){for(const o of n)if(o[0]<t&&t<=o[1])return!0;return!1}shiftRight(t,n,o,s){for(let r=o-1;r>s-1;r--)if(this.isIndexInRange(r,n)){const i=[...this.rooms].find(a=>a.windowPos[t]===r+1);i&&(i.windowPos[t]=r)}}shiftLeft(t,n,o,s){for(let r=s+1;r<o+1;r++)if(this.isIndexInRange(r,n)){const i=[...this.rooms].find(a=>a.windowPos[t]===r-1);i&&(i.windowPos[t]=r)}}removeEntry(t,n,o){let s=-1;const r=[...this.rooms].map(i=>i.windowPos[t]);for(const i in r)Number(i)>s&&(s=Number(i));s<0||o>s||this.shiftLeft(t,n,s,o)}addEntry(t,n,o){let s=-1;const r=[...this.rooms].map(i=>i.windowPos[t]);for(const i in r)Number(i)>s&&(s=Number(i));s<0||o>s||this.shiftRight(t,n,s+1,o)}async sync(){if(!this.isLoggedIn)throw Error("Not logged in");if(!this.slidingSyncHostname)throw Error("Hostname must be set first");let t={overview:[[0,10]],spaces:[[0,Number.MAX_SAFE_INTEGER]]},n=1;if(!this.initialSync)for(const c in t){n=10;const v=[...this.rooms].filter(g=>this.roomsInView.includes(g.roomID)).map(g=>g.windowPos[c]).sort();v.push(v[v.length-1]+1);const u=v.reduce((g,h,m,y)=>m===0?(g.push([h,h]),g):h===y[m-1]+1?(g[g.length-1][1]=h,g):(g.push([h,h]),g),[]);t[c]=u}this.lastRanges&&Object.entries(t).toString()!==Object.entries(this.lastRanges).toString()&&(console.log("Ranges changed, resetting sync txn_id"),this.lastRanges=t,this.lastTxnID=Date.now().toString()),this.lastRanges||(this.lastRanges=t,this.lastTxnID=Date.now().toString());let o=`${this.slidingSyncHostname}/_matrix/client/unstable/org.matrix.msc3575/sync?timeout=30000`;this.syncPos&&(o=`${this.slidingSyncHostname}/_matrix/client/unstable/org.matrix.msc3575/sync?timeout=30000&pos=${this.syncPos}`);const s=await fetch(o,{method:"POST",headers:{Authorization:`Bearer ${this.access_token}`},body:JSON.stringify({txn_id:this.lastTxnID,lists:{spaces:{slow_get_all_rooms:!0,sort:["by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.avatar","*"]],timeline_limit:n,filters:{room_types:["m.space"]}},overview:{ranges:this.lastRanges.overview,sort:["by_notification_level","by_recency","by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.avatar","*"]],timeline_limit:n,filters:{}}},bump_event_types:["m.room.message","m.room.encrypted"]})});if(!s.ok){if(s.status===400&&(await s.json()).errcode==="M_UNKNOWN_POS"){this.syncPos=void 0;const c=this.database?.transaction("syncInfo","readwrite");await c?.store.put({userId:this.mxid,syncPos:this.syncPos,initialSync:this.initialSync,lastRanges:this.lastRanges,lastTxnID:this.lastTxnID}),await c?.done}throw console.error(s),Error("Error syncing. See console for error.")}const r=await s.json();this.syncPos=r.pos;const i=this.database?.transaction("syncInfo","readwrite");await i?.store.put({userId:this.mxid,syncPos:this.syncPos,initialSync:this.initialSync,lastRanges:this.lastRanges,lastTxnID:this.lastTxnID}),await i?.done;let a=-1;for(const c in r.lists){const v=r.lists[c];if(v.ops){for(const u of v.ops)if(z(u)){const g=this.database?.transaction("rooms","readwrite");for(let h=u.range[0];h<=u.range[1];h++){const m=u.room_ids[h-u.range[0]];if(!m)break;const y=[...this.rooms].find(l=>l.roomID===m);if(y){y.windowPos[c]=h;continue}const p=new L(m,this.hostname);p.setName(m),p.windowPos[c]=h,this.rooms.add(p),await g?.store.put({windowPos:p.windowPos,roomID:p.roomID,name:p.getName(),notification_count:p.getNotificationCount(),highlight_count:p.getNotificationHighlightCount(),joined_count:p.getJoinedCount(),invited_count:p.getInvitedCount(),avatarUrl:p.getAvatarURL(),isSpace:p.isSpace()})}await g?.done}else if(Y(u)){console.log("Got INSERT OP",u),[...this.rooms].find(l=>l.windowPos[c]===u.index)&&(a<0?this.addEntry(c,this.lastRanges[c],u.index):a>u.index?this.shiftRight(c,this.lastRanges[c],a,u.index):a<u.index&&this.shiftLeft(c,this.lastRanges[c],u.index,a)),a=-1;const h=this.database?.transaction("rooms","readwrite"),m=[...this.rooms].find(l=>l.roomID===u.room_id);if(m)m.windowPos[c]=u.index,await h?.store.put({windowPos:m.windowPos,roomID:m.roomID,name:m.getName(),notification_count:m.getNotificationCount(),highlight_count:m.getNotificationHighlightCount(),joined_count:m.getJoinedCount(),invited_count:m.getInvitedCount(),avatarUrl:m.getAvatarURL(),isSpace:m.isSpace()});else{const l=new L(u.room_id,this.hostname);l.setName(u.room_id),l.windowPos[c]=u.index,this.rooms.add(l),await h?.store.put({windowPos:l.windowPos,roomID:l.roomID,name:l.getName(),notification_count:l.getNotificationCount(),highlight_count:l.getNotificationHighlightCount(),joined_count:l.getJoinedCount(),invited_count:l.getInvitedCount(),avatarUrl:l.getAvatarURL(),isSpace:l.isSpace()})}const y=[...this.rooms].map(l=>l.roomID),p=y.filter((l,w)=>y.indexOf(l)!=w);p.length>0&&console.error("Duplicates found",p),await h?.done}else if(Z(u)){console.log("Got DELETE OP",u);const g=[...this.rooms].find(h=>h.windowPos[c]===u.index);if(g){const h=this.database?.transaction("rooms","readwrite");await h?.store.delete(g.roomID),await h?.done,this.rooms.delete(g)}a!==-1&&this.removeEntry(c,this.lastRanges[c],a),a=u.index}else if(Q(u)){const g=this.database?.transaction("rooms","readwrite");for(let h=u.range[0];h<=u.range[1];h++){const m=[...this.rooms].find(y=>y.windowPos[c]===h);m&&(await g?.store.delete(m.roomID),this.rooms.delete(m))}await g?.done}a!==-1&&this.removeEntry(c,this.lastRanges[c],a)}}const f=this.database?.transaction("rooms","readwrite");for(const c in r.rooms){const v=r.rooms[c],u=v.name,g=v.notification_count,h=v.highlight_count,m=v.joined_count,y=v.invited_count,p=v.timeline,l=v.required_state,w=[...this.rooms].find(X=>X.roomID===c);if(!w){console.error("Could not find roomObj for roomID",c);continue}u&&w.setName(u),w.setNotificationCount(g),w.setNotificationHighlightCount(h),w.setJoinedCount(m),w.setInvitedCount(y),p&&w.addEvents(p),l&&w.addStateEvents(l),await f?.store.put({windowPos:w.windowPos,roomID:w.roomID,name:w.getName(),notification_count:w.getNotificationCount(),highlight_count:w.getNotificationHighlightCount(),joined_count:w.getJoinedCount(),invited_count:w.getInvitedCount(),events:p,stateEvents:l,avatarUrl:w.getAvatarURL(),isSpace:w.isSpace()})}await f?.done,r.rooms&&Object.keys(r.rooms).length>0&&this.emit("rooms",this.rooms)}addInViewRoom(t){this.roomsInView.push(t)}removeInViewRoom(t){this.roomsInView=this.roomsInView.filter(n=>n!==t)}getRooms(){return this.rooms}getSpaces(){return[...this.rooms].filter(t=>t.isSpace()).sort((t,n)=>t.getName()<n.getName()?-1:t.getName()>n.getName()?1:0)}getSpacesWithRooms(){const t=this.getSpaces(),n=new Set;for(const o of t){const s=o.getSpaceChildrenIDs(),r=new Set([...this.getRooms()].filter(i=>s.includes(i.roomID)));n.add({spaceRoom:o,children:r})}for(const o of this.getRooms()){const s=o.getSpaceParentIDs();for(const r of s){const i=[...this.getRooms()].find(f=>f.roomID===r.roomID);if(!i)continue;const a=[...n].find(f=>f.spaceRoom.roomID===i.roomID);if(a){[...a.children].find(f=>f.roomID===o.roomID)||a.children.add(o);continue}n.add({spaceRoom:i,children:new Set([o])})}}return n}async getLoginFlows(){if(!this.hostname)throw Error("Hostname must be set first");const t=await fetch(`${this.hostname}/_matrix/client/v3/login`);if(!t.ok)throw console.error(t),Error("Error requesting login flows. See console for error.");return await t.json()}async getWellKnown(){if(!this.hostname)throw Error("Hostname must be set first");const t=await fetch(`${this.hostname}/.well-known/matrix/client`);if(!t.ok)throw console.error(t),Error("Error requesting login flows. See console for error.");return await t.json()}async passwordLogin(t,n,o=5){if(this.database||await this.createDatabase(),!t)throw Error("Username must be set");if(!n)throw Error("Password must be set");this.mxid=t,await this.setHostname(`https://${t.split(":")[1]}`);try{const a=await this.getWellKnown();if(a["m.homeserver"]?.base_url&&await this.setHostname(a["m.homeserver"].base_url),a["org.matrix.msc3575.proxy"]?.url){const f=this.database?.transaction("loginInfo","readwrite");await f?.store.put({userId:this.mxid,hostname:this.hostname,slidingSyncHostname:a["org.matrix.msc3575.proxy"].url,access_token:this.access_token,device_id:this.device_id}),await f?.done,this.slidingSyncHostname=a["org.matrix.msc3575.proxy"].url}else throw Error("No sliding sync proxy found")}catch(a){console.warn(`No well-known found for ${this.hostname}:
${a}`)}if(((await this.getLoginFlows()).flows.filter(a=>a.type==="m.login.password")?.length||0)==0)throw Error("Password login is not supported by this homeserver");const r=await fetch(`${this.hostname}/_matrix/client/r0/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"m.login.password",identifier:{type:"m.id.user",user:t},user:t,password:n})});if(!r.ok)throw console.error(r),Error("Error logging in. See console for error.");const i=await r.json();if(St(i))throw Error(`Error logging in: ${i.errcode}: ${i.error}`);if(Et(i)&&(console.error(`Rate limited. Retrying in ${i.retry_after_ms}ms. ${o} tries left.`),await this.passwordLogin(t,n,o-1)),xt(i)){const a=this.database?.transaction("loginInfo","readwrite");await a?.store.put({userId:i.user_id,hostname:this.hostname,slidingSyncHostname:this.slidingSyncHostname,access_token:i.access_token,device_id:i.device_id}),await a?.done,this.access_token=i.access_token,this.device_id=i.device_id,this.mxid=i.user_id}}async fetchProfileInfo(t){if(this.profileInfo)return this.profileInfo;if(!this.hostname)throw Error("Hostname must be set first");if(this.database||await this.createDatabase(),!this.access_token)throw Error("Access token must be set first");const n=await fetch(`${this.hostname}/_matrix/client/r0/profile/${t}`,{headers:{Authorization:`Bearer ${this.access_token}`}});if(!n.ok){if(n.status===404||n.status===403)return{};throw console.error(n),Error("Error fetching profile info. See console for error.")}const o=await n.json();o.avatar_url=o.avatar_url?.replace("mxc://",`${this.hostname}/_matrix/media/r0/download/`),this.profileInfo=o;const s=this.database?.transaction("loginInfo","readwrite");return await s?.store.put({userId:this.mxid,device_id:this.device_id,hostname:this.hostname,slidingSyncHostname:this.slidingSyncHostname,access_token:this.access_token,displayName:o.displayname,avatarUrl:o.avatar_url}),await s?.done,o}}function Et(e){return e.retry_after_ms!==void 0}function xt(e){return e.access_token!==void 0}function St(e){return e.errcode!==void 0}const Lt=await bt.Instance(),O=_.createContext(Lt);function Rt(){const e=_.useContext(O),[t,n]=_.useState(e.getRooms());return _.useEffect(()=>{const o=s=>{n(s)};return e.on("rooms",o),e.startSync(),()=>{e.removeListener("rooms",o)}},[]),t}function Pt(){const e=_.useContext(O),[t,n]=_.useState(e.getSpacesWithRooms());return _.useEffect(()=>{const o=s=>{n(e.getSpacesWithRooms())};return e.on("rooms",o),e.startSync(),()=>{e.removeListener("rooms",o)}},[]),t}function Ct(){const e=_.useContext(O),[t,n]=_.useState({displayname:e.mxid||"Unknown"});return _.useEffect(()=>{e.fetchProfileInfo(e.mxid).then(o=>{o.displayname||(o.displayname=e.mxid||"Unknown"),n(o)})},[]),t}export{O as M,Pt as a,Rt as b,Ct as u};
//# sourceMappingURL=client-cf3c3aea.js.map
