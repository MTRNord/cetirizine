import{r as d,j as t,e as ve,o as be,N as J,L as ye,a as G,b as N,c as R,d as A,f as k,g as E,h as I,i as C,U as je,R as _e,H as X,k as Q,l as Ce,m as Se,n as Ie,C as $,T as Z,p as Y,q as ee,Q as te,s as oe,t as B,B as Re,I as Ee,u as Le,S as ke,v as De,w as Te,x as Oe,y as Pe,z as Me,A as Ae,D as $e,E as He,F as Ue,G as ze,J as P,K as Fe,M as Be,O as Ve,P as Ke,V as We,W as qe,X as Je,Y as Ge,Z as V,_ as Xe,$ as Qe,a0 as Ze,a1 as Ye}from"./vendor-4bf46297.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=n(a);fetch(a.href,i)}})();const et=({type:o="button",style:e="primary",onClick:n,children:s,readonly:a})=>e==="secondary"?t.jsx("button",{disabled:a,onClick:n,className:"button bg-orange-400 hover:bg-orange-500 ease-out duration-150 disabled:bg-slate-200 disabled:cursor-not-allowed",type:o,children:s}):e==="abort"?t.jsx("button",{disabled:a,onClick:n,className:"button bg-red-400 hover:bg-red-500 ease-out duration-150 disabled:bg-slate-200 disabled:cursor-not-allowed",type:o,children:s}):t.jsx("button",{disabled:a,onClick:n,className:"button bg-green-400 hover:bg-green-500 ease-out duration-150 disabled:bg-slate-200 disabled:cursor-not-allowed",type:o,children:s}),tt=d.memo(et),ot=({children:o})=>t.jsx("h1",{className:"text-black font-bold text-xl",children:o}),st=({placeholder:o,password:e=!1,autoFocus:n=!1,value:s,readonly:a,onChange:i})=>t.jsx("input",{disabled:a,className:"text-base form-input rounded-lg disabled:bg-slate-200 disabled:cursor-not-allowed transition-colors ease-in-out delay-150",value:s,type:e?"password":"text",autoFocus:n,placeholder:o,onChange:i}),K=d.memo(st);function nt(o){return o.op==="SYNC"}function it(o){return o.op==="INSERT"}function at(o){return o.op==="INVALIDATE"}function rt(o){return o.op==="DELETE"}function ct(o){return o.type==="m.room.create"}function lt(o){return o.type==="m.room.avatar"}function dt(o){return o.type==="m.space.child"}function mt(o){return o.type==="m.space.parent"}class M{constructor(e,n){this.roomID=e,this.hostname=n}events=[];stateEvents=[];name="Unknown Room";notification_count=0;notification_highlight_count=0;joined_count=0;invited_count=0;addEvents(e){this.events.push(...e)}addStateEvents(e){this.stateEvents.push(...e)}getAvatarURL(){let e;return this.stateEvents.forEach(n=>{if(lt(n)){const s=n.content.url;s?.startsWith("mxc://")&&(e=`${this.hostname}/_matrix/media/r0/download/${s.substring(6)}`)}}),e}isSpace(){let e=!1;return this.stateEvents.forEach(n=>{e=ct(n)&&n.content.type==="m.space"}),e}setName(e){this.name=e}getName(){return this.name}setNotificationCount(e){this.notification_count=e}getNotificationCount(){return this.notification_count}setNotificationHighlightCount(e){this.notification_highlight_count=e}getNotificationHighlightCount(){return this.notification_highlight_count}setJoinedCount(e){this.joined_count=e}getJoinedCount(){return this.joined_count}setInvitedCount(e){this.invited_count=e}getInvitedCount(){return this.invited_count}getSpaceChildrenIDs(){const e=[];return this.stateEvents.forEach(n=>{dt(n)&&e.push(n.state_key)}),e}getSpaceParentIDs(){const e=[];return this.stateEvents.forEach(n=>{mt(n)&&e.push({roomID:n.state_key,canonical:n.content.canonical||!1})}),e}isDM(){return!1}isOnline(){return!1}}class ut extends ve{static _instance;access_token;device_id;mxid;hostname;slidingSyncHostname;syncing=!1;roomsInView=[];roomToRoom=new Map;syncPos;initialSync=!0;database;profileInfo;lastRanges;lastTxnID;get isLoggedIn(){return this.access_token!==void 0}static async Instance(){let e=this._instance;if(!e){e=this._instance=new this,e.database||await e.createDatabase();const n=e.database?.transaction("loginInfo","readonly"),s=await n?.store.getAll();if(await n?.done,s&&s.length>0){e.mxid=s[0].userId,e.hostname=s[0].hostname,e.slidingSyncHostname=s[0].slidingSyncHostname,e.access_token=s[0].access_token,e.device_id=s[0].device_id,e.profileInfo={avatar_url:s[0].avatarUrl,displayname:s[0].displayName};const a=e.database?.transaction("syncInfo","readonly"),i=await a?.store.get(e.mxid);await a?.done,i&&(e.syncPos=i.syncPos,e.initialSync=i.initialSync,e.lastRanges=i.lastRanges,e.lastTxnID=i.lastTxnID);const r=e.database?.transaction("rooms","readonly"),h=await r?.store.getAll();if(await r?.done,h){for(const l of h){const g=new M(l.roomID,e.hostname);g.setInvitedCount(l.invited_count),g.setJoinedCount(l.joined_count),g.setNotificationCount(l.notification_count),g.setNotificationHighlightCount(l.highlight_count),g.setName(l.name),l.events&&g.addEvents(l.events),l.stateEvents&&g.addStateEvents(l.stateEvents),e.roomToRoom.set(l.windowID,g)}e.emit("rooms",new Set(e.roomToRoom.values()))}}}return e}async createDatabase(){this.database=await be("matrix",2,{upgrade(e,n){n<1&&(e.createObjectStore("rooms",{keyPath:"windowID"}).createIndex("by-windowID","windowID"),e.createObjectStore("loginInfo",{keyPath:"userId"}),e.createObjectStore("syncInfo",{keyPath:"userId"}))}})}findNextFreeIndex(){const e=Array.from(this.roomToRoom.keys()),n=Math.max(...e),s=0;let a=n+1;console.log("Max:",n),console.log("Min:",s),console.log("Keys:",e);for(let i=s;i<=n;i++)if(!e.includes(i)){console.log("Missing:",i),a=i;break}return a}async setHostname(e){if(!e.startsWith("https://"))throw Error("Hostname must start with 'https://'");this.database||await this.createDatabase();const n=this.database?.transaction("loginInfo","readwrite");await n?.store.put({userId:this.mxid,hostname:e,slidingSyncHostname:this.slidingSyncHostname,access_token:this.access_token,device_id:this.device_id}),await n?.done,this.hostname=e}async startSync(){if(!this.isLoggedIn)throw Error("Not logged in");if(this.database||await this.createDatabase(),!this.syncing)for(this.syncing=!0;this.syncing;)try{await this.sync()}catch(e){console.error(e);return}}stopSync(){this.syncing=!1}async sync(){if(!this.isLoggedIn)throw Error("Not logged in");if(!this.slidingSyncHostname)throw Error("Hostname must be set first");let e={overview:[[0,10]]},n=1;if(!this.initialSync){n=10;const l=[...this.roomToRoom.entries()].filter(([m,u])=>this.roomsInView.includes(u.roomID)).map(([m])=>m).sort();l.push(l[l.length-1]+1),e={overview:l.reduce((m,u,c,f)=>c===0?(m.push([u,u]),m):u===f[c-1]+1?(m[m.length-1][1]=u,m):(m.push([u,u]),m),[])}}this.lastRanges&&Object.entries(e).toString()!==Object.entries(this.lastRanges).toString()&&(console.log("Ranges changed, resetting sync txn_id"),this.lastRanges=e,this.lastTxnID=Date.now().toString()),this.lastRanges||(this.lastRanges=e,this.lastTxnID=Date.now().toString());let s=`${this.slidingSyncHostname}/_matrix/client/unstable/org.matrix.msc3575/sync?timeout=30000`;this.syncPos&&(s=`${this.slidingSyncHostname}/_matrix/client/unstable/org.matrix.msc3575/sync?timeout=30000&pos=${this.syncPos}`);const a=await fetch(s,{method:"POST",headers:{Authorization:`Bearer ${this.access_token}`},body:JSON.stringify({txn_id:this.lastTxnID,lists:{spaces:{slow_get_all_rooms:!0,sort:["by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.avatar","*"]],timeline_limit:n,filters:{room_types:["m.space"]}},overview:{ranges:this.lastRanges.overview,sort:["by_notification_level","by_recency","by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.avatar","*"]],timeline_limit:n,filters:{}}},bump_event_types:["m.room.message","m.room.encrypted"]})});if(!a.ok){if(a.status===400&&(await a.json()).errcode==="M_UNKNOWN_POS"){this.syncPos=void 0;const l=this.database?.transaction("syncInfo","readwrite");await l?.store.put({userId:this.mxid,syncPos:this.syncPos,initialSync:this.initialSync,lastRanges:this.lastRanges,lastTxnID:this.lastTxnID}),await l?.done}throw console.error(a),Error("Error syncing. See console for error.")}const i=await a.json();this.syncPos=i.pos;const r=this.database?.transaction("syncInfo","readwrite");await r?.store.put({userId:this.mxid,syncPos:this.syncPos,initialSync:this.initialSync,lastRanges:this.lastRanges,lastTxnID:this.lastTxnID}),await r?.done;for(const l in i.lists){const g=i.lists[l];if(g.ops){for(const m of g.ops)if(nt(m)){const u=this.database?.transaction("rooms","readwrite");for(let c=m.range[0];c<=m.range[1];c++){await u?.store.delete(c),this.roomToRoom.delete(c);const f=new M(m.room_ids[c],this.hostname);f.setName("Unknown Room"),this.roomToRoom.set(c,f),await u?.store.put({windowID:c,roomID:f.roomID,name:f.getName(),notification_count:f.getNotificationCount(),highlight_count:f.getNotificationHighlightCount(),joined_count:f.getJoinedCount(),invited_count:f.getInvitedCount(),avatarUrl:f.getAvatarURL(),isSpace:f.isSpace()})}await u?.done}else if(it(m)){console.log("Got INSERT OP",m),console.log("List",this.roomToRoom);const u=m.index,c=this.findNextFreeIndex();if(console.log("Empty spot",c),console.log("Position",u),c!==u){const y=Math.max(...this.roomToRoom.keys()),b=Math.min(...this.roomToRoom.keys()),p=this.database?.transaction("rooms","readwrite");if(c>u&&c<=y){console.log("Shifting right");for(let x=0;x<c&&x>=b&&x<=y;x++){console.log(x);const w=this.roomToRoom.get(x);w!==void 0&&(await p?.store.put({windowID:x+1,roomID:w.roomID,name:w.getName(),notification_count:w.getNotificationCount(),highlight_count:w.getNotificationHighlightCount(),joined_count:w.getJoinedCount(),invited_count:w.getInvitedCount(),avatarUrl:w.getAvatarURL(),isSpace:w.isSpace()}),this.roomToRoom.delete(x),this.roomToRoom.set(x+1,w))}console.log("List",this.roomToRoom)}else if(c<u&&c<=y){console.log("Shifting left");for(let x=0;x>c&&x>=b&&x<=y;x--){const w=this.roomToRoom.get(x);w!==void 0&&(await p?.store.put({windowID:x-1,roomID:w.roomID,name:w.getName(),notification_count:w.getNotificationCount(),highlight_count:w.getNotificationHighlightCount(),joined_count:w.getJoinedCount(),invited_count:w.getInvitedCount(),avatarUrl:w.getAvatarURL(),isSpace:w.isSpace()}),this.roomToRoom.delete(x),this.roomToRoom.set(x-1,w))}console.log("List",this.roomToRoom)}console.log("Shifting done"),console.log("Empty spot",this.findNextFreeIndex()),console.log("Position",u),console.log("List",this.roomToRoom),await p?.done}this.roomToRoom.get(u)!==void 0&&console.error("Shifting failed");const f=new M(m.room_id,this.hostname);console.log(f),f.setName("Unknown Room"),this.roomToRoom.set(u,f);const j=this.database?.transaction("rooms","readwrite");await j?.store.put({windowID:u,roomID:m.room_id,name:f.getName(),notification_count:f.getNotificationCount(),highlight_count:f.getNotificationHighlightCount(),joined_count:f.getJoinedCount(),invited_count:f.getInvitedCount(),avatarUrl:f.getAvatarURL(),isSpace:f.isSpace()}),await j?.done}else if(rt(m)){console.log("Got DELETE OP",m);const u=this.database?.transaction("rooms","readwrite");await u?.store.delete(m.index),await u?.done,this.roomToRoom.delete(m.index)}else if(at(m)){const u=this.database?.transaction("rooms","readwrite");for(let c=m.range[0];c<=m.range[1];c++)await u?.store.delete(c),this.roomToRoom.delete(c);await u?.done}}}const h=this.database?.transaction("rooms","readwrite");for(const l in i.rooms){const g=i.rooms[l],m=g.name,u=g.notification_count,c=g.highlight_count,f=g.joined_count,j=g.invited_count,y=g.timeline,b=g.required_state,p=[...this.roomToRoom.values()].find(x=>x.roomID===l);if(!p){console.error("Could not find roomObj for roomID",l);continue}m&&p.setName(m),p.setNotificationCount(u),p.setNotificationHighlightCount(c),p.setJoinedCount(f),p.setInvitedCount(j),y&&p.addEvents(y),b&&p.addStateEvents(b),await h?.store.put({windowID:[...this.roomToRoom.keys()].find(x=>this.roomToRoom.get(x)===p),roomID:p.roomID,name:p.getName(),notification_count:p.getNotificationCount(),highlight_count:p.getNotificationHighlightCount(),joined_count:p.getJoinedCount(),invited_count:p.getInvitedCount(),events:y,stateEvents:b,avatarUrl:p.getAvatarURL(),isSpace:p.isSpace()})}await h?.done,i.rooms&&Object.keys(i.rooms).length>0&&this.emit("rooms",new Set(this.roomToRoom.values()))}addInViewRoom(e){this.roomsInView.push(e)}removeInViewRoom(e){this.roomsInView=this.roomsInView.filter(n=>n!==e)}getRooms(){return new Set(this.roomToRoom.values())}getSpaces(){return[...this.roomToRoom.values()].filter(e=>e.isSpace())}getSpacesWithRooms(){const e=this.getSpaces(),n=new Set;for(const s of e){const a=s.getSpaceChildrenIDs(),i=new Set([...this.getRooms()].filter(r=>a.includes(r.roomID)));n.add({spaceRoom:s,children:i})}for(const s of this.getRooms()){const a=s.getSpaceParentIDs();for(const i of a){const r=[...this.getRooms()].find(l=>l.roomID===i.roomID);if(!r)continue;const h=[...n].find(l=>l.spaceRoom.roomID===r.roomID);if(h){[...h.children].find(l=>l.roomID===s.roomID)||h.children.add(s);continue}n.add({spaceRoom:r,children:new Set([s])})}}return n}async getLoginFlows(){if(!this.hostname)throw Error("Hostname must be set first");const e=await fetch(`${this.hostname}/_matrix/client/v3/login`);if(!e.ok)throw console.error(e),Error("Error requesting login flows. See console for error.");return await e.json()}async getWellKnown(){if(!this.hostname)throw Error("Hostname must be set first");const e=await fetch(`${this.hostname}/.well-known/matrix/client`);if(!e.ok)throw console.error(e),Error("Error requesting login flows. See console for error.");return await e.json()}async passwordLogin(e,n,s=5){if(this.database||await this.createDatabase(),!e)throw Error("Username must be set");if(!n)throw Error("Password must be set");this.mxid=e,await this.setHostname(`https://${e.split(":")[1]}`);try{const h=await this.getWellKnown();if(h["m.homeserver"]?.base_url&&await this.setHostname(h["m.homeserver"].base_url),h["org.matrix.msc3575.proxy"]?.url){const l=this.database?.transaction("loginInfo","readwrite");await l?.store.put({userId:this.mxid,hostname:this.hostname,slidingSyncHostname:h["org.matrix.msc3575.proxy"].url,access_token:this.access_token,device_id:this.device_id}),await l?.done,this.slidingSyncHostname=h["org.matrix.msc3575.proxy"].url}else throw Error("No sliding sync proxy found")}catch(h){console.warn(`No well-known found for ${this.hostname}:
${h}`)}if(((await this.getLoginFlows()).flows.filter(h=>h.type==="m.login.password")?.length||0)==0)throw Error("Password login is not supported by this homeserver");const i=await fetch(`${this.hostname}/_matrix/client/r0/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"m.login.password",identifier:{type:"m.id.user",user:e},user:e,password:n})});if(!i.ok)throw console.error(i),Error("Error logging in. See console for error.");const r=await i.json();if(ft(r))throw Error(`Error logging in: ${r.errcode}: ${r.error}`);if(ht(r)&&(console.error(`Rate limited. Retrying in ${r.retry_after_ms}ms. ${s} tries left.`),await this.passwordLogin(e,n,s-1)),gt(r)){const h=this.database?.transaction("loginInfo","readwrite");await h?.store.put({userId:r.user_id,hostname:this.hostname,slidingSyncHostname:this.slidingSyncHostname,access_token:r.access_token,device_id:r.device_id}),await h?.done,this.access_token=r.access_token,this.device_id=r.device_id,this.mxid=r.user_id}}async fetchProfileInfo(e){if(this.profileInfo)return this.profileInfo;if(!this.hostname)throw Error("Hostname must be set first");if(this.database||await this.createDatabase(),!this.access_token)throw Error("Access token must be set first");const n=await fetch(`${this.hostname}/_matrix/client/r0/profile/${e}`,{headers:{Authorization:`Bearer ${this.access_token}`}});if(!n.ok){if(n.status===404||n.status===403)return{};throw console.error(n),Error("Error fetching profile info. See console for error.")}const s=await n.json();s.avatar_url=s.avatar_url?.replace("mxc://",`${this.hostname}/_matrix/media/r0/download/`),this.profileInfo=s;const a=this.database?.transaction("loginInfo","readwrite");return await a?.store.put({userId:this.mxid,device_id:this.device_id,hostname:this.hostname,slidingSyncHostname:this.slidingSyncHostname,access_token:this.access_token,displayName:s.displayname,avatarUrl:s.avatar_url}),await a?.done,s}}function ht(o){return o.retry_after_ms!==void 0}function gt(o){return o.access_token!==void 0}function ft(o){return o.errcode!==void 0}const se=await ut.Instance(),L=d.createContext(se);function xt(){const o=d.useContext(L),[e,n]=d.useState(o.getRooms());return d.useEffect(()=>{const s=a=>{n(a)};return o.on("rooms",s),o.startSync(),()=>{o.removeListener("rooms",s)}},[]),e}function pt(){const o=d.useContext(L),[e,n]=d.useState(o.getSpacesWithRooms());return d.useEffect(()=>{const s=a=>{n(o.getSpacesWithRooms())};return o.on("rooms",s),o.startSync(),()=>{o.removeListener("rooms",s)}},[]),e}function wt(){const o=d.useContext(L),[e,n]=d.useState({displayname:o.mxid||"Unknown"});return d.useEffect(()=>{o.fetchProfileInfo(o.mxid).then(s=>{s.displayname||(s.displayname=o.mxid||"Unknown"),n(s)})},[]),e}function Nt(){const o=d.useContext(L),[e,n]=d.useState(!1),[s,a]=d.useState(""),[i,r]=d.useState(""),[h,l]=d.useState("");if(o.isLoggedIn)return t.jsx(J,{to:"/"});const g=async()=>{try{n(!0),await o.passwordLogin(i,h)}catch(m){a(m.toString())}n(!1)};return t.jsxs("form",{className:"flex flex-col rounded-md shadow p-4 bg-white gap-2 min-w-[30rem]",onSubmit:m=>{m.preventDefault(),g()},children:[t.jsx(ot,{children:"Login"}),s?t.jsx("h2",{className:"text-red-500 font-normal text-sm",children:s}):t.jsx("div",{className:"min-h-[1.25rem]"}),t.jsx(K,{readonly:e,value:i,placeholder:"Username",onChange:m=>r(m.target.value)}),t.jsx(K,{readonly:e,value:h,password:!0,placeholder:"Password",onChange:m=>l(m.target.value)}),t.jsx(tt,{readonly:e,style:"primary",type:"submit",children:"Login"})]})}function vt(){return t.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen bg-img",children:t.jsx(Nt,{})})}const H=({avatarUrl:o,displayname:e,dm:n=!1,online:s=!1})=>o?t.jsxs("div",{className:"flex relative min-w-[2rem] min-h-[2rem] justify-center items-center m-0 mr-3 text-xl rounded-full text-white",children:[t.jsx("img",{className:"rounded-full w-8 h-8",alt:e,src:o}),n?s?t.jsx("div",{className:"bg-green-500 rounded-full w-3 h-3 absolute bottom-0 right-0"}):t.jsx("div",{className:"bg-red-500 rounded-full w-3 h-3 absolute bottom-0 right-0"}):t.jsx(t.Fragment,{})]}):t.jsxs("div",{className:"flex relative min-w-[2rem] min-h-[2rem] bg-orange-500 justify-center items-center m-0 mr-3 text-xl rounded-full text-white",children:[e[0].toUpperCase(),n?s?t.jsx("div",{className:"bg-green-500 rounded-full w-3 h-3 absolute bottom-0 right-0"}):t.jsx("div",{className:"bg-red-500 rounded-full w-3 h-3 absolute bottom-0 right-0"}):t.jsx(t.Fragment,{})]}),bt=/((https?:\/\/(www\.)?)|(www\.))[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_+.~#?&//=]*)/,yt=/(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))/,jt=[o=>{const e=bt.exec(o);return e&&{index:e.index,length:e[0].length,text:e[0],url:e[0]}},o=>{const e=yt.exec(o);return e&&{index:e.index,length:e[0].length,text:e[0],url:`mailto:${e[0]}`}}];function _t(){return t.jsx(ye.AutoLinkPlugin,{matchers:jt})}const T=1,Ct=new Set(["paragraph","quote","code","h1","h2","ul","ol"]),St={code:"Code Block",h1:"Large Heading",h2:"Small Heading",h3:"Heading",h4:"Heading",h5:"Heading",ol:"Numbered List",paragraph:"Normal",quote:"Quote",ul:"Bulleted List"};function W(){return t.jsx("div",{className:"divider"})}function q(o,e){e?(o.style.opacity="1",o.style.top=`${e.top+e.height+window.pageYOffset+10}px`,o.style.left=`${e.left+window.pageXOffset-o.offsetWidth/2+e.width/2}px`):(o.style.opacity="0",o.style.top="-1000px",o.style.left="-1000px")}function It({editor:o}){const e=d.useRef(null),n=d.useRef(null),s=d.useRef(!1),[a,i]=d.useState(""),[r,h]=d.useState(!1),[l,g]=d.useState(null),m=d.useCallback(()=>{const c=N.$getSelection();if(N.$isRangeSelection(c)){const p=ne(c),x=p.getParent();C.$isLinkNode(x)?i(x.getURL()):C.$isLinkNode(p)?i(p.getURL()):i("")}const f=e.current,j=window.getSelection(),y=document.activeElement;if(f===null)return;const b=o.getRootElement();if(c!==null&&!j?.isCollapsed&&b!==null&&b.contains(j?.anchorNode)){const p=j?.getRangeAt(0);let x;if(j?.anchorNode===b){let w=b;for(;w.firstElementChild!=null;)w=w.firstElementChild;x=w.getBoundingClientRect()}else x=p?.getBoundingClientRect();s.current||q(f,x),g(c)}else(!y||y.className!=="link-input")&&(q(f,void 0),g(null),h(!1),i(""));return!0},[o]);d.useEffect(()=>A.mergeRegister(o.registerUpdateListener(({editorState:c})=>{c.read(()=>{m()})}),o.registerCommand(N.SELECTION_CHANGE_COMMAND,()=>(m(),!0),T)),[o,m]),d.useEffect(()=>{o.getEditorState().read(()=>{m()})},[o,m]),d.useEffect(()=>{r&&n.current&&n.current.focus()},[r]);const u=d.createElement("a",{href:a,target:"_blank",rel:"noopener noreferrer"},a);return t.jsx("div",{ref:e,className:"link-editor",children:r?t.jsx("input",{ref:n,className:"link-input",value:a,onChange:c=>{i(c.target.value)},onKeyDown:c=>{c.key==="Enter"?(c.preventDefault(),l!==null&&(a!==""&&o.dispatchCommand(C.TOGGLE_LINK_COMMAND,a),h(!1))):c.key==="Escape"&&(c.preventDefault(),h(!1))}}):t.jsx(t.Fragment,{children:t.jsxs("div",{className:"link-input",children:[u,t.jsx("div",{className:"link-edit",role:"button",tabIndex:0,onMouseDown:c=>c.preventDefault(),onClick:()=>{h(!0)}})]})})})}function Rt({onChange:o,className:e,options:n,value:s}){return t.jsxs("select",{className:e,onChange:o,value:s,children:[t.jsx("option",{hidden:!0,value:""}),n.map(a=>t.jsx("option",{value:a,children:a},a))]})}function ne(o){const e=o.anchor,n=o.focus,s=o.anchor.getNode(),a=o.focus.getNode();return s===a?s:o.isBackward()?I.$isAtNodeEnd(n)?s:a:I.$isAtNodeEnd(e)?a:s}function Et({editor:o,blockType:e,toolbarRef:n,setShowBlockOptionsDropDown:s}){const a=d.useRef(null);d.useEffect(()=>{const c=a.current,f=n.current;if(c!==null&&f!==null){const j=y=>{const b=y.target;!c.contains(b)&&!f.contains(b)&&s(!1)};return document.addEventListener("click",j),()=>{document.removeEventListener("click",j)}}},[a,s,n]);const i=()=>{e!=="paragraph"&&o.update(()=>{const c=N.$getSelection();N.$isRangeSelection(c)&&I.$wrapNodes(c,()=>N.$createParagraphNode())}),s(!1)},r=()=>{e!=="h1"&&o.update(()=>{const c=N.$getSelection();N.$isRangeSelection(c)&&I.$wrapNodes(c,()=>k.$createHeadingNode("h1"))}),s(!1)},h=()=>{e!=="h2"&&o.update(()=>{const c=N.$getSelection();N.$isRangeSelection(c)&&I.$wrapNodes(c,()=>k.$createHeadingNode("h2"))}),s(!1)},l=()=>{e!=="ul"?o.dispatchCommand(R.INSERT_UNORDERED_LIST_COMMAND,void 0):o.dispatchCommand(R.REMOVE_LIST_COMMAND,void 0),s(!1)},g=()=>{e!=="ol"?o.dispatchCommand(R.INSERT_ORDERED_LIST_COMMAND,void 0):o.dispatchCommand(R.REMOVE_LIST_COMMAND,void 0),s(!1)},m=()=>{e!=="quote"&&o.update(()=>{const c=N.$getSelection();N.$isRangeSelection(c)&&I.$wrapNodes(c,()=>k.$createQuoteNode())}),s(!1)},u=()=>{e!=="code"&&o.update(()=>{const c=N.$getSelection();N.$isRangeSelection(c)&&I.$wrapNodes(c,()=>E.$createCodeNode())}),s(!1)};return t.jsxs("div",{className:"dropdown",ref:a,children:[t.jsxs("button",{className:"item",onClick:i,children:[t.jsx(Z,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Normal"}),e==="paragraph"&&t.jsx("span",{className:"active"})]}),t.jsxs("button",{className:"item",onClick:r,children:[t.jsx(X,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Large Heading"}),e==="h1"&&t.jsx("span",{className:"active"})]}),t.jsxs("button",{className:"item",onClick:h,children:[t.jsx(Q,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Small Heading"}),e==="h2"&&t.jsx("span",{className:"active"})]}),t.jsxs("button",{className:"item",onClick:l,children:[t.jsx(ee,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Bullet List"}),e==="ul"&&t.jsx("span",{className:"active"})]}),t.jsxs("button",{className:"item",onClick:g,children:[t.jsx(Y,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Numbered List"}),e==="ol"&&t.jsx("span",{className:"active"})]}),t.jsxs("button",{className:"item",onClick:m,children:[t.jsx(te,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Quote"}),e==="quote"&&t.jsx("span",{className:"active"})]}),t.jsxs("button",{className:"item",onClick:u,children:[t.jsx($,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Code Block"}),e==="code"&&t.jsx("span",{className:"active"})]})]})}function Lt(){const[o]=G.useLexicalComposerContext(),e=d.useRef(null),[n,s]=d.useState(!1),[a,i]=d.useState(!1),[r,h]=d.useState("paragraph"),[l,g]=d.useState(null),[m,u]=d.useState(!1),[c,f]=d.useState(""),[j,y]=d.useState(!1),[b,p]=d.useState(!1),[x,w]=d.useState(!1),[ie,ae]=d.useState(!1),[re,ce]=d.useState(!1),[le,de]=d.useState(!1),[me,ue]=d.useState(!1),O=d.useCallback(()=>{const v=N.$getSelection();if(N.$isRangeSelection(v)){const _=v.anchor.getNode(),S=_.getKey()==="root"?_:_.getTopLevelElementOrThrow(),z=S.getKey();if(o.getElementByKey(z)!==null)if(g(z),R.$isListNode(S)){const D=A.$getNearestNodeOfType(_,R.ListNode),Ne=D?D.getTag():S.getTag();h(Ne)}else{const D=k.$isHeadingNode(S)?S.getTag():S.getType();h(D),E.$isCodeNode(S)&&f(S.getLanguage()||E.getDefaultCodeLanguage())}w(v.hasFormat("bold")),ae(v.hasFormat("italic")),ce(v.hasFormat("underline")),de(v.hasFormat("strikethrough")),ue(v.hasFormat("code")),y(I.$isParentElementRTL(v));const F=ne(v),we=F.getParent();C.$isLinkNode(we)||C.$isLinkNode(F)?p(!0):p(!1)}},[o]);d.useEffect(()=>A.mergeRegister(o.registerUpdateListener(({editorState:v})=>{v.read(()=>{O()})}),o.registerCommand(N.SELECTION_CHANGE_COMMAND,(v,_)=>(O(),!1),T),o.registerCommand(N.CAN_UNDO_COMMAND,v=>(s(v),!1),T),o.registerCommand(N.CAN_REDO_COMMAND,v=>(i(v),!1),T)),[o,O]);const he=d.useMemo(()=>E.getCodeLanguages(),[]),ge=d.useCallback(v=>{o.update(()=>{if(l!==null){const _=N.$getNodeByKey(l);E.$isCodeNode(_)&&_.setLanguage(v.target.value)}})},[o,l]),fe=d.useCallback(()=>{b?o.dispatchCommand(C.TOGGLE_LINK_COMMAND,null):o.dispatchCommand(C.TOGGLE_LINK_COMMAND,"https://")},[o,b]),[xe,pe]=d.useState(null);return d.useEffect(()=>{const v=document.getElementsByClassName("editor-container")[0],_=document.createElement("div");return v.prepend(_),pe(_),()=>{v.removeChild(_)}},[]),t.jsxs("div",{className:"toolbar",ref:e,children:[t.jsx("button",{disabled:!n,onClick:()=>{o.dispatchCommand(N.UNDO_COMMAND,void 0)},className:"toolbar-item spaced","aria-label":"Undo",children:t.jsx(je,{className:"format",size:20})}),t.jsx("button",{disabled:!a,onClick:()=>{o.dispatchCommand(N.REDO_COMMAND,void 0)},className:"toolbar-item","aria-label":"Redo",children:t.jsx(_e,{className:"format",size:20})}),t.jsx(W,{}),Ct.has(r)&&t.jsxs(t.Fragment,{children:[t.jsxs("button",{className:"toolbar-item block-controls",onClick:()=>u(!m),"aria-label":"Formatting Options",children:[r==="h1"?t.jsx(X,{className:"icon",size:20}):r==="h2"?t.jsx(Q,{className:"icon",size:20}):r==="h3"?t.jsx(Ce,{className:"icon",size:20}):r==="h4"?t.jsx(Se,{className:"icon",size:20}):r==="h5"?t.jsx(Ie,{className:"icon",size:20}):r==="code"?t.jsx($,{className:"icon",size:20}):r==="paragraph"?t.jsx(Z,{className:"icon",size:20}):r==="ol"?t.jsx(Y,{className:"icon",size:20}):r==="ul"?t.jsx(ee,{className:"icon",size:20}):r==="quote"?t.jsx(te,{className:"icon",size:20}):t.jsx(t.Fragment,{}),t.jsx("span",{className:"text",children:St[r]}),t.jsx(oe,{size:20})]}),m&&B.createPortal(t.jsx(Et,{editor:o,blockType:r,toolbarRef:e,setShowBlockOptionsDropDown:u}),xe),t.jsx(W,{})]}),r==="code"?t.jsxs(t.Fragment,{children:[t.jsx(Rt,{className:"toolbar-item code-language",onChange:ge,options:he,value:c}),t.jsx("i",{className:"chevron-down inside"})]}):t.jsxs(t.Fragment,{children:[t.jsx("button",{onClick:()=>{o.dispatchCommand(N.FORMAT_TEXT_COMMAND,"bold")},className:"toolbar-item spaced "+(x?"active":""),"aria-label":"Format Bold",children:t.jsx(Re,{className:"format",size:20})}),t.jsx("button",{onClick:()=>{o.dispatchCommand(N.FORMAT_TEXT_COMMAND,"italic")},className:"toolbar-item spaced "+(ie?"active":""),"aria-label":"Format Italics",children:t.jsx(Ee,{className:"format",size:20})}),t.jsx("button",{onClick:()=>{o.dispatchCommand(N.FORMAT_TEXT_COMMAND,"underline")},className:"toolbar-item spaced "+(re?"active":""),"aria-label":"Format Underline",children:t.jsx(Le,{className:"format",size:20})}),t.jsx("button",{onClick:()=>{o.dispatchCommand(N.FORMAT_TEXT_COMMAND,"strikethrough")},className:"toolbar-item spaced "+(le?"active":""),"aria-label":"Format Strikethrough",children:t.jsx(ke,{className:"format",size:20})}),t.jsx("button",{onClick:()=>{o.dispatchCommand(N.FORMAT_TEXT_COMMAND,"code")},className:"toolbar-item spaced "+(me?"active":""),"aria-label":"Insert Code",children:t.jsx($,{className:"format",size:20})}),t.jsx("button",{onClick:fe,className:"toolbar-item spaced "+(b?"active":""),"aria-label":"Insert Link",children:t.jsx(De,{className:"format",size:20})}),b&&B.createPortal(t.jsx(It,{editor:o}),document.body)," "]})]})}function kt(){const[o]=G.useLexicalComposerContext();return d.useEffect(()=>E.registerCodeHighlighting(o),[o]),null}const Dt={ltr:"ltr",rtl:"rtl",placeholder:"editor-placeholder",paragraph:"editor-paragraph",quote:"editor-quote",heading:{h1:"editor-heading-h1",h2:"editor-heading-h2",h3:"editor-heading-h3",h4:"editor-heading-h4",h5:"editor-heading-h5"},list:{nested:{listitem:"editor-nested-listitem"},ol:"editor-list-ol",ul:"editor-list-ul",listitem:"editor-listitem"},image:"editor-image",link:"editor-link",text:{bold:"editor-text-bold",italic:"editor-text-italic",overflowed:"editor-text-overflowed",hashtag:"editor-text-hashtag",underline:"editor-text-underline",strikethrough:"editor-text-strikethrough",underlineStrikethrough:"editor-text-underlineStrikethrough",code:"editor-text-code"},code:"editor-code",codeHighlight:{atrule:"editor-tokenAttr",attr:"editor-tokenAttr",boolean:"editor-tokenProperty",builtin:"editor-tokenSelector",cdata:"editor-tokenComment",char:"editor-tokenSelector",class:"editor-tokenFunction","class-name":"editor-tokenFunction",comment:"editor-tokenComment",constant:"editor-tokenProperty",deleted:"editor-tokenProperty",doctype:"editor-tokenComment",entity:"editor-tokenOperator",function:"editor-tokenFunction",important:"editor-tokenVariable",inserted:"editor-tokenSelector",keyword:"editor-tokenAttr",namespace:"editor-tokenVariable",number:"editor-tokenProperty",operator:"editor-tokenOperator",prolog:"editor-tokenComment",property:"editor-tokenProperty",punctuation:"editor-tokenPunctuation",regex:"editor-tokenVariable",selector:"editor-tokenSelector",string:"editor-tokenSelector",symbol:"editor-tokenProperty",tag:"editor-tokenProperty",url:"editor-tokenOperator",variable:"editor-tokenVariable"}};function Tt(){return t.jsx("div",{className:"editor-placeholder",id:"editor-placeholder",children:"Enter message..."})}const Ot=({namespace:o,onChange:e,onError:n})=>{const s={namespace:o,theme:Dt,onError:n,nodes:[k.HeadingNode,R.ListNode,R.ListItemNode,k.QuoteNode,E.CodeNode,E.CodeHighlightNode,P.TableNode,P.TableCellNode,P.TableRowNode,C.AutoLinkNode,C.LinkNode]};return t.jsx(Te.LexicalComposer,{initialConfig:s,children:t.jsxs("div",{className:"editor-container",children:[t.jsx(Lt,{}),t.jsxs("div",{className:"editor-inner",children:[t.jsx(Oe.RichTextPlugin,{contentEditable:t.jsx(Pe.ContentEditable,{className:"editor-input","aria-labelledby":"editor-placeholder"}),placeholder:t.jsx(Tt,{}),ErrorBoundary:Me}),t.jsx(Ae.OnChangePlugin,{onChange:e}),t.jsx($e.HistoryPlugin,{}),t.jsx(He.LinkPlugin,{}),t.jsx(kt,{}),t.jsx(_t,{}),t.jsx(Ue.MarkdownShortcutPlugin,{transformers:ze.TRANSFORMERS})]})]})})},Pt=({roomId:o,avatarUrl:e,displayname:n,dm:s=!1,online:a=!1,active:i=!1,onClick:r,hidden:h})=>{const{ref:l,inView:g}=Fe({triggerOnce:!0,rootMargin:"200px 0px",skip:h}),m=d.useContext(L);return d.useEffect(()=>{g?m.addInViewRoom(o):m.removeInViewRoom(o)},[g]),t.jsx("div",{ref:l,onClick:r,className:"w-full cursor-pointer",children:g&&(i?t.jsxs("div",{className:"flex flex-row gap-2 p-1 bg-gray-300 hover:bg-gray-400 rounded-lg duration-200 ease-in-out items-center",children:[t.jsx(H,{avatarUrl:e,displayname:n,dm:s,online:a}),t.jsx("span",{title:n,className:"text-slate-900 font-normal text-base capitalize max-w-[32ch] overflow-hidden text-ellipsis w-full whitespace-nowrap",children:n})]}):t.jsxs("div",{className:"flex flex-row gap-2 p-1 hover:bg-gray-300 rounded-lg duration-200 ease-in-out items-center",children:[t.jsx(H,{avatarUrl:e,displayname:n,dm:s,online:a}),t.jsx("span",{title:n,className:"text-slate-900 font-normal text-base capitalize max-w-[32ch] overflow-hidden text-ellipsis w-full whitespace-nowrap",children:n})]}))})};const Mt=({sectionID:o,rooms:e,onClick:n,activeRoom:s,hidden:a})=>{const i=e.map(r=>t.jsx(Pt,{roomId:r.roomID,hidden:a,avatarUrl:r.avatarUrl,displayname:r.displayname,dm:r.dm,online:r.online,active:r.roomID===s,onClick:()=>{n(r.roomID)}},r.roomID+o));return t.jsx(t.Fragment,{children:i})},U=({section:o,onRoomClick:e,activeRoom:n})=>{const[s,a]=d.useState(!1);return t.jsxs("div",{className:"flex flex-col gap-1",children:[t.jsxs("div",{className:"flex flex-row gap-2 py-1  items-center justify-start cursor-pointer h-8 text-slate-600",onClick:()=>a(i=>!i),children:[s?t.jsx(Be,{size:14}):t.jsx(oe,{size:14}),t.jsx("span",{className:"font-normal text-sm capitalize max-w-[32ch] overflow-hidden text-ellipsis w-full whitespace-nowrap",children:o.sectionName})]}),!s&&t.jsx(Mt,{hidden:s,sectionID:o.roomID,rooms:o.rooms,onClick:e,activeRoom:n}),!s&&o.subsections.map(i=>t.jsx(U,{section:i,onRoomClick:e,activeRoom:n},i.roomID))]},o.roomID)},At=({sections:o,rooms:e})=>{const[n,s]=d.useState(void 0);return t.jsxs("div",{className:"flex flex-col gap-1 flex-1 p-2 min-w-[33ch] h-full overflow-y-auto overflow-x-hidden scrollbarSmall",children:[o.map(a=>t.jsx(U,{section:a,onRoomClick:i=>{s(i)},activeRoom:n},a.roomID)),t.jsx(U,{section:{sectionName:"Others",roomID:"other",subsections:[],rooms:e},onRoomClick:a=>{s(a)},activeRoom:n})]})};function $t(){const o=wt(),e=pt(),n=xt(),s=[...e].map(i=>{const r=[...i.children].filter(l=>!l.isSpace()).map(l=>({roomID:l.roomID,displayname:l.getName(),avatarUrl:l.getAvatarURL(),dm:l.isDM(),online:l.isOnline()})),h=l=>{const g=[...e].find(m=>m.spaceRoom.roomID===l.roomID);if(g){const m=[...g?.children].map(u=>({roomID:u.roomID,displayname:u.getName(),avatarUrl:u.getAvatarURL(),dm:u.isDM(),online:u.isOnline()}));return{sectionName:l.getName(),rooms:m,roomID:l.roomID,subsections:[...g?.children].filter(u=>u.isSpace()).map(h).filter(u=>u!==void 0)}}};return{sectionName:i.spaceRoom.getName(),rooms:r,roomID:i.spaceRoom.roomID,subsections:[...i.children].filter(l=>l.isSpace()).map(h)}}),a=[...n].filter(i=>!i.isSpace()).map(i=>({roomID:i.roomID,displayname:i.getName(),avatarUrl:i.getAvatarURL(),dm:i.isDM(),online:i.isOnline()}));return t.jsxs("div",{className:"flex flex-row w-full gap-2 min-h-screen h-screen",children:[t.jsxs("div",{className:"flex flex-col bg-gradient-to-br from-slate-100 via-gray-200 to-orange-200 border-r-[1px] border-slate-300",children:[t.jsxs("div",{className:"flex flex-row gap-2 m-2 p-1  items-center border-b-2",children:[o?.avatar_url&&t.jsx(H,{displayname:"Test",avatarUrl:o?.avatar_url,dm:!1,online:!1}),t.jsxs("div",{className:"flex flex-row justify-between items-center w-full",children:[t.jsx("span",{className:"text-base font-semibold",children:o?.displayname}),t.jsx(Ve,{size:28,stroke:"unset",className:"stroke-slate-600 rounded-full hover:bg-slate-300 p-1 cursor-pointer"})]})]}),t.jsx(At,{sections:s,rooms:a})]}),t.jsxs("div",{className:"flex-1 flex flex-col",children:[t.jsx("div",{className:"flex-1"}),t.jsx(Ot,{namespace:"Editor",onChange:()=>{},onError:i=>console.error(i)})]})]})}const Ht=({children:o})=>d.useContext(L).isLoggedIn?o:t.jsx(J,{to:"login"});Ke.init({locateFile:()=>We}).then(()=>{console.log("Using WebAssembly Olm")}).catch(o=>(console.log("Failed to load Olm: trying legacy version",o),new Promise((e,n)=>{const s=document.createElement("script");s.src=qe,s.onload=e,s.onerror=n,document.body.appendChild(s)}).then(()=>window.Olm.init()).then(()=>{console.log("Using legacy Olm")}).catch(e=>{console.log("Both WebAssembly and asm.js Olm failed!",e)})));function Ut(){return t.jsx(Je,{basename:"/cetirizine/",children:t.jsxs(Ge,{children:[t.jsx(V,{path:"/",element:t.jsx(Ht,{children:t.jsx($t,{})})}),t.jsx(V,{path:"/login",element:t.jsx(vt,{})})]})})}Xe();Qe();const zt=document.getElementById("root"),Ft=Ze(zt);Ft.render(t.jsx(Ye.StrictMode,{children:t.jsx(L.Provider,{value:se,children:t.jsx(Ut,{})})}));
