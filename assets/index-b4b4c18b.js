import{r as d,j as t,e as be,o as ve,N as G,L as je,a as v,b as y,c as T,d as S,T as J,H as X,f as Q,g as Z,h as Y,Q as ee,C as $,i as te,k as E,l as k,m as R,U as _e,R as ye,n as Ie,p as Ce,q as Se,s as se,t as B,B as Ee,I as Re,u as Le,S as ke,v as De,w as Pe,x as Oe,y as Ae,z as Me,A as Te,D as $e,E as He,F as Ue,G as ze,J as A,K as Fe,M as Be,O as Ve,P as We,V as qe,W as Ke,X as Ge,Y as Je,Z as V,_ as Xe,$ as Qe,a0 as Ze,a1 as Ye}from"./vendor-33be0d1e.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=n(i);fetch(i.href,r)}})();const et=d.memo(({type:s="button",style:e="primary",onClick:n,children:o,readonly:i})=>e==="secondary"?t.jsx("button",{disabled:i,onClick:n,className:"button bg-orange-400 hover:bg-orange-500 ease-out duration-150 disabled:bg-slate-200 disabled:cursor-not-allowed",type:s,children:o}):e==="abort"?t.jsx("button",{disabled:i,onClick:n,className:"button bg-red-400 hover:bg-red-500 ease-out duration-150 disabled:bg-slate-200 disabled:cursor-not-allowed",type:s,children:o}):t.jsx("button",{disabled:i,onClick:n,className:"button bg-green-400 hover:bg-green-500 ease-out duration-150 disabled:bg-slate-200 disabled:cursor-not-allowed",type:s,children:o})),tt=d.memo(({children:s})=>t.jsx("h1",{className:"text-black font-bold text-xl",children:s})),W=d.memo(({placeholder:s,password:e=!1,autoFocus:n=!1,value:o,readonly:i,onChange:r})=>t.jsx("input",{disabled:i,className:"text-base form-input rounded-lg disabled:bg-slate-200 disabled:cursor-not-allowed transition-colors ease-in-out delay-150",value:o,type:e?"password":"text",autoFocus:n,placeholder:s,onChange:r}));function st(s){return s.op==="SYNC"}function ot(s){return s.op==="INSERT"}function nt(s){return s.op==="INVALIDATE"}function it(s){return s.op==="DELETE"}function at(s){return s.type==="m.room.create"}function rt(s){return s.type==="m.room.avatar"}function ct(s){return s.type==="m.space.child"}function lt(s){return s.type==="m.space.parent"}class M{constructor(e,n){this.roomID=e,this.hostname=n}events=[];stateEvents=[];name;notification_count=0;notification_highlight_count=0;joined_count=0;invited_count=0;windowPos={};addEvents(e){this.events.push(...e)}addStateEvents(e){this.stateEvents.push(...e)}getAvatarURL(){let e;return this.stateEvents.forEach(n=>{if(rt(n)){const o=n.content.url;o?.startsWith("mxc://")&&(e=`${this.hostname}/_matrix/media/r0/download/${o.substring(6)}`)}}),e}isSpace(){let e=!1;return this.stateEvents.forEach(n=>{at(n)&&(e=n.content.type==="m.space")}),e}setName(e){this.name=e}getName(){return this.name?this.name:this.roomID}setNotificationCount(e){this.notification_count=e}getNotificationCount(){return this.notification_count}setNotificationHighlightCount(e){this.notification_highlight_count=e}getNotificationHighlightCount(){return this.notification_highlight_count}setJoinedCount(e){this.joined_count=e}getJoinedCount(){return this.joined_count}setInvitedCount(e){this.invited_count=e}getInvitedCount(){return this.invited_count}getSpaceChildrenIDs(){const e=[];return this.stateEvents.forEach(n=>{ct(n)&&e.push(n.state_key)}),e}getSpaceParentIDs(){const e=[];return this.stateEvents.forEach(n=>{lt(n)&&e.push({roomID:n.state_key,canonical:n.content.canonical||!1})}),e}isDM(){return!1}isOnline(){return!1}}class dt extends be{static _instance;access_token;device_id;mxid;hostname;slidingSyncHostname;syncing=!1;roomsInView=[];rooms=new Set;syncPos;initialSync=!0;database;profileInfo;lastRanges;lastTxnID;get isLoggedIn(){return this.access_token!==void 0}static async Instance(){let e=this._instance;if(!e){e=this._instance=new this,e.database||await e.createDatabase();const n=e.database?.transaction("loginInfo","readonly"),o=await n?.store.getAll();if(await n?.done,o&&o.length>0){e.mxid=o[0].userId,e.hostname=o[0].hostname,e.slidingSyncHostname=o[0].slidingSyncHostname,e.access_token=o[0].access_token,e.device_id=o[0].device_id,e.profileInfo={avatar_url:o[0].avatarUrl,displayname:o[0].displayName};const i=e.database?.transaction("syncInfo","readonly"),r=await i?.store.get(e.mxid);await i?.done,r&&(e.syncPos=r.syncPos,e.initialSync=r.initialSync,e.lastRanges=r.lastRanges,e.lastTxnID=r.lastTxnID);const a=e.database?.transaction("rooms","readonly"),m=await a?.store.getAll();await a?.done,m&&(e.rooms=new Set(m.map(p=>{const l=new M(p.roomID,e.hostname);return l.windowPos=p.windowPos,l.setInvitedCount(p.invited_count),l.setJoinedCount(p.joined_count),l.setNotificationCount(p.notification_count),l.setNotificationHighlightCount(p.highlight_count),l.setName(p.name),p.events&&l.addEvents(p.events),p.stateEvents&&l.addStateEvents(p.stateEvents),l})),e.emit("rooms",e.rooms))}}return e}async createDatabase(){this.database=await ve("matrix",3,{upgrade(e){e.objectStoreNames.contains("rooms")&&e.deleteObjectStore("rooms"),e.objectStoreNames.contains("syncInfo")&&e.deleteObjectStore("syncInfo"),e.createObjectStore("rooms",{keyPath:"roomID"}),e.createObjectStore("loginInfo",{keyPath:"userId"}),e.createObjectStore("syncInfo",{keyPath:"userId"})}})}async setHostname(e){if(!e.startsWith("https://"))throw Error("Hostname must start with 'https://'");this.database||await this.createDatabase();const n=this.database?.transaction("loginInfo","readwrite");await n?.store.put({userId:this.mxid,hostname:e,slidingSyncHostname:this.slidingSyncHostname,access_token:this.access_token,device_id:this.device_id}),await n?.done,this.hostname=e}async startSync(){if(!this.isLoggedIn)throw Error("Not logged in");if(this.database||await this.createDatabase(),!this.syncing)for(this.syncing=!0;this.syncing;)try{await this.sync()}catch(e){console.error(e);return}}stopSync(){this.syncing=!1}isIndexInRange(e,n){for(const o of n)if(o[0]<e&&e<=o[1])return!0;return!1}shiftRight(e,n,o,i){for(let r=o-1;r>i-1;r--)if(this.isIndexInRange(r,n)){const a=[...this.rooms].find(m=>m.windowPos[e]===r+1);a&&(a.windowPos[e]=r)}}shiftLeft(e,n,o,i){for(let r=i+1;r<o+1;r++)if(this.isIndexInRange(r,n)){const a=[...this.rooms].find(m=>m.windowPos[e]===r-1);a&&(a.windowPos[e]=r)}}removeEntry(e,n,o){let i=-1;const r=[...this.rooms].map(a=>a.windowPos[e]);for(const a in r)Number(a)>i&&(i=Number(a));i<0||o>i||this.shiftLeft(e,n,i,o)}addEntry(e,n,o){let i=-1;const r=[...this.rooms].map(a=>a.windowPos[e]);for(const a in r)Number(a)>i&&(i=Number(a));i<0||o>i||this.shiftRight(e,n,i+1,o)}async sync(){if(!this.isLoggedIn)throw Error("Not logged in");if(!this.slidingSyncHostname)throw Error("Hostname must be set first");let e={overview:[[0,10]],spaces:[[0,Number.MAX_SAFE_INTEGER]]},n=1;if(!this.initialSync)for(const l in e){n=10;const u=[...this.rooms].filter(c=>this.roomsInView.includes(c.roomID)).map(c=>c.windowPos[l]).sort();u.push(u[u.length-1]+1);const h=u.reduce((c,f,g,N)=>g===0?(c.push([f,f]),c):f===N[g-1]+1?(c[c.length-1][1]=f,c):(c.push([f,f]),c),[]);e[l]=h}this.lastRanges&&Object.entries(e).toString()!==Object.entries(this.lastRanges).toString()&&(console.log("Ranges changed, resetting sync txn_id"),this.lastRanges=e,this.lastTxnID=Date.now().toString()),this.lastRanges||(this.lastRanges=e,this.lastTxnID=Date.now().toString());let o=`${this.slidingSyncHostname}/_matrix/client/unstable/org.matrix.msc3575/sync?timeout=30000`;this.syncPos&&(o=`${this.slidingSyncHostname}/_matrix/client/unstable/org.matrix.msc3575/sync?timeout=30000&pos=${this.syncPos}`);const i=await fetch(o,{method:"POST",headers:{Authorization:`Bearer ${this.access_token}`},body:JSON.stringify({txn_id:this.lastTxnID,lists:{spaces:{slow_get_all_rooms:!0,sort:["by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.avatar","*"]],timeline_limit:n,filters:{room_types:["m.space"]}},overview:{ranges:this.lastRanges.overview,sort:["by_notification_level","by_recency","by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.avatar","*"]],timeline_limit:n,filters:{}}},bump_event_types:["m.room.message","m.room.encrypted"]})});if(!i.ok){if(i.status===400&&(await i.json()).errcode==="M_UNKNOWN_POS"){this.syncPos=void 0;const l=this.database?.transaction("syncInfo","readwrite");await l?.store.put({userId:this.mxid,syncPos:this.syncPos,initialSync:this.initialSync,lastRanges:this.lastRanges,lastTxnID:this.lastTxnID}),await l?.done}throw console.error(i),Error("Error syncing. See console for error.")}const r=await i.json();this.syncPos=r.pos;const a=this.database?.transaction("syncInfo","readwrite");await a?.store.put({userId:this.mxid,syncPos:this.syncPos,initialSync:this.initialSync,lastRanges:this.lastRanges,lastTxnID:this.lastTxnID}),await a?.done;let m=-1;for(const l in r.lists){const u=r.lists[l];if(u.ops){for(const h of u.ops)if(st(h)){const c=this.database?.transaction("rooms","readwrite");for(let f=h.range[0];f<=h.range[1];f++){const g=h.room_ids[f-h.range[0]];if(!g)break;const N=[...this.rooms].find(x=>x.roomID===g);if(N){N.windowPos[l]=f;continue}const w=new M(g,this.hostname);w.setName(g),w.windowPos[l]=f,this.rooms.add(w),await c?.store.put({windowPos:w.windowPos,roomID:w.roomID,name:w.getName(),notification_count:w.getNotificationCount(),highlight_count:w.getNotificationHighlightCount(),joined_count:w.getJoinedCount(),invited_count:w.getInvitedCount(),avatarUrl:w.getAvatarURL(),isSpace:w.isSpace()})}await c?.done}else if(ot(h)){console.log("Got INSERT OP",h),[...this.rooms].find(x=>x.windowPos[l]===h.index)&&(m<0?this.addEntry(l,this.lastRanges[l],h.index):m>h.index?this.shiftRight(l,this.lastRanges[l],m,h.index):m<h.index&&this.shiftLeft(l,this.lastRanges[l],h.index,m)),m=-1;const f=this.database?.transaction("rooms","readwrite"),g=[...this.rooms].find(x=>x.roomID===h.room_id);if(g)g.windowPos[l]=h.index,await f?.store.put({windowPos:g.windowPos,roomID:g.roomID,name:g.getName(),notification_count:g.getNotificationCount(),highlight_count:g.getNotificationHighlightCount(),joined_count:g.getJoinedCount(),invited_count:g.getInvitedCount(),avatarUrl:g.getAvatarURL(),isSpace:g.isSpace()});else{const x=new M(h.room_id,this.hostname);x.setName(h.room_id),x.windowPos[l]=h.index,this.rooms.add(x),await f?.store.put({windowPos:x.windowPos,roomID:x.roomID,name:x.getName(),notification_count:x.getNotificationCount(),highlight_count:x.getNotificationHighlightCount(),joined_count:x.getJoinedCount(),invited_count:x.getInvitedCount(),avatarUrl:x.getAvatarURL(),isSpace:x.isSpace()})}const N=[...this.rooms].map(x=>x.roomID),w=N.filter((x,b)=>N.indexOf(x)!=b);w.length>0&&console.error("Duplicates found",w),await f?.done}else if(it(h)){console.log("Got DELETE OP",h);const c=[...this.rooms].find(f=>f.windowPos[l]===h.index);if(c){const f=this.database?.transaction("rooms","readwrite");await f?.store.delete(c.roomID),await f?.done,this.rooms.delete(c)}m!==-1&&this.removeEntry(l,this.lastRanges[l],m),m=h.index}else if(nt(h)){const c=this.database?.transaction("rooms","readwrite");for(let f=h.range[0];f<=h.range[1];f++){const g=[...this.rooms].find(N=>N.windowPos[l]===f);g&&(await c?.store.delete(g.roomID),this.rooms.delete(g))}await c?.done}m!==-1&&this.removeEntry(l,this.lastRanges[l],m)}}const p=this.database?.transaction("rooms","readwrite");for(const l in r.rooms){const u=r.rooms[l],h=u.name,c=u.notification_count,f=u.highlight_count,g=u.joined_count,N=u.invited_count,w=u.timeline,x=u.required_state,b=[...this.rooms].find(I=>I.roomID===l);if(!b){console.error("Could not find roomObj for roomID",l);continue}h&&b.setName(h),b.setNotificationCount(c),b.setNotificationHighlightCount(f),b.setJoinedCount(g),b.setInvitedCount(N),w&&b.addEvents(w),x&&b.addStateEvents(x),await p?.store.put({windowPos:b.windowPos,roomID:b.roomID,name:b.getName(),notification_count:b.getNotificationCount(),highlight_count:b.getNotificationHighlightCount(),joined_count:b.getJoinedCount(),invited_count:b.getInvitedCount(),events:w,stateEvents:x,avatarUrl:b.getAvatarURL(),isSpace:b.isSpace()})}await p?.done,r.rooms&&Object.keys(r.rooms).length>0&&this.emit("rooms",this.rooms)}addInViewRoom(e){this.roomsInView.push(e)}removeInViewRoom(e){this.roomsInView=this.roomsInView.filter(n=>n!==e)}getRooms(){return this.rooms}getSpaces(){return[...this.rooms].filter(e=>e.isSpace()).sort((e,n)=>e.getName()<n.getName()?-1:e.getName()>n.getName()?1:0)}getSpacesWithRooms(){const e=this.getSpaces(),n=new Set;for(const o of e){const i=o.getSpaceChildrenIDs(),r=new Set([...this.getRooms()].filter(a=>i.includes(a.roomID)));n.add({spaceRoom:o,children:r})}for(const o of this.getRooms()){const i=o.getSpaceParentIDs();for(const r of i){const a=[...this.getRooms()].find(p=>p.roomID===r.roomID);if(!a)continue;const m=[...n].find(p=>p.spaceRoom.roomID===a.roomID);if(m){[...m.children].find(p=>p.roomID===o.roomID)||m.children.add(o);continue}n.add({spaceRoom:a,children:new Set([o])})}}return n}async getLoginFlows(){if(!this.hostname)throw Error("Hostname must be set first");const e=await fetch(`${this.hostname}/_matrix/client/v3/login`);if(!e.ok)throw console.error(e),Error("Error requesting login flows. See console for error.");return await e.json()}async getWellKnown(){if(!this.hostname)throw Error("Hostname must be set first");const e=await fetch(`${this.hostname}/.well-known/matrix/client`);if(!e.ok)throw console.error(e),Error("Error requesting login flows. See console for error.");return await e.json()}async passwordLogin(e,n,o=5){if(this.database||await this.createDatabase(),!e)throw Error("Username must be set");if(!n)throw Error("Password must be set");this.mxid=e,await this.setHostname(`https://${e.split(":")[1]}`);try{const m=await this.getWellKnown();if(m["m.homeserver"]?.base_url&&await this.setHostname(m["m.homeserver"].base_url),m["org.matrix.msc3575.proxy"]?.url){const p=this.database?.transaction("loginInfo","readwrite");await p?.store.put({userId:this.mxid,hostname:this.hostname,slidingSyncHostname:m["org.matrix.msc3575.proxy"].url,access_token:this.access_token,device_id:this.device_id}),await p?.done,this.slidingSyncHostname=m["org.matrix.msc3575.proxy"].url}else throw Error("No sliding sync proxy found")}catch(m){console.warn(`No well-known found for ${this.hostname}:
${m}`)}if(((await this.getLoginFlows()).flows.filter(m=>m.type==="m.login.password")?.length||0)==0)throw Error("Password login is not supported by this homeserver");const r=await fetch(`${this.hostname}/_matrix/client/r0/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"m.login.password",identifier:{type:"m.id.user",user:e},user:e,password:n})});if(!r.ok)throw console.error(r),Error("Error logging in. See console for error.");const a=await r.json();if(ht(a))throw Error(`Error logging in: ${a.errcode}: ${a.error}`);if(mt(a)&&(console.error(`Rate limited. Retrying in ${a.retry_after_ms}ms. ${o} tries left.`),await this.passwordLogin(e,n,o-1)),ut(a)){const m=this.database?.transaction("loginInfo","readwrite");await m?.store.put({userId:a.user_id,hostname:this.hostname,slidingSyncHostname:this.slidingSyncHostname,access_token:a.access_token,device_id:a.device_id}),await m?.done,this.access_token=a.access_token,this.device_id=a.device_id,this.mxid=a.user_id}}async fetchProfileInfo(e){if(this.profileInfo)return this.profileInfo;if(!this.hostname)throw Error("Hostname must be set first");if(this.database||await this.createDatabase(),!this.access_token)throw Error("Access token must be set first");const n=await fetch(`${this.hostname}/_matrix/client/r0/profile/${e}`,{headers:{Authorization:`Bearer ${this.access_token}`}});if(!n.ok){if(n.status===404||n.status===403)return{};throw console.error(n),Error("Error fetching profile info. See console for error.")}const o=await n.json();o.avatar_url=o.avatar_url?.replace("mxc://",`${this.hostname}/_matrix/media/r0/download/`),this.profileInfo=o;const i=this.database?.transaction("loginInfo","readwrite");return await i?.store.put({userId:this.mxid,device_id:this.device_id,hostname:this.hostname,slidingSyncHostname:this.slidingSyncHostname,access_token:this.access_token,displayName:o.displayname,avatarUrl:o.avatar_url}),await i?.done,o}}function mt(s){return s.retry_after_ms!==void 0}function ut(s){return s.access_token!==void 0}function ht(s){return s.errcode!==void 0}const oe=await dt.Instance(),L=d.createContext(oe);function ft(){const s=d.useContext(L),[e,n]=d.useState(s.getRooms());return d.useEffect(()=>{const o=i=>{n(i)};return s.on("rooms",o),s.startSync(),()=>{s.removeListener("rooms",o)}},[]),e}function gt(){const s=d.useContext(L),[e,n]=d.useState(s.getSpacesWithRooms());return d.useEffect(()=>{const o=i=>{n(s.getSpacesWithRooms())};return s.on("rooms",o),s.startSync(),()=>{s.removeListener("rooms",o)}},[]),e}function pt(){const s=d.useContext(L),[e,n]=d.useState({displayname:s.mxid||"Unknown"});return d.useEffect(()=>{s.fetchProfileInfo(s.mxid).then(o=>{o.displayname||(o.displayname=s.mxid||"Unknown"),n(o)})},[]),e}const xt=d.memo(()=>{const s=d.useContext(L),[e,n]=d.useState(!1),[o,i]=d.useState(""),[r,a]=d.useState(""),[m,p]=d.useState("");if(s.isLoggedIn)return t.jsx(G,{to:"/"});const l=async()=>{try{n(!0),await s.passwordLogin(r,m)}catch(u){i(u.toString())}n(!1)};return t.jsxs("form",{className:"flex flex-col rounded-md shadow p-4 bg-white gap-2 min-w-[30rem]",onSubmit:u=>{u.preventDefault(),l()},children:[t.jsx(tt,{children:"Login"}),o?t.jsx("h2",{className:"text-red-500 font-normal text-sm",children:o}):t.jsx("div",{className:"min-h-[1.25rem]"}),t.jsx(W,{readonly:e,value:r,placeholder:"Username",onChange:u=>a(u.target.value)}),t.jsx(W,{readonly:e,value:m,password:!0,placeholder:"Password",onChange:u=>p(u.target.value)}),t.jsx(et,{readonly:e,style:"primary",type:"submit",children:"Login"})]})}),wt=d.memo(()=>t.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen bg-img",children:t.jsx(xt,{})})),H=d.memo(({avatarUrl:s,displayname:e,dm:n=!1,online:o=!1})=>s?t.jsxs("div",{className:"flex relative min-w-[2rem] min-h-[2rem] justify-center items-center m-0 mr-3 text-xl rounded-full text-white",children:[t.jsx("img",{className:"rounded-full w-8 h-8",alt:e,src:s}),n?o?t.jsx("div",{className:"bg-green-500 rounded-full w-3 h-3 absolute bottom-0 right-0"}):t.jsx("div",{className:"bg-red-500 rounded-full w-3 h-3 absolute bottom-0 right-0"}):t.jsx(t.Fragment,{})]}):t.jsxs("div",{className:"flex relative min-w-[2rem] min-h-[2rem] bg-orange-500 justify-center items-center m-0 mr-3 text-xl rounded-full text-white",children:[e[0].toUpperCase(),n?o?t.jsx("div",{className:"bg-green-500 rounded-full w-3 h-3 absolute bottom-0 right-0"}):t.jsx("div",{className:"bg-red-500 rounded-full w-3 h-3 absolute bottom-0 right-0"}):t.jsx(t.Fragment,{})]})),Nt=/((https?:\/\/(www\.)?)|(www\.))[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_+.~#?&//=]*)/,bt=/(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))/,vt=[s=>{const e=Nt.exec(s);return e&&{index:e.index,length:e[0].length,text:e[0],url:e[0]}},s=>{const e=bt.exec(s);return e&&{index:e.index,length:e[0].length,text:e[0],url:`mailto:${e[0]}`}}];function jt(){return t.jsx(je.AutoLinkPlugin,{matchers:vt})}const P=1,_t=new Set(["paragraph","quote","code","h1","h2","ul","ol"]),yt={code:"Code Block",h1:"Large Heading",h2:"Small Heading",h3:"Heading",h4:"Heading",h5:"Heading",ol:"Numbered List",paragraph:"Normal",quote:"Quote",ul:"Bulleted List"},q=d.memo(()=>t.jsx("div",{className:"divider"}));function K(s,e){e?(s.style.opacity="1",s.style.top=`${e.top+e.height+window.pageYOffset+10}px`,s.style.left=`${e.left+window.pageXOffset-s.offsetWidth/2+e.width/2}px`):(s.style.opacity="0",s.style.top="-1000px",s.style.left="-1000px")}const It=d.memo(({editor:s})=>{const e=d.useRef(null),n=d.useRef(null),o=d.useRef(!1),[i,r]=d.useState(""),[a,m]=d.useState(!1),[p,l]=d.useState(null),u=d.useCallback(()=>{const c=v.$getSelection();if(v.$isRangeSelection(c)){const x=ne(c),b=x.getParent();y.$isLinkNode(b)?r(b.getURL()):y.$isLinkNode(x)?r(x.getURL()):r("")}const f=e.current,g=window.getSelection(),N=document.activeElement;if(f===null)return;const w=s.getRootElement();if(c!==null&&!g?.isCollapsed&&w!==null&&w.contains(g?.anchorNode)){const x=g?.getRangeAt(0);let b;if(g?.anchorNode===w){let I=w;for(;I.firstElementChild!=null;)I=I.firstElementChild;b=I.getBoundingClientRect()}else b=x?.getBoundingClientRect();o.current||K(f,b),l(c)}else(!N||N.className!=="link-input")&&(K(f,void 0),l(null),m(!1),r(""));return!0},[s]);d.useEffect(()=>T.mergeRegister(s.registerUpdateListener(({editorState:c})=>{c.read(()=>{u()})}),s.registerCommand(v.SELECTION_CHANGE_COMMAND,()=>(u(),!0),P)),[s,u]),d.useEffect(()=>{s.getEditorState().read(()=>{u()})},[s,u]),d.useEffect(()=>{a&&n.current&&n.current.focus()},[a]);const h=d.createElement("a",{href:i,target:"_blank",rel:"noopener noreferrer"},i);return t.jsx("div",{ref:e,className:"link-editor",children:a?t.jsx("input",{ref:n,className:"link-input",value:i,onChange:c=>{r(c.target.value)},onKeyDown:c=>{c.key==="Enter"?(c.preventDefault(),p!==null&&(i!==""&&s.dispatchCommand(y.TOGGLE_LINK_COMMAND,i),m(!1))):c.key==="Escape"&&(c.preventDefault(),m(!1))}}):t.jsx(t.Fragment,{children:t.jsxs("div",{className:"link-input",children:[h,t.jsx("div",{className:"link-edit",role:"button",tabIndex:0,onMouseDown:c=>c.preventDefault(),onClick:()=>{m(!0)}})]})})})}),Ct=d.memo(({onChange:s,className:e,options:n,value:o})=>t.jsxs("select",{className:e,onChange:s,value:o,children:[t.jsx("option",{hidden:!0,value:""}),n.map(i=>t.jsx("option",{value:i,children:i},i))]}));function ne(s){const e=s.anchor,n=s.focus,o=s.anchor.getNode(),i=s.focus.getNode();return o===i?o:s.isBackward()?S.$isAtNodeEnd(n)?o:i:S.$isAtNodeEnd(e)?i:o}const St=d.memo(({editor:s,blockType:e,toolbarRef:n,setShowBlockOptionsDropDown:o})=>{const i=d.useRef(null);d.useEffect(()=>{const c=i.current,f=n.current;if(c!==null&&f!==null){const g=N=>{const w=N.target;!c.contains(w)&&!f.contains(w)&&o(!1)};return document.addEventListener("click",g),()=>{document.removeEventListener("click",g)}}},[i,o,n]);const r=()=>{e!=="paragraph"&&s.update(()=>{const c=v.$getSelection();v.$isRangeSelection(c)&&S.$wrapNodes(c,()=>v.$createParagraphNode())}),o(!1)},a=()=>{e!=="h1"&&s.update(()=>{const c=v.$getSelection();v.$isRangeSelection(c)&&S.$wrapNodes(c,()=>k.$createHeadingNode("h1"))}),o(!1)},m=()=>{e!=="h2"&&s.update(()=>{const c=v.$getSelection();v.$isRangeSelection(c)&&S.$wrapNodes(c,()=>k.$createHeadingNode("h2"))}),o(!1)},p=()=>{e!=="ul"?s.dispatchCommand(E.INSERT_UNORDERED_LIST_COMMAND,void 0):s.dispatchCommand(E.REMOVE_LIST_COMMAND,void 0),o(!1)},l=()=>{e!=="ol"?s.dispatchCommand(E.INSERT_ORDERED_LIST_COMMAND,void 0):s.dispatchCommand(E.REMOVE_LIST_COMMAND,void 0),o(!1)},u=()=>{e!=="quote"&&s.update(()=>{const c=v.$getSelection();v.$isRangeSelection(c)&&S.$wrapNodes(c,()=>k.$createQuoteNode())}),o(!1)},h=()=>{e!=="code"&&s.update(()=>{const c=v.$getSelection();v.$isRangeSelection(c)&&S.$wrapNodes(c,()=>R.$createCodeNode())}),o(!1)};return t.jsxs("div",{className:"dropdown",ref:i,children:[t.jsxs("button",{className:"item",onClick:r,children:[t.jsx(J,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Normal"}),e==="paragraph"&&t.jsx("span",{className:"active"})]}),t.jsxs("button",{className:"item",onClick:a,children:[t.jsx(X,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Large Heading"}),e==="h1"&&t.jsx("span",{className:"active"})]}),t.jsxs("button",{className:"item",onClick:m,children:[t.jsx(Q,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Small Heading"}),e==="h2"&&t.jsx("span",{className:"active"})]}),t.jsxs("button",{className:"item",onClick:p,children:[t.jsx(Z,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Bullet List"}),e==="ul"&&t.jsx("span",{className:"active"})]}),t.jsxs("button",{className:"item",onClick:l,children:[t.jsx(Y,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Numbered List"}),e==="ol"&&t.jsx("span",{className:"active"})]}),t.jsxs("button",{className:"item",onClick:u,children:[t.jsx(ee,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Quote"}),e==="quote"&&t.jsx("span",{className:"active"})]}),t.jsxs("button",{className:"item",onClick:h,children:[t.jsx($,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Code Block"}),e==="code"&&t.jsx("span",{className:"active"})]})]})}),Et=d.memo(()=>{const[s]=te.useLexicalComposerContext(),e=d.useRef(null),[n,o]=d.useState(!1),[i,r]=d.useState(!1),[a,m]=d.useState("paragraph"),[p,l]=d.useState(null),[u,h]=d.useState(!1),[c,f]=d.useState(""),[g,N]=d.useState(!1),[w,x]=d.useState(!1),[b,I]=d.useState(!1),[ie,ae]=d.useState(!1),[re,ce]=d.useState(!1),[le,de]=d.useState(!1),[me,ue]=d.useState(!1),O=d.useCallback(()=>{const j=v.$getSelection();if(v.$isRangeSelection(j)){const _=j.anchor.getNode(),C=_.getKey()==="root"?_:_.getTopLevelElementOrThrow(),z=C.getKey();if(s.getElementByKey(z)!==null)if(l(z),E.$isListNode(C)){const D=T.$getNearestNodeOfType(_,E.ListNode),Ne=D?D.getTag():C.getTag();m(Ne)}else{const D=k.$isHeadingNode(C)?C.getTag():C.getType();m(D),R.$isCodeNode(C)&&f(C.getLanguage()||R.getDefaultCodeLanguage())}I(j.hasFormat("bold")),ae(j.hasFormat("italic")),ce(j.hasFormat("underline")),de(j.hasFormat("strikethrough")),ue(j.hasFormat("code")),N(S.$isParentElementRTL(j));const F=ne(j),we=F.getParent();y.$isLinkNode(we)||y.$isLinkNode(F)?x(!0):x(!1)}},[s]);d.useEffect(()=>T.mergeRegister(s.registerUpdateListener(({editorState:j})=>{j.read(()=>{O()})}),s.registerCommand(v.SELECTION_CHANGE_COMMAND,(j,_)=>(O(),!1),P),s.registerCommand(v.CAN_UNDO_COMMAND,j=>(o(j),!1),P),s.registerCommand(v.CAN_REDO_COMMAND,j=>(r(j),!1),P)),[s,O]);const he=d.useMemo(()=>R.getCodeLanguages(),[]),fe=d.useCallback(j=>{s.update(()=>{if(p!==null){const _=v.$getNodeByKey(p);R.$isCodeNode(_)&&_.setLanguage(j.target.value)}})},[s,p]),ge=d.useCallback(()=>{w?s.dispatchCommand(y.TOGGLE_LINK_COMMAND,null):s.dispatchCommand(y.TOGGLE_LINK_COMMAND,"https://")},[s,w]),[pe,xe]=d.useState(null);return d.useEffect(()=>{const j=document.getElementsByClassName("editor-container")[0],_=document.createElement("div");return j.prepend(_),xe(_),()=>{j.removeChild(_)}},[]),t.jsxs("div",{className:"toolbar",ref:e,children:[t.jsx("button",{disabled:!n,onClick:()=>{s.dispatchCommand(v.UNDO_COMMAND,void 0)},className:"toolbar-item spaced","aria-label":"Undo",children:t.jsx(_e,{className:"format",size:20})}),t.jsx("button",{disabled:!i,onClick:()=>{s.dispatchCommand(v.REDO_COMMAND,void 0)},className:"toolbar-item","aria-label":"Redo",children:t.jsx(ye,{className:"format",size:20})}),t.jsx(q,{}),_t.has(a)&&t.jsxs(t.Fragment,{children:[t.jsxs("button",{className:"toolbar-item block-controls",onClick:()=>h(!u),"aria-label":"Formatting Options",children:[a==="h1"?t.jsx(X,{className:"icon",size:20}):a==="h2"?t.jsx(Q,{className:"icon",size:20}):a==="h3"?t.jsx(Ie,{className:"icon",size:20}):a==="h4"?t.jsx(Ce,{className:"icon",size:20}):a==="h5"?t.jsx(Se,{className:"icon",size:20}):a==="code"?t.jsx($,{className:"icon",size:20}):a==="paragraph"?t.jsx(J,{className:"icon",size:20}):a==="ol"?t.jsx(Y,{className:"icon",size:20}):a==="ul"?t.jsx(Z,{className:"icon",size:20}):a==="quote"?t.jsx(ee,{className:"icon",size:20}):t.jsx(t.Fragment,{}),t.jsx("span",{className:"text",children:yt[a]}),t.jsx(se,{size:20})]}),u&&B.createPortal(t.jsx(St,{editor:s,blockType:a,toolbarRef:e,setShowBlockOptionsDropDown:h}),pe),t.jsx(q,{})]}),a==="code"?t.jsxs(t.Fragment,{children:[t.jsx(Ct,{className:"toolbar-item code-language",onChange:fe,options:he,value:c}),t.jsx("i",{className:"chevron-down inside"})]}):t.jsxs(t.Fragment,{children:[t.jsx("button",{onClick:()=>{s.dispatchCommand(v.FORMAT_TEXT_COMMAND,"bold")},className:"toolbar-item spaced "+(b?"active":""),"aria-label":"Format Bold",children:t.jsx(Ee,{className:"format",size:20})}),t.jsx("button",{onClick:()=>{s.dispatchCommand(v.FORMAT_TEXT_COMMAND,"italic")},className:"toolbar-item spaced "+(ie?"active":""),"aria-label":"Format Italics",children:t.jsx(Re,{className:"format",size:20})}),t.jsx("button",{onClick:()=>{s.dispatchCommand(v.FORMAT_TEXT_COMMAND,"underline")},className:"toolbar-item spaced "+(re?"active":""),"aria-label":"Format Underline",children:t.jsx(Le,{className:"format",size:20})}),t.jsx("button",{onClick:()=>{s.dispatchCommand(v.FORMAT_TEXT_COMMAND,"strikethrough")},className:"toolbar-item spaced "+(le?"active":""),"aria-label":"Format Strikethrough",children:t.jsx(ke,{className:"format",size:20})}),t.jsx("button",{onClick:()=>{s.dispatchCommand(v.FORMAT_TEXT_COMMAND,"code")},className:"toolbar-item spaced "+(me?"active":""),"aria-label":"Insert Code",children:t.jsx($,{className:"format",size:20})}),t.jsx("button",{onClick:ge,className:"toolbar-item spaced "+(w?"active":""),"aria-label":"Insert Link",children:t.jsx(De,{className:"format",size:20})}),w&&B.createPortal(t.jsx(It,{editor:s}),document.body)," "]})]})});function Rt(){const[s]=te.useLexicalComposerContext();return d.useEffect(()=>R.registerCodeHighlighting(s),[s]),null}const Lt={ltr:"ltr",rtl:"rtl",placeholder:"editor-placeholder",paragraph:"editor-paragraph",quote:"editor-quote",heading:{h1:"editor-heading-h1",h2:"editor-heading-h2",h3:"editor-heading-h3",h4:"editor-heading-h4",h5:"editor-heading-h5"},list:{nested:{listitem:"editor-nested-listitem"},ol:"editor-list-ol",ul:"editor-list-ul",listitem:"editor-listitem"},image:"editor-image",link:"editor-link",text:{bold:"editor-text-bold",italic:"editor-text-italic",overflowed:"editor-text-overflowed",hashtag:"editor-text-hashtag",underline:"editor-text-underline",strikethrough:"editor-text-strikethrough",underlineStrikethrough:"editor-text-underlineStrikethrough",code:"editor-text-code"},code:"editor-code",codeHighlight:{atrule:"editor-tokenAttr",attr:"editor-tokenAttr",boolean:"editor-tokenProperty",builtin:"editor-tokenSelector",cdata:"editor-tokenComment",char:"editor-tokenSelector",class:"editor-tokenFunction","class-name":"editor-tokenFunction",comment:"editor-tokenComment",constant:"editor-tokenProperty",deleted:"editor-tokenProperty",doctype:"editor-tokenComment",entity:"editor-tokenOperator",function:"editor-tokenFunction",important:"editor-tokenVariable",inserted:"editor-tokenSelector",keyword:"editor-tokenAttr",namespace:"editor-tokenVariable",number:"editor-tokenProperty",operator:"editor-tokenOperator",prolog:"editor-tokenComment",property:"editor-tokenProperty",punctuation:"editor-tokenPunctuation",regex:"editor-tokenVariable",selector:"editor-tokenSelector",string:"editor-tokenSelector",symbol:"editor-tokenProperty",tag:"editor-tokenProperty",url:"editor-tokenOperator",variable:"editor-tokenVariable"}};function kt(){return t.jsx("div",{className:"editor-placeholder",id:"editor-placeholder",children:"Enter message..."})}const Dt=d.memo(({namespace:s,onChange:e,onError:n})=>{const o={namespace:s,theme:Lt,onError:n,nodes:[k.HeadingNode,E.ListNode,E.ListItemNode,k.QuoteNode,R.CodeNode,R.CodeHighlightNode,A.TableNode,A.TableCellNode,A.TableRowNode,y.AutoLinkNode,y.LinkNode]};return t.jsx(Pe.LexicalComposer,{initialConfig:o,children:t.jsxs("div",{className:"editor-container",children:[t.jsx(Et,{}),t.jsxs("div",{className:"editor-inner",children:[t.jsx(Oe.RichTextPlugin,{contentEditable:t.jsx(Ae.ContentEditable,{className:"editor-input",ariaLabelledBy:"editor-placeholder"}),placeholder:t.jsx(kt,{}),ErrorBoundary:Me}),t.jsx(Te.OnChangePlugin,{onChange:e}),t.jsx($e.HistoryPlugin,{}),t.jsx(He.LinkPlugin,{}),t.jsx(Rt,{}),t.jsx(jt,{}),t.jsx(Ue.MarkdownShortcutPlugin,{transformers:ze.TRANSFORMERS})]})]})})}),Pt=d.memo(({roomId:s,avatarUrl:e,displayname:n,dm:o=!1,online:i=!1,active:r=!1,onClick:a,hidden:m})=>{const{ref:p,inView:l}=Fe({triggerOnce:!0,rootMargin:"200px 0px",skip:m}),u=d.useContext(L);return d.useEffect(()=>{l?u.addInViewRoom(s):u.removeInViewRoom(s)},[l]),t.jsx("div",{ref:p,onClick:a,className:"w-full cursor-pointer",children:l&&(r?t.jsxs("div",{className:"flex flex-row gap-2 p-1 bg-gray-300 hover:bg-gray-400 rounded-lg duration-200 ease-in-out items-center",children:[t.jsx(H,{avatarUrl:e,displayname:n,dm:o,online:i}),t.jsx("span",{title:n,className:"text-slate-900 font-normal text-base capitalize max-w-[32ch] overflow-hidden text-ellipsis w-full whitespace-nowrap",children:n})]}):t.jsxs("div",{className:"flex flex-row gap-2 p-1 hover:bg-gray-300 rounded-lg duration-200 ease-in-out items-center",children:[t.jsx(H,{avatarUrl:e,displayname:n,dm:o,online:i}),t.jsx("span",{title:n,className:"text-slate-900 font-normal text-base capitalize max-w-[32ch] overflow-hidden text-ellipsis w-full whitespace-nowrap",children:n})]}))})});const Ot=d.memo(({sectionID:s,rooms:e,onClick:n,activeRoom:o,hidden:i})=>{const r=e.map(a=>t.jsx(Pt,{roomId:a.roomID,hidden:i,avatarUrl:a.avatarUrl,displayname:a.displayname,dm:a.dm,online:a.online,active:a.roomID===o,onClick:()=>{n(a.roomID)}},`${a.roomID}+${s}`));return t.jsx(t.Fragment,{children:r})}),U=d.memo(({section:s,onRoomClick:e,activeRoom:n})=>{const[o,i]=d.useState(!0);return t.jsxs("div",{className:"flex flex-col gap-1 pl-4",children:[t.jsxs("div",{className:"flex flex-row gap-2 py-1  items-center justify-start cursor-pointer h-8 text-slate-600",onClick:()=>i(r=>!r),children:[o?t.jsx(Be,{size:14}):t.jsx(se,{size:14}),t.jsx("span",{className:"font-normal text-sm capitalize max-w-[32ch] overflow-hidden text-ellipsis w-full whitespace-nowrap",children:s.sectionName})]}),!o&&t.jsx(Ot,{hidden:o,sectionID:s.roomID,rooms:s.rooms,onClick:e,activeRoom:n}),!o&&s.subsections.map(r=>t.jsx(U,{section:r,onRoomClick:e,activeRoom:n},r.roomID))]},s.roomID)}),At=d.memo(({sections:s,rooms:e})=>{const[n,o]=d.useState(void 0);return t.jsxs("div",{className:"flex flex-col gap-1 flex-1 p-2 min-w-[33ch] h-full overflow-y-auto overflow-x-hidden scrollbarSmall",children:[s.map(i=>t.jsx(U,{section:i,onRoomClick:r=>{o(r)},activeRoom:n},i.roomID)),t.jsx(U,{section:{sectionName:"Others",roomID:"other",subsections:[],rooms:e},onRoomClick:i=>{o(i)},activeRoom:n})]})});const Mt=d.memo(()=>{const s=pt(),e=gt(),n=ft(),o=[...e].filter(({spaceRoom:l})=>{const u=![...e].some(({children:c})=>[...c].some(f=>f.roomID===l.roomID)),h=l.getSpaceParentIDs().length===0;return u&&h}),i=[...n].filter(l=>{const u=![...e].some(({children:f})=>[...f].some(g=>g.roomID===l.roomID)),h=l.getSpaceParentIDs().length===0,c=!l.isSpace();return u&&h&&c}),r=o.map(l=>{const u=[...l.children].filter(c=>!c.isSpace()).map(c=>({roomID:c.roomID,displayname:c.getName(),avatarUrl:c.getAvatarURL(),dm:c.isDM(),online:c.isOnline()})),h=c=>{const f=[...e].find(g=>g.spaceRoom.roomID===c.roomID);if(f){const g=[...f?.children].map(N=>({roomID:N.roomID,displayname:N.getName(),avatarUrl:N.getAvatarURL(),dm:N.isDM(),online:N.isOnline()}));return{sectionName:c.getName(),rooms:g,roomID:c.roomID,subsections:[...f?.children].filter(N=>N.isSpace()).map(h).filter(N=>N!==void 0)}}};return{sectionName:l.spaceRoom.getName(),rooms:u,roomID:l.spaceRoom.roomID,subsections:[...l.children].filter(c=>c.isSpace()).map(h)}}),a=i.filter(l=>!l.isSpace()).map(l=>({roomID:l.roomID,displayname:l.getName(),avatarUrl:l.getAvatarURL(),dm:l.isDM(),online:l.isOnline()})),m=a.map(l=>l.roomID),p=m.filter((l,u)=>m.indexOf(l)!==u);return p.length>0&&console.error("otherRooms has duplicates",p),t.jsxs("div",{className:"flex flex-row w-full gap-2 min-h-screen h-screen",children:[t.jsxs("div",{className:"flex flex-col bg-gradient-to-br from-slate-100 via-gray-200 to-orange-200 border-r-[1px] border-slate-300",children:[t.jsxs("div",{className:"flex flex-row gap-2 m-2 p-1  items-center border-b-2",children:[s?.avatar_url&&t.jsx(H,{displayname:"Test",avatarUrl:s?.avatar_url,dm:!1,online:!1}),t.jsxs("div",{className:"flex flex-row justify-between items-center w-full",children:[t.jsx("span",{className:"text-base font-semibold",children:s?.displayname}),t.jsx(Ve,{size:28,stroke:"unset",className:"stroke-slate-600 rounded-full hover:bg-slate-300 p-1 cursor-pointer"})]})]}),t.jsx(At,{sections:r,rooms:a})]}),t.jsxs("div",{className:"flex-1 flex flex-col",children:[t.jsx("div",{className:"flex-1"}),t.jsx(Dt,{namespace:"Editor",onChange:()=>{},onError:l=>console.error(l)})]})]})}),Tt=({children:s})=>d.useContext(L).isLoggedIn?s:t.jsx(G,{to:"login"});We.init({locateFile:()=>qe}).then(()=>{console.log("Using WebAssembly Olm")}).catch(s=>(console.log("Failed to load Olm: trying legacy version",s),new Promise((e,n)=>{const o=document.createElement("script");o.src=Ke,o.onload=e,o.onerror=n,document.body.appendChild(o)}).then(()=>window.Olm.init()).then(()=>{console.log("Using legacy Olm")}).catch(e=>{console.log("Both WebAssembly and asm.js Olm failed!",e)})));function $t(){return t.jsx(Ge,{basename:"/cetirizine/",children:t.jsxs(Je,{children:[t.jsx(V,{path:"/",element:t.jsx(Tt,{children:t.jsx(Mt,{})})}),t.jsx(V,{path:"/login",element:t.jsx(wt,{})})]})})}Xe();Qe();const Ht=document.getElementById("root"),Ut=Ze(Ht);Ut.render(t.jsx(Ye.StrictMode,{children:t.jsx(L.Provider,{value:oe,children:t.jsx($t,{})})}));
