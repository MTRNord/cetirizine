import{m as b,r as I}from"./vendor-2246966f.js";function ie(n){return n.op==="SYNC"}function re(n){return n.op==="INSERT"}function ae(n){return n.op==="INVALIDATE"}function ce(n){return n.op==="DELETE"}function Ue(n){return n.type==="m.room.message"&&n.content.msgtype==="m.text"}function U(n){return n.state_key!==void 0}function de(n){return n.type==="m.room.create"}function fe(n){return n.type==="m.room.avatar"}function he(n){return n.type==="m.space.child"}function ue(n){return n.type==="m.space.parent"}function me(n){return n.type==="m.room.topic"}class S{constructor(e,t){this.roomID=e,this.hostname=t}events=[];stateEvents=[];name;notification_count=0;notification_highlight_count=0;joined_count=0;invited_count=0;is_dm=!1;windowPos={};addEvents(e){e.forEach(t=>{const o=this.events.findIndex(s=>s.event_id===t.event_id);o!==-1?this.events[o]=t:this.events.push(t)})}addStateEvents(e){e.forEach(t=>{const o=this.stateEvents.findIndex(s=>s.event_id===t.event_id);o!==-1?this.stateEvents[o]=t:this.stateEvents.push(t)})}getStateEvents(){return this.stateEvents}getAvatarURL(){let e;return this.stateEvents.forEach(t=>{if(fe(t)){const o=t.content.url;o?.startsWith("mxc://")&&(e=`${this.hostname}/_matrix/media/r0/download/${o.substring(6)}`)}}),e}isSpace(){let e=!1;return this.stateEvents.forEach(t=>{de(t)&&(e=t.content.type==="m.space")}),e}setName(e){this.name=e}getName(){return this.name?this.name:this.roomID}getTopic(){let e;return this.stateEvents.forEach(t=>{me(t)&&(e=t.content.topic)}),e}setNotificationCount(e){this.notification_count=e}getNotificationCount(){return this.notification_count}setNotificationHighlightCount(e){this.notification_highlight_count=e}getNotificationHighlightCount(){return this.notification_highlight_count}setJoinedCount(e){this.joined_count=e}getJoinedCount(){return this.joined_count}setInvitedCount(e){this.invited_count=e}getInvitedCount(){return this.invited_count}getSpaceChildrenIDs(){const e=[];return this.stateEvents.forEach(t=>{he(t)&&e.push(t.state_key)}),e}getSpaceParentIDs(){const e=[];return this.stateEvents.forEach(t=>{ue(t)&&e.push({roomID:t.state_key,canonical:t.content.canonical||!1})}),e}setDM(e){this.is_dm=e}isDM(){return this.is_dm}isOnline(){return!1}getEvents(){return this.events}getMemberName(e){let t=e;return this.stateEvents.forEach(o=>{o.type==="m.room.member"&&o.state_key===e&&o.content.membership=="join"&&(t=o.content.displayname)}),t}getMemberAvatar(e){let t;return this.stateEvents.forEach(o=>{if(o.type==="m.room.member"&&o.state_key===e&&o.content.membership=="join"){const s=o.content.avatar_url;s?.startsWith("mxc://")&&(t=`${this.hostname}/_matrix/media/r0/download/${s.substring(6)}`)}}),t}isEncrypted(){let e=!1;return this.stateEvents.forEach(t=>{t.type==="m.room.encryption"&&t.content.algorithm==="m.megolm.v1.aes-sha2"&&t.state_key===""&&(e=!0)}),e}}var k={},le={get exports(){return k},set exports(n){k=n}},D=typeof Reflect=="object"?Reflect:null,B=D&&typeof D.apply=="function"?D.apply:function(e,t,o){return Function.prototype.apply.call(e,t,o)},j;D&&typeof D.ownKeys=="function"?j=D.ownKeys:Object.getOwnPropertySymbols?j=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:j=function(e){return Object.getOwnPropertyNames(e)};function pe(n){console&&console.warn&&console.warn(n)}var z=Number.isNaN||function(e){return e!==e};function l(){l.init.call(this)}le.exports=l;k.once=we;l.EventEmitter=l;l.prototype._events=void 0;l.prototype._eventsCount=0;l.prototype._maxListeners=void 0;var q=10;function P(n){if(typeof n!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n)}Object.defineProperty(l,"defaultMaxListeners",{enumerable:!0,get:function(){return q},set:function(n){if(typeof n!="number"||n<0||z(n))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+n+".");q=n}});l.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};l.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||z(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function K(n){return n._maxListeners===void 0?l.defaultMaxListeners:n._maxListeners}l.prototype.getMaxListeners=function(){return K(this)};l.prototype.emit=function(e){for(var t=[],o=1;o<arguments.length;o++)t.push(arguments[o]);var s=e==="error",r=this._events;if(r!==void 0)s=s&&r.error===void 0;else if(!s)return!1;if(s){var i;if(t.length>0&&(i=t[0]),i instanceof Error)throw i;var a=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw a.context=i,a}var d=r[e];if(d===void 0)return!1;if(typeof d=="function")B(d,this,t);else for(var c=d.length,w=Z(d,c),o=0;o<c;++o)B(w[o],this,t);return!0};function J(n,e,t,o){var s,r,i;if(P(t),r=n._events,r===void 0?(r=n._events=Object.create(null),n._eventsCount=0):(r.newListener!==void 0&&(n.emit("newListener",e,t.listener?t.listener:t),r=n._events),i=r[e]),i===void 0)i=r[e]=t,++n._eventsCount;else if(typeof i=="function"?i=r[e]=o?[t,i]:[i,t]:o?i.unshift(t):i.push(t),s=K(n),s>0&&i.length>s&&!i.warned){i.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=n,a.type=e,a.count=i.length,pe(a)}return n}l.prototype.addListener=function(e,t){return J(this,e,t,!1)};l.prototype.on=l.prototype.addListener;l.prototype.prependListener=function(e,t){return J(this,e,t,!0)};function ge(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function G(n,e,t){var o={fired:!1,wrapFn:void 0,target:n,type:e,listener:t},s=ge.bind(o);return s.listener=t,o.wrapFn=s,s}l.prototype.once=function(e,t){return P(t),this.on(e,G(this,e,t)),this};l.prototype.prependOnceListener=function(e,t){return P(t),this.prependListener(e,G(this,e,t)),this};l.prototype.removeListener=function(e,t){var o,s,r,i,a;if(P(t),s=this._events,s===void 0)return this;if(o=s[e],o===void 0)return this;if(o===t||o.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,o.listener||t));else if(typeof o!="function"){for(r=-1,i=o.length-1;i>=0;i--)if(o[i]===t||o[i].listener===t){a=o[i].listener,r=i;break}if(r<0)return this;r===0?o.shift():ye(o,r),o.length===1&&(s[e]=o[0]),s.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this};l.prototype.off=l.prototype.removeListener;l.prototype.removeAllListeners=function(e){var t,o,s;if(o=this._events,o===void 0)return this;if(o.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):o[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete o[e]),this;if(arguments.length===0){var r=Object.keys(o),i;for(s=0;s<r.length;++s)i=r[s],i!=="removeListener"&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=o[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this};function X(n,e,t){var o=n._events;if(o===void 0)return[];var s=o[e];return s===void 0?[]:typeof s=="function"?t?[s.listener||s]:[s]:t?ve(s):Z(s,s.length)}l.prototype.listeners=function(e){return X(this,e,!0)};l.prototype.rawListeners=function(e){return X(this,e,!1)};l.listenerCount=function(n,e){return typeof n.listenerCount=="function"?n.listenerCount(e):Y.call(n,e)};l.prototype.listenerCount=Y;function Y(n){var e=this._events;if(e!==void 0){var t=e[n];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}l.prototype.eventNames=function(){return this._eventsCount>0?j(this._events):[]};function Z(n,e){for(var t=new Array(e),o=0;o<e;++o)t[o]=n[o];return t}function ye(n,e){for(;e+1<n.length;e++)n[e]=n[e+1];n.pop()}function ve(n){for(var e=new Array(n.length),t=0;t<e.length;++t)e[t]=n[t].listener||n[t];return e}function we(n,e){return new Promise(function(t,o){function s(i){n.removeListener(e,r),o(i)}function r(){typeof n.removeListener=="function"&&n.removeListener("error",s),t([].slice.call(arguments))}Q(n,e,r,{once:!0}),e!=="error"&&_e(n,s,{once:!0})})}function _e(n,e,t){typeof n.on=="function"&&Q(n,"error",e,t)}function Q(n,e,t,o){if(typeof n.on=="function")o.once?n.once(e,t):n.on(e,t);else if(typeof n.addEventListener=="function")n.addEventListener(e,function s(r){o.once&&n.removeEventListener(e,s),t(r)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}const be=(n,e)=>e.some(t=>n instanceof t);let F,W;function Ie(){return F||(F=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Ee(){return W||(W=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const ee=new WeakMap,T=new WeakMap,te=new WeakMap,O=new WeakMap,$=new WeakMap;function xe(n){const e=new Promise((t,o)=>{const s=()=>{n.removeEventListener("success",r),n.removeEventListener("error",i)},r=()=>{t(x(n.result)),s()},i=()=>{o(n.error),s()};n.addEventListener("success",r),n.addEventListener("error",i)});return e.then(t=>{t instanceof IDBCursor&&ee.set(t,n)}).catch(()=>{}),$.set(e,n),e}function Se(n){if(T.has(n))return;const e=new Promise((t,o)=>{const s=()=>{n.removeEventListener("complete",r),n.removeEventListener("error",i),n.removeEventListener("abort",i)},r=()=>{t(),s()},i=()=>{o(n.error||new DOMException("AbortError","AbortError")),s()};n.addEventListener("complete",r),n.addEventListener("error",i),n.addEventListener("abort",i)});T.set(n,e)}let A={get(n,e,t){if(n instanceof IDBTransaction){if(e==="done")return T.get(n);if(e==="objectStoreNames")return n.objectStoreNames||te.get(n);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return x(n[e])},set(n,e,t){return n[e]=t,!0},has(n,e){return n instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in n}};function De(n){A=n(A)}function Re(n){return n===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){const o=n.call(N(this),e,...t);return te.set(o,e.sort?e.sort():[e]),x(o)}:Ee().includes(n)?function(...e){return n.apply(N(this),e),x(ee.get(this))}:function(...e){return x(n.apply(N(this),e))}}function Le(n){return typeof n=="function"?Re(n):(n instanceof IDBTransaction&&Se(n),be(n,Ie())?new Proxy(n,A):n)}function x(n){if(n instanceof IDBRequest)return xe(n);if(O.has(n))return O.get(n);const e=Le(n);return e!==n&&(O.set(n,e),$.set(e,n)),e}const N=n=>$.get(n);function Ce(n,e,{blocked:t,upgrade:o,blocking:s,terminated:r}={}){const i=indexedDB.open(n,e),a=x(i);return o&&i.addEventListener("upgradeneeded",d=>{o(x(i.result),d.oldVersion,d.newVersion,x(i.transaction),d)}),t&&i.addEventListener("blocked",d=>t(d.oldVersion,d.newVersion,d)),a.then(d=>{r&&d.addEventListener("close",()=>r()),s&&d.addEventListener("versionchange",c=>s(c.oldVersion,c.newVersion,c))}).catch(()=>{}),a}const je=["get","getKey","getAll","getAllKeys","count"],ke=["put","add","delete","clear"],M=new Map;function V(n,e){if(!(n instanceof IDBDatabase&&!(e in n)&&typeof e=="string"))return;if(M.get(e))return M.get(e);const t=e.replace(/FromIndex$/,""),o=e!==t,s=ke.includes(t);if(!(t in(o?IDBIndex:IDBObjectStore).prototype)||!(s||je.includes(t)))return;const r=async function(i,...a){const d=this.transaction(i,s?"readwrite":"readonly");let c=d.store;return o&&(c=c.index(a.shift())),(await Promise.all([c[t](...a),s&&d.done]))[0]};return M.set(e,r),r}De(n=>({...n,get:(e,t,o)=>V(e,t)||n.get(e,t,o),has:(e,t)=>!!V(e,t)||n.has(e,t)}));class ne extends k{static _instance;access_token;device_id;mxid;hostname;slidingSyncHostname;syncing=!1;roomsInView=[];spaceOpen=[];rooms=new Set;syncPos;initialSync=!0;database;profileInfo;lastRanges;lastTxnID;to_device_since;olmMachine;get isLoggedIn(){return this.access_token!==void 0}static async Instance(){let e=this._instance;if(!e){e=this._instance=new this,e.database||await e.createDatabase();const t=e.database?.transaction("loginInfo","readonly"),o=await t?.store.getAll();if(await t?.done,o&&o.length>0){e.mxid=o[0].userId,e.hostname=o[0].hostname,e.slidingSyncHostname=o[0].slidingSyncHostname,e.access_token=o[0].access_token,e.device_id=o[0].device_id,e.profileInfo={avatar_url:o[0].avatarUrl,displayname:o[0].displayName},e.olmMachine=await b.OlmMachine.initialize(new b.UserId(e.mxid),new b.DeviceId(e.device_id),"cetirizine-crypto");const s=e.database?.transaction("syncInfo","readonly"),r=await s?.store.get(e.mxid);await s?.done,r&&(e.syncPos=r.syncPos,e.initialSync=r.initialSync,e.lastRanges=r.lastRanges,e.lastTxnID=r.lastTxnID,console.log("to_device_since:",r.to_device_since),e.to_device_since=r.to_device_since);const i=e.database?.transaction("rooms","readonly"),a=await i?.store.getAll();await i?.done,a&&(e.rooms=new Set(a.map(d=>{const c=new S(d.roomID,e.hostname);return c.windowPos=d.windowPos,c.setInvitedCount(d.invited_count),c.setJoinedCount(d.joined_count),c.setNotificationCount(d.notification_count),c.setNotificationHighlightCount(d.highlight_count),c.setName(d.name),d.events&&c.addEvents(d.events),d.stateEvents&&c.addStateEvents(d.stateEvents),d.isDM&&c.setDM(d.isDM),c})),e.emit("rooms",e.rooms))}}return e}async createDatabase(){this.database=await Ce("matrix",4,{upgrade(e,t){t<1&&(e.objectStoreNames.contains("rooms")&&e.deleteObjectStore("rooms"),e.objectStoreNames.contains("syncInfo")&&e.deleteObjectStore("syncInfo"),e.createObjectStore("rooms",{keyPath:"roomID"}),e.createObjectStore("loginInfo",{keyPath:"userId"}),e.createObjectStore("syncInfo",{keyPath:"userId"}))}})}async setHostname(e){if(!e.startsWith("https://"))throw Error("Hostname must start with 'https://'");this.database||await this.createDatabase();const t=this.database?.transaction("loginInfo","readwrite");await t?.store.put({userId:this.mxid,hostname:e,slidingSyncHostname:this.slidingSyncHostname,access_token:this.access_token,device_id:this.device_id}),await t?.done,this.hostname=e}async startSync(){if(!this.isLoggedIn)throw Error("Not logged in");if(this.database||await this.createDatabase(),!this.syncing)for(this.syncing=!0;this.syncing;)try{await this.sync()}catch(e){console.error(e);return}}stopSync(){this.syncing=!1}isIndexInRange(e,t){for(const o of t)if(o[0]<e&&e<=o[1])return!0;return!1}shiftRight(e,t,o,s){for(let r=o-1;r>s-1;r--)if(this.isIndexInRange(r,t)){const i=[...this.rooms].find(a=>a.windowPos[e]===r+1);i&&(i.windowPos[e]=r)}}shiftLeft(e,t,o,s){for(let r=s+1;r<o+1;r++)if(this.isIndexInRange(r,t)){const i=[...this.rooms].find(a=>a.windowPos[e]===r-1);i&&(i.windowPos[e]=r)}}async removeEntry(e,t,o){let s=-1;const r=[...this.rooms].map(a=>a.windowPos[e]);for(const a in r)Number(a)>s&&(s=Number(a));const i=[...this.rooms].find(a=>a.windowPos[e]===o);if(i){const a=this.database?.transaction("rooms","readwrite");await a?.store.delete(i.roomID),await a?.done,this.rooms.delete(i)}s<0||o>s||this.shiftLeft(e,t,s,o)}addEntry(e,t,o){let s=-1;const r=[...this.rooms].map(i=>i.windowPos[e]);for(const i in r)Number(i)>s&&(s=Number(i));s<0||o>s||this.shiftRight(e,t,s+1,o)}async sendIdentifyAndOneTimeKeys(){if(!this.isLoggedIn)throw Error("Not logged in");if(!this.slidingSyncHostname)throw Error("Hostname must be set first");if(!this.olmMachine)throw Error("Olm machine must be set first");const e=await this.olmMachine.outgoingRequests();for(const t of e)if(t.type===b.RequestType.KeysUpload){const o=t,s=await fetch(`${this.hostname}/_matrix/client/v3/keys/upload`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.access_token}`},body:o.body});s.ok||console.error("Failed to upload keys",s),this.olmMachine.markRequestAsSent(o.id,o.type,await s.text())}else if(t.type===b.RequestType.KeysQuery){const o=t,s=await fetch(`${this.hostname}/_matrix/client/v3/keys/query`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.access_token}`},body:o.body});s.ok||console.error("Failed to query keys",s),this.olmMachine.markRequestAsSent(o.id,o.type,await s.text())}else if(t.type===b.RequestType.KeysClaim){const o=t,s=await fetch(`${this.hostname}/_matrix/client/v3/keys/claim`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.access_token}`},body:o.body});s.ok||console.error("Failed to claim keys",s),this.olmMachine.markRequestAsSent(o.id,o.type,await s.text())}else if(t.type===b.RequestType.ToDevice){const o=t,s=await fetch(`${this.hostname}/_matrix/client/v3/sendToDevice/${o.event_type}/${o.txn_id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.access_token}`},body:o.body});s.ok||console.error("Failed to send to device",s),this.olmMachine.markRequestAsSent(o.id,o.type,await s.text())}else if(t.type===b.RequestType.SignatureUpload){const o=t,s=await fetch(`${this.hostname}/_matrix/client/v3/keys/signatures/upload`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.access_token}`},body:o.body});s.ok||console.error("Failed to upload signatures",s),this.olmMachine.markRequestAsSent(o.id,o.type,await s.text())}else if(t.type===b.RequestType.RoomMessage){const o=t,s=await fetch(`${this.hostname}/_matrix/client/v3/rooms/${o.room_id}/send/${o.event_type}/${o.txn_id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.access_token}`},body:o.body});s.ok||console.error("Failed to send message",s),this.olmMachine.markRequestAsSent(o.id,o.type,await s.text())}else if(t.type===b.RequestType.KeysBackup){const o=t,s=await fetch(`${this.hostname}/_matrix/client/v3/room_keys/keys`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.access_token}`},body:o.body});s.ok||console.error("Failed to backup keys",s),this.olmMachine.markRequestAsSent(o.id,o.type,await s.text())}}async sync(){if(!this.isLoggedIn)throw Error("Not logged in");if(!this.slidingSyncHostname)throw Error("Hostname must be set first");await this.sendIdentifyAndOneTimeKeys();let e={overview:[[0,10]],spaces:[[0,Number.MAX_SAFE_INTEGER]]},t=1;if(!this.initialSync)for(const c in e){t=10;const w=new Set([...this.rooms].filter(f=>this.roomsInView.includes(f.roomID)).map(f=>f.windowPos[c]).sort());if(w.size===0)continue;w.add([...w][w.size-1]+1);const _=[...w].reduce((f,y,m,p)=>m===0?(f.push([y,y]),f):y===p[m-1]+1?(f[f.length-1][1]=y,f):(f.push([y,y]),f),[]).sort((f,y)=>f[0]-y[0]).reduce((f,y,m,p)=>m===0?(f.push(y),f):(y[0]===p[m-1][0]&&y[1]===p[m-1][1]||f.push(y),f),[]);e[c]=_}this.lastRanges&&Object.entries(e).toString()!==Object.entries(this.lastRanges).toString()&&(console.log("Ranges changed, resetting sync txn_id",e),this.lastRanges=e,this.lastTxnID=Date.now().toString()),this.lastRanges||(console.log(e),this.lastRanges=e,this.lastTxnID=Date.now().toString());let o=`${this.slidingSyncHostname}/_matrix/client/unstable/org.matrix.msc3575/sync?timeout=30000`;this.syncPos&&(o=`${this.slidingSyncHostname}/_matrix/client/unstable/org.matrix.msc3575/sync?timeout=30000&pos=${this.syncPos}`),console.log("to_device_since:",this.to_device_since);const s=await fetch(o,{method:"POST",headers:{Authorization:`Bearer ${this.access_token}`},body:JSON.stringify({txn_id:this.lastTxnID,lists:{spaces:{slow_get_all_rooms:!0,sort:["by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.avatar","*"],["m.room.topic","*"],["m.room.member","$LAZY"]],timeline_limit:t,filters:{room_types:["m.space"]}},overview:{ranges:this.lastRanges.overview,sort:["by_notification_level","by_recency","by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.avatar","*"],["m.room.topic","*"],["m.room.member","$LAZY"]],timeline_limit:t,filters:{}}},bump_event_types:["m.room.message","m.room.encrypted"],extensions:{e2ee:{enabled:!0},to_device:{enabled:!0,since:this.to_device_since||null}}})});if(!s.ok){if(s.status===400&&(await s.json()).errcode==="M_UNKNOWN_POS"){this.syncPos=void 0;const c=this.database?.transaction("syncInfo","readwrite");await c?.store.put({userId:this.mxid,syncPos:this.syncPos,initialSync:this.initialSync,lastRanges:this.lastRanges,lastTxnID:this.lastTxnID}),await c?.done}console.error(s),console.error("Error syncing. See console for error.")}const r=await s.json();this.syncPos=r.pos,r.extensions?.to_device&&(console.log("Processing to_device events"),await this.olmMachine?.receiveSyncChanges(JSON.stringify(r.extensions.to_device.events||[]),new b.DeviceLists(r.extensions.e2ee?.device_lists?.changed?.map(c=>new b.UserId(c)),r.extensions.e2ee?.device_lists?.left?.map(c=>new b.UserId(c))),new Map(Object.entries(r.extensions.e2ee?.device_one_time_keys_count||[])),new Set(r.extensions.e2ee?.device_unused_fallback_key_types)),this.to_device_since=r.extensions.to_device.next_batch),await this.sendIdentifyAndOneTimeKeys();const i=this.database?.transaction("syncInfo","readwrite");await i?.store.put({userId:this.mxid,syncPos:this.syncPos,initialSync:this.initialSync,lastRanges:this.lastRanges,lastTxnID:this.lastTxnID,to_device_since:this.to_device_since}),await i?.done;let a=-1;for(const c in r.lists){const w=r.lists[c];if(w.ops){for(const u of w.ops)if(ie(u)){const E=this.database?.transaction("rooms","readwrite");for(let _=u.range[0];_<=u.range[1];_++){const f=u.room_ids[_-u.range[0]];if(!f)break;const y=[...this.rooms].find(p=>p.roomID===f);if(y){y.windowPos[c]=_;continue}const m=new S(f,this.hostname);m.setName(f),m.windowPos[c]=_,this.rooms.add(m),await E?.store.put({windowPos:m.windowPos,roomID:m.roomID,name:m.getName(),notification_count:m.getNotificationCount(),highlight_count:m.getNotificationHighlightCount(),joined_count:m.getJoinedCount(),invited_count:m.getInvitedCount(),avatarUrl:m.getAvatarURL(),isSpace:m.isSpace(),isDM:m.isDM(),stateEvents:m.getStateEvents(),events:m.getEvents()})}await E?.done}else if(re(u)){console.log("Got INSERT OP",u),[...this.rooms].find(p=>p.windowPos[c]===u.index)&&(a<0?this.addEntry(c,this.lastRanges[c],u.index):a>u.index?this.shiftRight(c,this.lastRanges[c],a,u.index):a<u.index&&this.shiftLeft(c,this.lastRanges[c],u.index,a)),a=-1;const _=this.database?.transaction("rooms","readwrite"),f=[...this.rooms].find(p=>p.roomID===u.room_id);if(f)f.windowPos[c]=u.index,await _?.store.put({windowPos:f.windowPos,roomID:f.roomID,name:f.getName(),notification_count:f.getNotificationCount(),highlight_count:f.getNotificationHighlightCount(),joined_count:f.getJoinedCount(),invited_count:f.getInvitedCount(),avatarUrl:f.getAvatarURL(),isSpace:f.isSpace(),isDM:f.isDM(),stateEvents:f.getStateEvents(),events:f.getEvents()});else{const p=await _?.store.get(u.room_id);let g=new S(u.room_id,this.hostname);g.setName(u.room_id),g.windowPos[c]=u.index,p&&(console.warn("Room in db but not in obj list.",u.room_id,"Updating obj list."),g=new S(u.room_id,this.hostname),g.setName(p.name),g.setNotificationCount(p.notification_count),g.setNotificationHighlightCount(p.highlight_count),g.setJoinedCount(p.joined_count),g.setInvitedCount(p.invited_count),g.setDM(p.isDM||!1)),this.rooms.add(g),await _?.store.put({windowPos:g.windowPos,roomID:g.roomID,name:g.getName(),notification_count:g.getNotificationCount(),highlight_count:g.getNotificationHighlightCount(),joined_count:g.getJoinedCount(),invited_count:g.getInvitedCount(),avatarUrl:g.getAvatarURL(),isSpace:g.isSpace(),isDM:g.isDM(),stateEvents:g.getStateEvents(),events:g.getEvents()})}const y=[...this.rooms].map(p=>p.roomID),m=y.filter((p,g)=>y.indexOf(p)!=g);m.length>0&&console.error("Duplicates found",m),await _?.done}else if(ce(u))console.log("Got DELETE OP",u),a!==-1&&await this.removeEntry(c,this.lastRanges[c],a),a=u.index;else if(ae(u)){const E=this.database?.transaction("rooms","readwrite");for(let _=u.range[0];_<=u.range[1];_++){const f=[...this.rooms].find(y=>y.windowPos[c]===_);f&&(await E?.store.delete(f.roomID),this.rooms.delete(f))}await E?.done}a!==-1&&await this.removeEntry(c,this.lastRanges[c],a)}}const d=this.database?.transaction("rooms","readwrite");for(const c in r.rooms){const w=r.rooms[c],u=w.name,E=w.notification_count,_=w.highlight_count,f=w.joined_count,y=w.invited_count,m=w.timeline,p=m?.filter(v=>U(v)).map(v=>v),g=m?.filter(v=>!U(v)).map(v=>v),L=w.required_state,H=w.is_dm;let h=[...this.rooms].find(v=>v.roomID===c);if(!h){console.warn("Could not find roomObj for roomID:",c);const v=await d?.store.get(c);v?(console.warn("Room in db but not in obj list.",c,"Updating obj list."),h=new S(c,this.hostname),h.setName(v.name),h.setNotificationCount(v.notification_count),h.setNotificationHighlightCount(v.highlight_count),h.setJoinedCount(v.joined_count),h.setInvitedCount(v.invited_count),h.setDM(v.isDM||!1),v.events&&h.addEvents(v.events),v.stateEvents&&h.addStateEvents(v.stateEvents),h.windowPos=v.windowPos):(console.warn("Could not find room in db. Creating new one."),h=new S(c,this.hostname),this.rooms.add(h))}if(u&&h.setName(u),h.setNotificationCount(E),h.setNotificationHighlightCount(_),h.setJoinedCount(f),h.setInvitedCount(y),g&&h.addEvents(g),L&&h.addStateEvents(L),p&&h.addStateEvents(p),(L||p)&&h.isEncrypted()){const se=[...L||[],...p||[]].filter(C=>C.type==="m.room.member"&&C.content.membership==="join").map(C=>new b.UserId(C.state_key));await this.olmMachine?.updateTrackedUsers(se)}H&&h.setDM(H),await d?.store.put({windowPos:h.windowPos,roomID:h.roomID,name:h.getName(),notification_count:h.getNotificationCount(),highlight_count:h.getNotificationHighlightCount(),joined_count:h.getJoinedCount(),invited_count:h.getInvitedCount(),events:h.getEvents(),stateEvents:h.getStateEvents(),avatarUrl:h.getAvatarURL(),isSpace:h.isSpace(),isDM:h.isDM()})}await d?.done,this.initialSync&&(this.initialSync=!1,console.log("initialSyncComplete")),r.rooms&&Object.keys(r.rooms).length>0&&this.emit("rooms",this.rooms)}addInViewRoom(e){this.roomsInView.push(e)}removeInViewRoom(e){this.roomsInView=this.roomsInView.filter(t=>t!==e)}addSpaceOpen(e){this.spaceOpen.push(e)}removeSpaceOpen(e){this.spaceOpen=this.spaceOpen.filter(t=>t!==e)}getRooms(){return this.rooms}getSpaces(){return[...this.rooms].filter(e=>e.isSpace()).sort((e,t)=>e.getName()<t.getName()?-1:e.getName()>t.getName()?1:0)}getSpacesWithRooms(){const e=this.getSpaces(),t=new Set;for(const o of e){const s=o.getSpaceChildrenIDs(),r=new Set([...this.getRooms()].filter(i=>s.includes(i.roomID)));t.add({spaceRoom:o,children:r})}for(const o of this.getRooms()){const s=o.getSpaceParentIDs();for(const r of s){const i=[...this.getRooms()].find(d=>d.roomID===r.roomID);if(!i)continue;const a=[...t].find(d=>d.spaceRoom.roomID===i.roomID);if(a){[...a.children].find(d=>d.roomID===o.roomID)||a.children.add(o);continue}t.add({spaceRoom:i,children:new Set([o])})}}return t}async getLoginFlows(){if(!this.hostname)throw Error("Hostname must be set first");const e=await fetch(`${this.hostname}/_matrix/client/v3/login`);if(!e.ok)throw console.error(e),Error("Error requesting login flows. See console for error.");return await e.json()}async getWellKnown(){if(!this.hostname)throw Error("Hostname must be set first");const e=await fetch(`${this.hostname}/.well-known/matrix/client`);if(!e.ok)throw console.error(e),Error("Error requesting login flows. See console for error.");return await e.json()}async passwordLogin(e,t,o=5){if(this.database||await this.createDatabase(),!e)throw Error("Username must be set");if(!t)throw Error("Password must be set");this.mxid=e,await this.setHostname(`https://${e.split(":")[1]}`);try{const a=await this.getWellKnown();if(a["m.homeserver"]?.base_url&&await this.setHostname(a["m.homeserver"].base_url),a["org.matrix.msc3575.proxy"]?.url){const d=this.database?.transaction("loginInfo","readwrite");await d?.store.put({userId:this.mxid,hostname:this.hostname,slidingSyncHostname:a["org.matrix.msc3575.proxy"].url,access_token:this.access_token,device_id:this.device_id}),await d?.done,this.slidingSyncHostname=a["org.matrix.msc3575.proxy"].url}else throw Error("No sliding sync proxy found")}catch(a){console.warn(`No well-known found for ${this.hostname}:
${a}`)}if(((await this.getLoginFlows()).flows.filter(a=>a.type==="m.login.password")?.length||0)==0)throw Error("Password login is not supported by this homeserver");const r=await fetch(`${this.hostname}/_matrix/client/r0/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"m.login.password",identifier:{type:"m.id.user",user:e},user:e,password:t})});if(!r.ok)throw console.error(r),Error("Error logging in. See console for error.");const i=await r.json();if(Ne(i))throw Error(`Error logging in: ${i.errcode}: ${i.error}`);if(Pe(i)&&(console.error(`Rate limited. Retrying in ${i.retry_after_ms}ms. ${o} tries left.`),await this.passwordLogin(e,t,o-1)),Oe(i)){const a=this.database?.transaction("loginInfo","readwrite");await a?.store.put({userId:i.user_id,hostname:this.hostname,slidingSyncHostname:this.slidingSyncHostname,access_token:i.access_token,device_id:i.device_id}),await a?.done,this.access_token=i.access_token,this.device_id=i.device_id,this.mxid=i.user_id,this.olmMachine=await b.OlmMachine.initialize(new b.UserId(this.mxid),new b.DeviceId(this.device_id),"cetirizine-crypto")}}async fetchProfileInfo(e){if(this.profileInfo)return this.profileInfo;if(!this.hostname)throw Error("Hostname must be set first");if(this.database||await this.createDatabase(),!this.access_token)throw Error("Access token must be set first");const t=await fetch(`${this.hostname}/_matrix/client/r0/profile/${e}`,{headers:{Authorization:`Bearer ${this.access_token}`}});if(!t.ok){if(t.status===404||t.status===403)return{};throw console.error(t),Error("Error fetching profile info. See console for error.")}const o=await t.json();o.avatar_url=o.avatar_url?.replace("mxc://",`${this.hostname}/_matrix/media/r0/download/`),this.profileInfo=o;const s=this.database?.transaction("loginInfo","readwrite");return await s?.store.put({userId:this.mxid,device_id:this.device_id,hostname:this.hostname,slidingSyncHostname:this.slidingSyncHostname,access_token:this.access_token,displayName:o.displayname,avatarUrl:o.avatar_url}),await s?.done,o}}function Pe(n){return n.retry_after_ms!==void 0}function Oe(n){return n.access_token!==void 0}function Ne(n){return n.errcode!==void 0}const oe=await ne.Instance(),R=I.createContext(oe);function Me(){const n=I.useContext(R),[e,t]=I.useState(n.getRooms());return I.useEffect(()=>{const o=s=>{t(s)};return n.on("rooms",o),n.startSync(),()=>{n.removeListener("rooms",o)}},[]),e}function Te(n){return[...I.useContext(R).getRooms()].find(t=>t.roomID===n)}function Ae(){const n=I.useContext(R),[e,t]=I.useState(n.getSpacesWithRooms());return I.useEffect(()=>{const o=s=>{t(n.getSpacesWithRooms())};return n.on("rooms",o),n.startSync(),()=>{n.removeListener("rooms",o)}},[]),e}function $e(){const n=I.useContext(R),[e,t]=I.useState({displayname:n.mxid||"Unknown"});return I.useEffect(()=>{n.fetchProfileInfo(n.mxid).then(o=>{o.displayname||(o.displayname=n.mxid||"Unknown"),t(o)})},[]),e}const Be=Object.freeze(Object.defineProperty({__proto__:null,MatrixClient:ne,MatrixContext:R,defaultMatrixClient:oe,useProfile:$e,useRoom:Te,useRooms:Me,useSpaces:Ae},Symbol.toStringTag,{value:"Module"}));export{R as M,$e as a,Ae as b,Me as c,Be as d,Ue as i,Te as u};
