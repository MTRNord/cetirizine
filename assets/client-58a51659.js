import{m as p,g as he,r as E}from"./vendor-9ff4cf4d.js";class de{constructor(e,t){this.client=e,this.user=t}olmMachine;outgoingRequestsBeingProcessed=!1;missingSessionsBeingRequested=!1;async decryptRoomEvent(e,t){return await this.olmMachine?.decryptRoomEvent(JSON.stringify(t),new p.RoomId(e))}async receiveSyncData(e,t,n,o){await this.olmMachine?.receiveSyncChanges(e,t,n,o)}async encryptRoomEvent(e,t,n){if(!this.client.isLoggedIn)throw Error("Not logged in");if(!this.user.hostname)throw Error("Hostname must be set first");if(!this.olmMachine)throw Error("Olm machine must be set first");await this.olmMachine?.encryptRoomEvent(e,t,n)}async initOlmMachine(e,t,n){this.olmMachine=await p.OlmMachine.initialize(e,t,"cetirizine-crypto",n)}async updateTrackedUsers(e){await this.olmMachine?.updateTrackedUsers(e)}async sendIdentifyAndOneTimeKeys(){if(!this.client.isLoggedIn)throw Error("Not logged in");if(!this.user.slidingSyncHostname)throw Error("Hostname must be set first");if(!this.olmMachine)throw Error("Olm machine must be set first");if(this.outgoingRequestsBeingProcessed)return;this.outgoingRequestsBeingProcessed=!0;const e=await this.olmMachine.outgoingRequests();for(const t of e)await this.processRequest(t);await this.getMissingSessions(),this.outgoingRequestsBeingProcessed=!1}async shareKeysForRoom(e){if(!this.client.isLoggedIn)throw Error("Not logged in");if(!this.user.slidingSyncHostname)throw Error("Hostname must be set first");if(!this.olmMachine)throw Error("Olm machine must be set first");const t=e.getEncryptionSettings();if(t){const n=await this.olmMachine.shareRoomKey(new p.RoomId(e.roomID),e.getJoinedMemberIDs().map(o=>new p.UserId(o)),t);for(const o of n)await this.processRequest(o)}}async getMissingSessions(){if(!this.client.isLoggedIn)throw Error("Not logged in");if(!this.user.slidingSyncHostname)throw Error("Hostname must be set first");if(!this.olmMachine)throw Error("Olm machine must be set first");if(this.missingSessionsBeingRequested)return;this.missingSessionsBeingRequested=!0;const t=[...this.client.getRooms()].filter(o=>o.isEncrypted()).map(o=>o.getJoinedMemberIDs().map(r=>new p.UserId(r))).flat(),n=await this.olmMachine?.getMissingSessions(t);n&&await this.processRequest(n),this.missingSessionsBeingRequested=!1}async processRequest(e){if(!this.client.isLoggedIn)throw Error("Not logged in");if(!this.user.slidingSyncHostname)throw Error("Hostname must be set first");if(!this.olmMachine)throw Error("Olm machine must be set first");if(e.type===p.RequestType.KeysUpload){const t=e,n=await fetch(`${this.user.hostname}/_matrix/client/v3/keys/upload`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.user.access_token}`},body:t.body});if(!n.ok){n.status===401&&(await this.client.logout(),console.error(n)),console.error("Failed to upload keys",n);return}this.olmMachine.markRequestAsSent(t.id,t.type,await n.text())}else if(e.type===p.RequestType.KeysQuery){const t=e,n=await fetch(`${this.user.hostname}/_matrix/client/v3/keys/query`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.user.access_token}`},body:t.body});if(!n.ok){n.status===401&&(await this.client.logout(),console.error(n)),console.error("Failed to query keys",n);return}this.olmMachine.markRequestAsSent(t.id,t.type,await n.text())}else if(e.type===p.RequestType.KeysClaim){const t=e,n=await fetch(`${this.user.hostname}/_matrix/client/v3/keys/claim`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.user.access_token}`},body:t.body});if(!n.ok){n.status===401&&(await this.client.logout(),console.error(n)),console.error("Failed to claim keys",n);return}this.olmMachine.markRequestAsSent(t.id,t.type,await n.text())}else if(e.type===p.RequestType.ToDevice){const t=e,n=await fetch(`${this.user.hostname}/_matrix/client/v3/sendToDevice/${t.event_type}/${t.txn_id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.user.access_token}`},body:t.body});if(!n.ok){n.status===401&&(await this.client.logout(),console.error(n)),console.error("Failed to send to device",n);return}this.olmMachine.markRequestAsSent(t.id??t.txn_id,t.type,await n.text())}else if(e.type===p.RequestType.SignatureUpload){const t=e,n=await fetch(`${this.user.hostname}/_matrix/client/v3/keys/signatures/upload`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.user.access_token}`},body:t.body});if(!n.ok){n.status===401&&(await this.client.logout(),console.error(n)),console.error("Failed to upload signatures",n);return}this.olmMachine.markRequestAsSent(t.id,t.type,await n.text())}else if(e.type===p.RequestType.RoomMessage){const t=e,n=await fetch(`${this.user.hostname}/_matrix/client/v3/rooms/${t.room_id}/send/${t.event_type}/${t.txn_id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.user.access_token}`},body:t.body});if(!n.ok){n.status===401&&(await this.client.logout(),console.error(n)),console.error("Failed to send message",n);return}this.olmMachine.markRequestAsSent(t.id,t.type,await n.text())}else if(e.type===p.RequestType.KeysBackup){const t=e,n=await fetch(`${this.user.hostname}/_matrix/client/v3/room_keys/keys`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.user.access_token}`},body:t.body});if(!n.ok){n.status===401&&(await this.client.logout(),console.error(n)),console.error("Failed to backup keys",n);return}this.olmMachine.markRequestAsSent(t.id,t.type,await n.text())}}logoutE2ee(){this.missingSessionsBeingRequested=!1,this.outgoingRequestsBeingProcessed=!1}}class ue{constructor(e){this.client=e,this.e2ee=new de(this.client,this)}access_token;device_id;mxid;hostname;slidingSyncHostname;e2ee;async logout(){if(!this.mxid||!this.access_token)throw Error("Not logged in");if(!this.hostname)throw Error("Hostname must be set first");const e=await fetch(`${this.hostname}/_matrix/client/v3/logout`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.access_token}`}});if(!e.ok)throw console.error(e),Error("Error logging out. See console for error.");this.access_token=void 0,this.device_id=void 0,this.slidingSyncHostname=void 0}async setHostname(e){if(!e.startsWith("https://"))throw Error("Hostname must start with 'https://'");this.client.database||await this.client.createDatabase();const t=this.client.database?.transaction("loginInfo","readwrite");await t?.store.put({userId:this.mxid,hostname:e,slidingSyncHostname:this.slidingSyncHostname,access_token:this.access_token,device_id:this.device_id}),await t?.done,this.hostname=e}async getLoginFlows(){if(!this.hostname)throw Error("Hostname must be set first");const e=await fetch(`${this.hostname}/_matrix/client/v3/login`);if(!e.ok)throw console.error(e),Error("Error requesting login flows. See console for error.");return await e.json()}async getWellKnown(){if(!this.hostname)throw Error("Hostname must be set first");const e=await fetch(`${this.hostname}/.well-known/matrix/client`);if(!e.ok)throw console.error(e),Error("Error requesting login flows. See console for error.");return await e.json()}async passwordLogin(e,t,n=5){if(this.client.database||await this.client.createDatabase(),!e)throw Error("Username must be set");if(!t)throw Error("Password must be set");this.mxid=e,await this.setHostname(`https://${e.split(":")[1]}`);try{const a=await this.getWellKnown();if(a["m.homeserver"]?.base_url&&await this.setHostname(a["m.homeserver"].base_url),a["org.matrix.msc3575.proxy"]?.url){const h=this.client.database?.transaction("loginInfo","readwrite");await h?.store.put({userId:this.mxid,hostname:this.hostname,slidingSyncHostname:a["org.matrix.msc3575.proxy"].url,access_token:this.access_token,device_id:this.device_id}),await h?.done,this.slidingSyncHostname=a["org.matrix.msc3575.proxy"].url}else throw Error("No sliding sync proxy found")}catch(a){console.warn(`No well-known found for ${this.hostname}:
${a}`)}if(((await this.getLoginFlows()).flows.filter(a=>a.type==="m.login.password")?.length||0)==0)throw Error("Password login is not supported by this homeserver");const r=await fetch(`${this.hostname}/_matrix/client/r0/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"m.login.password",identifier:{type:"m.id.user",user:e},user:e,password:t})});if(!r.ok)throw console.error(r),Error("Error logging in. See console for error.");const i=await r.json();if(fe(i))throw Error(`Error logging in: ${i.errcode}: ${i.error}`);if(ce(i)&&(console.error(`Rate limited. Retrying in ${i.retry_after_ms}ms. ${n} tries left.`),await this.passwordLogin(e,t,n-1)),le(i)){const a=this.client.database?.transaction("loginInfo","readwrite");await a?.store.put({userId:i.user_id,hostname:this.hostname,slidingSyncHostname:this.slidingSyncHostname,access_token:i.access_token,device_id:i.device_id}),await a?.done,this.access_token=i.access_token,this.device_id=i.device_id,this.mxid=i.user_id,await this.e2ee.initOlmMachine(new p.UserId(this.mxid),new p.DeviceId(this.device_id))}}}function le(s){return s.access_token!==void 0}function fe(s){return s.errcode!==void 0}var U={exports:{}},L=typeof Reflect=="object"?Reflect:null,V=L&&typeof L.apply=="function"?L.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},T;L&&typeof L.ownKeys=="function"?T=L.ownKeys:Object.getOwnPropertySymbols?T=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:T=function(e){return Object.getOwnPropertyNames(e)};function pe(s){console&&console.warn&&console.warn(s)}var Y=Number.isNaN||function(e){return e!==e};function l(){l.init.call(this)}U.exports=l;U.exports.once=ve;l.EventEmitter=l;l.prototype._events=void 0;l.prototype._eventsCount=0;l.prototype._maxListeners=void 0;var J=10;function M(s){if(typeof s!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof s)}Object.defineProperty(l,"defaultMaxListeners",{enumerable:!0,get:function(){return J},set:function(s){if(typeof s!="number"||s<0||Y(s))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+s+".");J=s}});l.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};l.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||Y(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function Z(s){return s._maxListeners===void 0?l.defaultMaxListeners:s._maxListeners}l.prototype.getMaxListeners=function(){return Z(this)};l.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var o=e==="error",r=this._events;if(r!==void 0)o=o&&r.error===void 0;else if(!o)return!1;if(o){var i;if(t.length>0&&(i=t[0]),i instanceof Error)throw i;var a=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw a.context=i,a}var h=r[e];if(h===void 0)return!1;if(typeof h=="function")V(h,this,t);else for(var u=h.length,c=se(h,u),n=0;n<u;++n)V(c[n],this,t);return!0};function G(s,e,t,n){var o,r,i;if(M(t),r=s._events,r===void 0?(r=s._events=Object.create(null),s._eventsCount=0):(r.newListener!==void 0&&(s.emit("newListener",e,t.listener?t.listener:t),r=s._events),i=r[e]),i===void 0)i=r[e]=t,++s._eventsCount;else if(typeof i=="function"?i=r[e]=n?[t,i]:[i,t]:n?i.unshift(t):i.push(t),o=Z(s),o>0&&i.length>o&&!i.warned){i.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=s,a.type=e,a.count=i.length,pe(a)}return s}l.prototype.addListener=function(e,t){return G(this,e,t,!1)};l.prototype.on=l.prototype.addListener;l.prototype.prependListener=function(e,t){return G(this,e,t,!0)};function ge(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Q(s,e,t){var n={fired:!1,wrapFn:void 0,target:s,type:e,listener:t},o=ge.bind(n);return o.listener=t,n.wrapFn=o,o}l.prototype.once=function(e,t){return M(t),this.on(e,Q(this,e,t)),this};l.prototype.prependOnceListener=function(e,t){return M(t),this.prependListener(e,Q(this,e,t)),this};l.prototype.removeListener=function(e,t){var n,o,r,i,a;if(M(t),o=this._events,o===void 0)return this;if(n=o[e],n===void 0)return this;if(n===t||n.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete o[e],o.removeListener&&this.emit("removeListener",e,n.listener||t));else if(typeof n!="function"){for(r=-1,i=n.length-1;i>=0;i--)if(n[i]===t||n[i].listener===t){a=n[i].listener,r=i;break}if(r<0)return this;r===0?n.shift():ye(n,r),n.length===1&&(o[e]=n[0]),o.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this};l.prototype.off=l.prototype.removeListener;l.prototype.removeAllListeners=function(e){var t,n,o;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[e]),this;if(arguments.length===0){var r=Object.keys(n),i;for(o=0;o<r.length;++o)i=r[o],i!=="removeListener"&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=n[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(o=t.length-1;o>=0;o--)this.removeListener(e,t[o]);return this};function ee(s,e,t){var n=s._events;if(n===void 0)return[];var o=n[e];return o===void 0?[]:typeof o=="function"?t?[o.listener||o]:[o]:t?we(o):se(o,o.length)}l.prototype.listeners=function(e){return ee(this,e,!0)};l.prototype.rawListeners=function(e){return ee(this,e,!1)};l.listenerCount=function(s,e){return typeof s.listenerCount=="function"?s.listenerCount(e):te.call(s,e)};l.prototype.listenerCount=te;function te(s){var e=this._events;if(e!==void 0){var t=e[s];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}l.prototype.eventNames=function(){return this._eventsCount>0?T(this._events):[]};function se(s,e){for(var t=new Array(e),n=0;n<e;++n)t[n]=s[n];return t}function ye(s,e){for(;e+1<s.length;e++)s[e]=s[e+1];s.pop()}function we(s){for(var e=new Array(s.length),t=0;t<e.length;++t)e[t]=s[t].listener||s[t];return e}function ve(s,e){return new Promise(function(t,n){function o(i){s.removeListener(e,r),n(i)}function r(){typeof s.removeListener=="function"&&s.removeListener("error",o),t([].slice.call(arguments))}ne(s,e,r,{once:!0}),e!=="error"&&_e(s,o,{once:!0})})}function _e(s,e,t){typeof s.on=="function"&&ne(s,"error",e,t)}function ne(s,e,t,n){if(typeof s.on=="function")n.once?s.once(e,t):s.on(e,t);else if(typeof s.addEventListener=="function")s.addEventListener(e,function o(r){n.once&&s.removeEventListener(e,o),t(r)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof s)}var be=U.exports;const B=he(be);function Xe(s){return s.type==="m.room.message"&&s.content.msgtype==="m.text"}function Ye(s){return s.type==="m.room.message"&&s.content.msgtype==="m.notice"}function Ze(s){return s.type==="m.room.message"&&s.content.msgtype==="m.image"}function Ge(s){return s.type==="m.room.message"&&s.content.msgtype==="m.audio"}function W(s){return s.state_key!==void 0}function Ee(s){return s.type==="m.room.create"}function Ie(s){return s.type==="m.room.avatar"}function xe(s){return s.type==="m.space.child"}function Se(s){return s.type==="m.space.parent"}function Re(s){return s.type==="m.room.topic"}var oe=(s=>(s[s.Online=0]="Online",s[s.Offline=1]="Offline",s[s.Unknown=2]="Unknown",s))(oe||{});class D extends B{constructor(e,t,n,o){super(),this.roomID=e,this.hostname=t,this.client=n,this.e2ee=o}events=[];stateEvents=[];name;notification_count=0;notification_highlight_count=0;joined_count=0;invited_count=0;is_dm=!1;windowPos={};addEvents(e){e.forEach(t=>{this.events.push(t)}),this.emit("events",this.events)}addStateEvents(e){e.forEach(t=>{const n=this.stateEvents.findIndex(o=>o.state_key===t.state_key&&o.type===t.type);n!==-1?this.stateEvents[n]=t:this.stateEvents.push(t)}),this.emit("state_events",this.stateEvents)}getStateEvents(){return this.stateEvents}isTombstoned(){let e=!1;return this.stateEvents.forEach(t=>{t.type==="m.room.tombstone"&&(e=!0)}),e}getAvatarURL(){let e;return this.stateEvents.forEach(t=>{if(Ie(t)){const n=t.content.url;n?.startsWith("mxc://")&&(e=this.client.convertMXC(n))}}),e}isSpace(){let e=!1;return this.stateEvents.forEach(t=>{Ee(t)&&(e=t.content.type==="m.space")}),e}setName(e){this.name=e}getName(){return this.name?this.name:this.roomID}getTopic(){let e;return this.stateEvents.forEach(t=>{Re(t)&&(e=t.content.topic)}),e}setNotificationCount(e){this.notification_count=e}getNotificationCount(){return this.notification_count}setNotificationHighlightCount(e){this.notification_highlight_count=e}getNotificationHighlightCount(){return this.notification_highlight_count}setJoinedCount(e){this.joined_count=e}getJoinedCount(){return this.joined_count}setInvitedCount(e){this.invited_count=e}getInvitedCount(){return this.invited_count}getSpaceChildrenIDs(){const e=[];return this.stateEvents.forEach(t=>{xe(t)&&e.push(t.state_key)}),e}getSpaceParentIDs(){const e=[];return this.stateEvents.forEach(t=>{Se(t)&&e.push({roomID:t.state_key,canonical:t.content.canonical||!1})}),e}setDM(e){this.is_dm=e}isDM(){return this.is_dm}get presence(){return oe.Unknown}getEvents(){return this.events}getMemberName(e){let t=e;return this.stateEvents.forEach(n=>{n.type==="m.room.member"&&n.state_key===e&&n.content.membership=="join"&&(t=n.content.displayname)}),t}getMemberAvatar(e){let t;return this.stateEvents.forEach(n=>{if(n.type==="m.room.member"&&n.state_key===e&&n.content.membership=="join"){const o=n.content.avatar_url;o?.startsWith("mxc://")&&(t=this.client.convertMXC(o))}}),t}isEncrypted(){let e=!1;return this.stateEvents.forEach(t=>{t.type==="m.room.encryption"&&t.content.algorithm==="m.megolm.v1.aes-sha2"&&t.state_key===""&&(e=!0)}),e}async sendHtmlMessage(e,t){if(this.isEncrypted()){console.log("Sending encrypted message"),await this.e2ee.getMissingSessions(),await this.e2ee.shareKeysForRoom(this);const n=await this.e2ee.encryptRoomEvent(new p.RoomId(this.roomID),"m.room.message",JSON.stringify({msgtype:"m.text",body:t,format:"org.matrix.custom.html",formatted_body:e})),o=await fetch(`${this.hostname}/_matrix/client/v3/rooms/${this.roomID}/send/m.room.encrypted/${Date.now().toString()}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.client.accessToken}`},body:n});if(!o.ok)throw new Error(`Failed to send message: ${o.status} ${o.statusText}`);return(await o.json()).event_id}else{const n=await fetch(`${this.hostname}/_matrix/client/v3/rooms/${this.roomID}/send/m.room.message/${Date.now().toString()}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.client.accessToken}`},body:JSON.stringify({msgtype:"m.text",body:t,format:"org.matrix.custom.html",formatted_body:e})});if(!n.ok)throw new Error(`Failed to send message: ${n.status} ${n.statusText}`);return(await n.json()).event_id}}async sendTextMessage(e){if(this.isEncrypted()){console.log("Sending encrypted message2"),await this.e2ee.getMissingSessions(),await this.e2ee.shareKeysForRoom(this);const t=await this.e2ee.encryptRoomEvent(new p.RoomId(this.roomID),"m.room.message",JSON.stringify({msgtype:"m.text",body:e})),n=await fetch(`${this.hostname}/_matrix/client/v3/rooms/${this.roomID}/send/m.room.encrypted/${Date.now().toString()}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.client.accessToken}`},body:t});if(!n.ok)throw new Error(`Failed to send message: ${n.status} ${n.statusText}`);return(await n.json()).event_id}else{const t=await fetch(`${this.hostname}/_matrix/client/v3/rooms/${this.roomID}/send/m.room.message/${Date.now().toString()}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.client.accessToken}`},body:JSON.stringify({msgtype:"m.text",body:e})});if(!t.ok)throw new Error(`Failed to send message: ${t.status} ${t.statusText}`);return(await t.json()).event_id}}getJoinedMemberIDs(){const e=[];return this.stateEvents.forEach(t=>{t.type==="m.room.member"&&t.content.membership==="join"&&e.push(t.state_key)}),e}getEncryptionSettings(){let e;return this.stateEvents.forEach(t=>{t.type==="m.room.encryption"&&t.state_key===""&&(e||(e=new p.EncryptionSettings),e.algorithm=t.content.algorithm==="m.megolm.v1.aes-sha2"?p.EncryptionAlgorithm.MegolmV1AesSha2:p.EncryptionAlgorithm.OlmV1Curve25519AesSha2,t.content.rotation_period_ms&&(e.rotationPeriod=BigInt(t.content.rotation_period_ms)),t.content.rotation_period_msgs&&(e.rotationPeriodMessages=BigInt(t.content.rotation_period_msgs))),t.type==="m.room.history_visibility"&&t.state_key===""&&(e||(e=new p.EncryptionSettings),e.historyVisibility=t.content.history_visibility)}),e&&(e.onlyAllowTrustedDevices=!1),e}isJoined(){let e=!1;return this.stateEvents.forEach(t=>{t.type==="m.room.member"&&t.state_key===this.client.mxid&&(e=t.content.membership==="join")}),e}}function Qe(s){const[e,t]=E.useState(s?.getEvents()||[]);return E.useEffect(()=>{if(s){t(s?.getEvents()||[]);const n=o=>{t([...o])};return s.on("events",n),()=>{s.removeListener("events",n)}}else t([])},[s]),e}const De=(s,e)=>e.some(t=>s instanceof t);let z,K;function Le(){return z||(z=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Ce(){return K||(K=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const ie=new WeakMap,$=new WeakMap,re=new WeakMap,O=new WeakMap,H=new WeakMap;function ke(s){const e=new Promise((t,n)=>{const o=()=>{s.removeEventListener("success",r),s.removeEventListener("error",i)},r=()=>{t(x(s.result)),o()},i=()=>{n(s.error),o()};s.addEventListener("success",r),s.addEventListener("error",i)});return e.then(t=>{t instanceof IDBCursor&&ie.set(t,s)}).catch(()=>{}),H.set(e,s),e}function je(s){if($.has(s))return;const e=new Promise((t,n)=>{const o=()=>{s.removeEventListener("complete",r),s.removeEventListener("error",i),s.removeEventListener("abort",i)},r=()=>{t(),o()},i=()=>{n(s.error||new DOMException("AbortError","AbortError")),o()};s.addEventListener("complete",r),s.addEventListener("error",i),s.addEventListener("abort",i)});$.set(s,e)}let A={get(s,e,t){if(s instanceof IDBTransaction){if(e==="done")return $.get(s);if(e==="objectStoreNames")return s.objectStoreNames||re.get(s);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return x(s[e])},set(s,e,t){return s[e]=t,!0},has(s,e){return s instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in s}};function Te(s){A=s(A)}function Me(s){return s===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){const n=s.call(P(this),e,...t);return re.set(n,e.sort?e.sort():[e]),x(n)}:Ce().includes(s)?function(...e){return s.apply(P(this),e),x(ie.get(this))}:function(...e){return x(s.apply(P(this),e))}}function Oe(s){return typeof s=="function"?Me(s):(s instanceof IDBTransaction&&je(s),De(s,Le())?new Proxy(s,A):s)}function x(s){if(s instanceof IDBRequest)return ke(s);if(O.has(s))return O.get(s);const e=Oe(s);return e!==s&&(O.set(s,e),H.set(e,s)),e}const P=s=>H.get(s);function Pe(s,e,{blocked:t,upgrade:n,blocking:o,terminated:r}={}){const i=indexedDB.open(s,e),a=x(i);return n&&i.addEventListener("upgradeneeded",h=>{n(x(i.result),h.oldVersion,h.newVersion,x(i.transaction),h)}),t&&i.addEventListener("blocked",h=>t(h.oldVersion,h.newVersion,h)),a.then(h=>{r&&h.addEventListener("close",()=>r()),o&&h.addEventListener("versionchange",u=>o(u.oldVersion,u.newVersion,u))}).catch(()=>{}),a}function Ne(s,{blocked:e}={}){const t=indexedDB.deleteDatabase(s);return e&&t.addEventListener("blocked",n=>e(n.oldVersion,n)),x(t).then(()=>{})}const $e=["get","getKey","getAll","getAllKeys","count"],Ae=["put","add","delete","clear"],N=new Map;function X(s,e){if(!(s instanceof IDBDatabase&&!(e in s)&&typeof e=="string"))return;if(N.get(e))return N.get(e);const t=e.replace(/FromIndex$/,""),n=e!==t,o=Ae.includes(t);if(!(t in(n?IDBIndex:IDBObjectStore).prototype)||!(o||$e.includes(t)))return;const r=async function(i,...a){const h=this.transaction(i,o?"readwrite":"readonly");let u=h.store;return n&&(u=u.index(a.shift())),(await Promise.all([u[t](...a),o&&h.done]))[0]};return N.set(e,r),r}Te(s=>({...s,get:(e,t,n)=>X(e,t)||s.get(e,t,n),has:(e,t)=>!!X(e,t)||s.has(e,t)}));function Ue(s){return s.op==="SYNC"}function Be(s){return s.op==="INSERT"}function He(s){return s.op==="INVALIDATE"}function qe(s){return s.op==="DELETE"}class Fe extends B{constructor(e,t){super(),this.client=e,this.user=t}syncing=!1;syncPos;initialSync=!0;lastRanges;lastTxnID;to_device_since;mustUpdateTxnID=!0;rooms=new Set;abortController=new AbortController;applyStoredSyncInfo(e){this.syncPos=e.syncPos,this.initialSync=e.initialSync,this.lastRanges=e.lastRanges,this.lastTxnID=e.lastTxnID,this.to_device_since=e.to_device_since}logout(){this.stopSync(),this.abortController.abort(),this.rooms=new Set,this.initialSync=!0,this.syncPos=void 0,this.to_device_since=void 0}resetAbortController(){this.abortController=new AbortController}async startSync(){if(!this.client.isLoggedIn)throw Error("Not logged in");if(this.client.database||await this.client.createDatabase(),!this.syncing)for(this.syncing=!0;this.syncing;)try{await this.sync()}catch(e){console.error(e)}}stopSync(){this.syncing=!1}isIndexInRange(e,t){for(const n of t)if(n[0]<e&&e<=n[1])return!0;return!1}shiftRight(e,t,n,o){for(let r=n-1;r>o-1;r--)if(this.isIndexInRange(r,t)){const i=[...this.rooms].find(a=>a.windowPos[e]===r+1);i&&(i.windowPos[e]=r)}}shiftLeft(e,t,n,o){for(let r=o+1;r<n+1;r++)if(this.isIndexInRange(r,t)){const i=[...this.rooms].find(a=>a.windowPos[e]===r-1);i&&(i.windowPos[e]=r)}}async removeEntry(e,t,n){let o=-1;const r=[...this.rooms].map(i=>i.windowPos[e]);for(const i in r)Number(i)>o&&(o=Number(i));o<0||n>o||this.shiftLeft(e,t,o,n)}addEntry(e,t,n){let o=-1;const r=[...this.rooms].map(i=>i.windowPos[e]);for(const i in r)Number(i)>o&&(o=Number(i));o<0||n>o||this.shiftRight(e,t,o+1,n)}async sync(){if(!this.client.isLoggedIn)throw Error("Not logged in");if(!this.user.slidingSyncHostname)throw Error("Hostname must be set first");await this.user.e2ee.sendIdentifyAndOneTimeKeys();let e={overview:[[0,20]],spaces:[[0,20]]};for(const c of this.client.spaceOpen)c!=="other"&&(e[c]=[[0,20]]);let t=1,n=10;if(!this.initialSync){for(const c in e){t=10,n=50;let v=new Set([...this.rooms].filter(m=>this.client.roomsInView.includes(m.roomID)).map(m=>m.windowPos[c]).sort().filter(m=>m!=null));if(this.client.getSpaces().find(m=>m.roomID===c)&&(v=new Set([...this.rooms].filter(m=>this.client.spacesInView.includes(m.roomID)).map(m=>m.windowPos[c]).sort().filter(m=>m!=null))),v.size!==0){const m=Math.min(...v),S=Math.max(...v);e[c]=[[Math.max(m-10,0),S+10]]}}e.e2ee=e.overview}this.lastRanges&&Object.entries(e).toString()!==Object.entries(this.lastRanges).toString()&&(console.log("Ranges changed, resetting sync txn_id",e),this.lastRanges=e,this.lastTxnID=Date.now().toString()),this.lastRanges||(this.lastRanges=e,this.lastTxnID=Date.now().toString()),this.mustUpdateTxnID&&(this.lastTxnID=Date.now().toString(),this.mustUpdateTxnID=!1);let o=`${this.user.slidingSyncHostname}/_matrix/client/unstable/org.matrix.msc3575/sync?timeout=5000`;this.syncPos&&(o=`${this.user.slidingSyncHostname}/_matrix/client/unstable/org.matrix.msc3575/sync?timeout=5000&pos=${this.syncPos}`);const r={txn_id:this.lastTxnID,lists:{spaces:{ranges:this.lastRanges.spaces,sort:["by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.tombstone",""],["m.room.avatar","*"],["m.room.topic","*"],["m.room.member","$LAZY"],["m.room.encryption",""],["m.room.history_visibility",""]],timeline_limit:0,filters:{room_types:["m.space"]}},overview:{ranges:this.lastRanges.overview,sort:["by_notification_level","by_recency","by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.tombstone",""],["m.room.avatar","*"],["m.room.topic","*"],["m.room.member","$LAZY"],["m.room.encryption",""],["m.room.history_visibility",""]],timeline_limit:t,filters:{not_room_types:["m.space"]}},e2ee:{ranges:this.lastRanges.overview,sort:["by_notification_level","by_recency","by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.tombstone",""],["m.room.avatar","*"],["m.room.topic","*"],["m.room.member","*"],["m.room.encryption",""],["m.room.history_visibility",""]],timeline_limit:t,filters:{not_room_types:["m.space"],is_encrypted:!0}}},bump_event_types:["m.room.message","m.room.encrypted"],extensions:{e2ee:{enabled:!0},to_device:{enabled:!0,since:this.to_device_since}}};for(const c of this.client.spaceOpen)c!=="other"&&(r.lists||(r.lists={}),r.lists[c]={slow_get_all_rooms:!0,ranges:this.lastRanges[c],sort:["by_notification_level","by_recency","by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.tombstone",""],["m.room.avatar","*"],["m.room.topic","*"],["m.room.member","$LAZY"],["m.room.encryption",""],["m.room.history_visibility",""]],timeline_limit:t,filters:{spaces:[c]}});this.client.currentRoom&&(r.room_subscriptions={},r.room_subscriptions[this.client.currentRoom]={sort:["by_notification_level","by_recency","by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.tombstone",""],["m.room.avatar","*"],["m.room.topic","*"],["m.room.member","$LAZY"],["m.room.encryption",""],["m.room.history_visibility",""]],timeline_limit:n,filters:{}});const i=await fetch(o,{method:"POST",signal:this.abortController.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.user.access_token}`},body:JSON.stringify(r)});if(!i.ok)if(i.status===400){if((await i.json()).errcode==="M_UNKNOWN_POS"){this.syncPos=void 0;const c=this.client.database?.transaction("syncInfo","readwrite");await c?.store.put({userId:this.user.mxid,syncPos:this.syncPos,initialSync:this.initialSync,lastRanges:this.lastRanges,lastTxnID:this.lastTxnID}),await c?.done}return}else i.status===401&&(await this.logout(),console.error(i),console.error("Error syncing. See console for error."));const a=await i.json();this.syncPos=a.pos,a.extensions?.to_device&&(await this.user.e2ee.receiveSyncData(JSON.stringify(a.extensions.to_device.events||[]),new p.DeviceLists(a.extensions.e2ee?.device_lists?.changed?.map(c=>new p.UserId(c)),a.extensions.e2ee?.device_lists?.left?.map(c=>new p.UserId(c))),new Map(Object.entries(a.extensions.e2ee?.device_one_time_keys_count||[])),new Set(a.extensions.e2ee?.device_unused_fallback_key_types)),this.to_device_since=a.extensions.to_device.next_batch),await this.user.e2ee.sendIdentifyAndOneTimeKeys();const h=this.client.database?.transaction("syncInfo","readwrite");await h?.store.put({userId:this.user.mxid,syncPos:this.syncPos,initialSync:this.initialSync,lastRanges:this.lastRanges,lastTxnID:this.lastTxnID,to_device_since:this.to_device_since}),await h?.done;let u=-1;for(const c in a.lists){const v=a.lists[c];if(v.ops){for(const m of v.ops)if(Ue(m)){const S=this.client.database?.transaction("rooms","readwrite");for(let I=m.range[0];I<=m.range[1];I++){const y=m.room_ids[I-m.range[0]];if(!y)break;const R=[...this.rooms].find(g=>g.roomID===y);if(R){R.windowPos[c]=I;continue}const w=new D(y,this.user.hostname,this.client,this.user.e2ee);w.setName(y),w.windowPos[c]=I,this.rooms.add(w),await S?.store.put({windowPos:w.windowPos,roomID:w.roomID,name:w.getName(),notification_count:w.getNotificationCount(),highlight_count:w.getNotificationHighlightCount(),joined_count:w.getJoinedCount(),invited_count:w.getInvitedCount(),avatarUrl:w.getAvatarURL(),isSpace:w.isSpace(),isDM:w.isDM(),stateEvents:w.getStateEvents(),events:w.getEvents()})}await S?.done}else if(Be(m)){console.log("Got INSERT OP",m),[...this.rooms].find(g=>g.windowPos[c]===m.index)&&(u<0?this.addEntry(c,this.lastRanges[c],m.index):u>m.index?this.shiftRight(c,this.lastRanges[c],u,m.index):u<m.index&&this.shiftLeft(c,this.lastRanges[c],m.index,u)),u=-1;const I=this.client.database?.transaction("rooms","readwrite"),y=[...this.rooms].find(g=>g.roomID===m.room_id);if(y)y.windowPos[c]=m.index,await I?.store.put({windowPos:y.windowPos,roomID:y.roomID,name:y.getName(),notification_count:y.getNotificationCount(),highlight_count:y.getNotificationHighlightCount(),joined_count:y.getJoinedCount(),invited_count:y.getInvitedCount(),avatarUrl:y.getAvatarURL(),isSpace:y.isSpace(),isDM:y.isDM(),stateEvents:y.getStateEvents(),events:y.getEvents()});else{const g=await I?.store.get(m.room_id);let f=new D(m.room_id,this.user.hostname,this.client,this.user.e2ee);f.setName(m.room_id),f.windowPos[c]=m.index,g&&(console.warn("Room in db but not in obj list.",m.room_id,"Updating obj list."),f=new D(m.room_id,this.user.hostname,this.client,this.user.e2ee),f.setName(g.name),f.setNotificationCount(g.notification_count),f.setNotificationHighlightCount(g.highlight_count),f.setJoinedCount(g.joined_count),f.setInvitedCount(g.invited_count),f.setDM(g.isDM||!1)),this.rooms.add(f),await I?.store.put({windowPos:f.windowPos,roomID:f.roomID,name:f.getName(),notification_count:f.getNotificationCount(),highlight_count:f.getNotificationHighlightCount(),joined_count:f.getJoinedCount(),invited_count:f.getInvitedCount(),avatarUrl:f.getAvatarURL(),isSpace:f.isSpace(),isDM:f.isDM(),stateEvents:f.getStateEvents(),events:f.getEvents()})}const R=[...this.rooms].map(g=>g.roomID),w=R.filter((g,f)=>R.indexOf(g)!=f);w.length>0&&console.error("Duplicates found",w),await I?.done}else qe(m)?(console.log("Got DELETE OP",m),u!==-1&&await this.removeEntry(c,this.lastRanges[c],u),u=m.index):He(m);u!==-1&&await this.removeEntry(c,this.lastRanges[c],u)}}for(const c in a.rooms){const v=a.rooms[c],m=v.name,S=v.notification_count,I=v.highlight_count,y=v.joined_count,R=v.invited_count,w=v.timeline,g=w?.filter(b=>W(b)).map(b=>b),f=w?.filter(b=>!W(b)).map(b=>b),k=v.required_state,q=v.is_dm;let d=[...this.rooms].find(b=>b.roomID===c);if(!d){console.warn("Could not find roomObj for roomID:",c);const b=this.client.database?.transaction("rooms","readwrite"),_=await b?.store.get(c);await b?.done,_?(console.warn("Room in db but not in obj list.",c,"Updating obj list."),d=new D(c,this.user.hostname,this.client,this.user.e2ee),d.setName(_.name),d.setNotificationCount(_.notification_count),d.setNotificationHighlightCount(_.highlight_count),d.setJoinedCount(_.joined_count),d.setInvitedCount(_.invited_count),d.setDM(_.isDM||!1),_.events&&d.addEvents(_.events),_.stateEvents&&d.addStateEvents(_.stateEvents),d.windowPos=_.windowPos):(console.warn("Could not find room in db. Creating new one."),d=new D(c,this.user.hostname,this.client,this.user.e2ee),this.rooms.add(d))}if(m&&d.setName(m),d.setNotificationCount(S),d.setNotificationHighlightCount(I),d.setJoinedCount(y),d.setInvitedCount(R),f&&d.addEvents(f),k&&d.addStateEvents(k),g&&d.addStateEvents(g),(k||g)&&d.isEncrypted()&&d.isJoined()){const _=[...k||[],...g||[]].filter(j=>j.type==="m.room.member"&&j.content.membership==="join").map(j=>new p.UserId(j.state_key));await this.user.e2ee.updateTrackedUsers(_)}q&&d.setDM(q);const F=this.client.database?.transaction("rooms","readwrite");await F?.store.put({windowPos:d.windowPos,roomID:d.roomID,name:d.getName(),notification_count:d.getNotificationCount(),highlight_count:d.getNotificationHighlightCount(),joined_count:d.getJoinedCount(),invited_count:d.getInvitedCount(),events:d.getEvents(),stateEvents:d.getStateEvents(),avatarUrl:d.getAvatarURL(),isSpace:d.isSpace(),isDM:d.isDM()}),await F?.done}this.initialSync&&(this.initialSync=!1,console.log("initialSyncComplete")),a.rooms&&Object.keys(a.rooms).length>0&&this.emit("rooms",this.rooms)}}class ae extends B{static _instance;roomsInView=[];spacesInView=[];spaceOpen=[];database;profileInfo;currentRoom;user=new ue(this);sync=new Fe(this,this.user);get accessToken(){return this.user.access_token}get isLoggedIn(){return this.user.access_token!==void 0}get mxid(){return this.user.mxid}async passwordLogin(e,t){await this.user.passwordLogin(e,t)}convertMXC(e){return`${this.user.hostname}/_matrix/media/r0/download/${e.substring(6)}`}setCurrentRoom(e){e!==this.currentRoom&&(this.currentRoom=e,console.log("Current room changed to",e,"restarting sync"),this.sync.mustUpdateTxnID=!0)}static async Instance(){let e=this._instance;if(!e){e=this._instance=new this,e.database||await e.createDatabase();const t=e.database?.transaction("loginInfo","readonly"),n=await t?.store.getAll();if(await t?.done,n&&n.length>0){e.user.mxid=n[0].userId,e.user.hostname=n[0].hostname,e.user.slidingSyncHostname=n[0].slidingSyncHostname,e.user.access_token=n[0].access_token,e.user.device_id=n[0].device_id,e.profileInfo={avatar_url:n[0].avatarUrl,displayname:n[0].displayName},e.user.mxid&&e.user.hostname&&e.user.access_token&&e.user.device_id&&await e.user.e2ee.initOlmMachine(new p.UserId(e.user.mxid),new p.DeviceId(e.user.device_id));const o=e.database?.transaction("syncInfo","readonly"),r=await o?.store.get(e.user.mxid);await o?.done,r&&e.sync.applyStoredSyncInfo(r);const i=e.database?.transaction("rooms","readonly"),a=await i?.store.getAll();await i?.done,a&&(e.sync.rooms=new Set(a.map(h=>{const u=new D(h.roomID,e.user.hostname,e,e.user.e2ee);return u.windowPos=h.windowPos,u.setInvitedCount(h.invited_count),u.setJoinedCount(h.joined_count),u.setNotificationCount(h.notification_count),u.setNotificationHighlightCount(h.highlight_count),u.setName(h.name),h.events&&u.addEvents(h.events),h.stateEvents&&u.addStateEvents(h.stateEvents),h.isDM&&u.setDM(h.isDM),u})),e.emit("rooms",e.sync.rooms))}e.sync.on("rooms",o=>{e.emit("rooms",o)})}return e}async createDatabase(){this.database=await Pe("matrix",4,{upgrade(e,t){t<1&&(e.objectStoreNames.contains("rooms")&&e.deleteObjectStore("rooms"),e.objectStoreNames.contains("syncInfo")&&e.deleteObjectStore("syncInfo"),e.createObjectStore("rooms",{keyPath:"roomID"}),e.createObjectStore("loginInfo",{keyPath:"userId"}),e.createObjectStore("syncInfo",{keyPath:"userId"}))}})}async decryptRoomEvent(e,t){if(!this.isLoggedIn)throw Error("Not logged in");return this.user.e2ee.decryptRoomEvent(e,t)}async logout(){if(this.sync.logout(),await this.user.logout(),this.user.e2ee.logoutE2ee(),this.user.mxid){const t=this.database?.transaction("syncInfo","readwrite");await t?.store.delete(this.user.mxid),await t?.done;const n=this.database?.transaction("loginInfo","readwrite");await n?.store.delete(this.user.mxid),await n?.done}const e=this.database?.transaction("rooms","readwrite");await e?.store.clear(),await e?.done,this.user.mxid=void 0,this.sync.resetAbortController(),await Ne("cetirizine-crypto",{blocked(){location.reload()}})}addInViewRoom(e){this.roomsInView.push(e)}removeInViewRoom(e){this.roomsInView=this.roomsInView.filter(t=>t!==e)}addInViewSpace(e){this.spacesInView.push(e)}removeInViewSpace(e){this.spacesInView=this.spacesInView.filter(t=>t!==e)}addSpaceOpen(e){e!=="other"&&(this.spaceOpen.push(e),console.log("Space opened",e,"restarting sync"),this.sync.mustUpdateTxnID=!0)}removeSpaceOpen(e){e!=="other"&&(this.spaceOpen=this.spaceOpen.filter(t=>t!==e),this.sync.mustUpdateTxnID=!0)}getRooms(){return this.sync.rooms}getSpaces(){return[...this.sync.rooms].filter(e=>e.isSpace()&&!e.isTombstoned()).sort((e,t)=>e.getName()<t.getName()?-1:e.getName()>t.getName()?1:0)}getSpacesWithRooms(){const e=this.getSpaces(),t=new Set;for(const n of e){const o=n.getSpaceChildrenIDs(),r=new Set([...this.getRooms()].filter(i=>o.includes(i.roomID)));t.add({spaceRoom:n,children:r})}for(const n of this.getRooms()){if(n.isSpace()||n.isTombstoned())continue;const o=n.getSpaceParentIDs();for(const r of o){const i=[...this.getRooms()].find(h=>h.roomID===r.roomID);if(!i)continue;const a=[...t].find(h=>h.spaceRoom.roomID===i.roomID);if(a){[...a.children].find(h=>h.roomID===n.roomID)||a.children.add(n);continue}t.add({spaceRoom:i,children:new Set([n])})}}return t}async startSync(){await this.sync.startSync()}async fetchProfileInfo(e){if(this.profileInfo)return this.profileInfo;if(!this.user.hostname)throw Error("Hostname must be set first");if(this.database||await this.createDatabase(),!this.user.access_token)throw Error("Access token must be set first");const t=await fetch(`${this.user.hostname}/_matrix/client/r0/profile/${e}`,{headers:{Authorization:`Bearer ${this.user.access_token}`}});if(!t.ok){if(t.status===404||t.status===403)return{};throw console.error(t),Error("Error fetching profile info. See console for error.")}const n=await t.json();n.avatar_url=n.avatar_url?.replace("mxc://",`${this.user.hostname}/_matrix/media/r0/download/`),this.profileInfo=n;const o=this.database?.transaction("loginInfo","readwrite");return await o?.store.put({userId:this.user.mxid,device_id:this.user.device_id,hostname:this.user.hostname,slidingSyncHostname:this.user.slidingSyncHostname,access_token:this.user.access_token,displayName:n.displayname,avatarUrl:n.avatar_url}),await o?.done,n}}function ce(s){return s.retry_after_ms!==void 0}const me=await ae.Instance(),C=E.createContext(me);function Ve(){const s=E.useContext(C),[e,t]=E.useState(s.getRooms());return E.useEffect(()=>{const n=o=>{t(o)};return s.on("rooms",n),s.startSync(),()=>{s.removeListener("rooms",n)}},[]),e}function Je(s){return[...E.useContext(C).getRooms()].find(t=>t.roomID===s)}function We(){const s=E.useContext(C),[e,t]=E.useState(s.getSpacesWithRooms());return E.useEffect(()=>{const n=o=>{t(s.getSpacesWithRooms())};return s.on("rooms",n),s.startSync(),()=>{s.removeListener("rooms",n)}},[]),e}function ze(){const s=E.useContext(C),[e,t]=E.useState({displayname:s.mxid||"Unknown"});return E.useEffect(()=>{s.fetchProfileInfo(s.mxid).then(n=>{n.displayname||(n.displayname=s.mxid||"Unknown"),t(n)})},[]),e}const et=Object.freeze(Object.defineProperty({__proto__:null,MatrixClient:ae,MatrixContext:C,defaultMatrixClient:me,isRateLimitError:ce,useProfile:ze,useRoom:Je,useRooms:Ve,useSpaces:We},Symbol.toStringTag,{value:"Module"}));export{C as M,oe as O,Ye as a,Ze as b,Ge as c,Qe as d,ze as e,We as f,Ve as g,et as h,Xe as i,Je as u};
