import{m as p,g as Ee,r as R}from"./vendor-57e8a224.js";class v extends Error{constructor(e){e?super(e):super("The Matrix SDK encountered and unknown error")}}class x extends v{constructor(){super("Not logged in")}}class S extends v{constructor(){super("Hostname must be set first")}}class Ie extends v{constructor(){super("Hostname must start with 'https://'")}}class P extends v{constructor(){super("Olm machine must be set first")}}class oe extends v{constructor(){super("Access token must be set first")}}class re extends v{constructor(e){super("Error fetching profile info."),this.response=e}}class xe extends v{constructor(e){super("Error logging out."),this.response=e}}class X extends v{constructor(e){super("Error requesting login flows."),this.response=e}}class Se extends v{constructor(){super("Username must be set")}}class Re extends v{constructor(){super("Password must be set")}}class De extends v{constructor(){super("No sliding sync proxy found")}}class Y extends v{constructor(e,t){super("Error logging in."),this.response=e,this.matrix_error=t}}class ke extends v{constructor(){super("Password login is not supported by this homeserver")}}class O extends v{constructor(e){super(`Failed to send message: ${e.status} ${e.statusText}`),this.response=e}}class Z extends v{constructor(e){super("Error syncing"),this.response=e}}class Te{constructor(e,t){this.client=e,this.user=t}olmMachine;outgoingRequestsBeingProcessed=!1;missingSessionsBeingRequested=!1;async decryptRoomEvent(e,t){return await this.olmMachine?.decryptRoomEvent(JSON.stringify(t),new p.RoomId(e))}async receiveSyncData(e,t,s,i){return await this.olmMachine?.receiveSyncChanges(e,t,s,i)}async encryptRoomEvent(e,t,s){return this.client.isLoggedIn?this.olmMachine?await this.olmMachine?.encryptRoomEvent(e,t,s):new P:new x}async initOlmMachine(e,t,s){this.olmMachine=await p.OlmMachine.initialize(e,t,"cetirizine-crypto",s),console.warn("Init olm done")}async updateTrackedUsers(e){await this.olmMachine?.updateTrackedUsers(e)}async sendIdentifyAndOneTimeKeys(){if(!this.client.isLoggedIn)return new x;if(!this.user.hostname)return new S;if(!this.olmMachine)return new P;if(this.outgoingRequestsBeingProcessed)return;this.outgoingRequestsBeingProcessed=!0;const e=await this.olmMachine.outgoingRequests();for(const t of e)await this.processRequest(t);await this.getMissingSessions(),this.outgoingRequestsBeingProcessed=!1}async shareKeysForRoom(e){if(!this.client.isLoggedIn)return new x;if(!this.user.hostname)return new S;if(!this.olmMachine)return new P;const t=e.getEncryptionSettings();if(t){const s=await this.olmMachine.shareRoomKey(new p.RoomId(e.roomID),e.getJoinedMemberIDs().map(i=>new p.UserId(i)),t);for(const i of s)await this.processRequest(i)}}async getMissingSessions(){if(!this.client.isLoggedIn)return new x;if(!this.user.hostname)return new S;if(!this.olmMachine)return new P;if(this.missingSessionsBeingRequested)return;this.missingSessionsBeingRequested=!0;const t=[...this.client.getRooms()].filter(i=>i.isEncrypted()).map(i=>i.getJoinedMemberIDs().map(r=>new p.UserId(r))).flat(),s=await this.olmMachine?.getMissingSessions(t);s&&await this.processRequest(s),this.missingSessionsBeingRequested=!1}async processRequest(e){if(!this.client.isLoggedIn)return new x;if(!this.user.hostname)return new S;if(!this.olmMachine)return new P;if(e.type===p.RequestType.KeysUpload){const t=e,s=await fetch(`${this.user.hostname}/_matrix/client/v3/keys/upload`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.user.access_token}`},body:t.body});if(!s.ok){s.status===401&&(await this.client.logout(),console.error(s)),console.error("Failed to upload keys",s);return}this.olmMachine.markRequestAsSent(t.id,t.type,await s.text())}else if(e.type===p.RequestType.KeysQuery){const t=e,s=await fetch(`${this.user.hostname}/_matrix/client/v3/keys/query`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.user.access_token}`},body:t.body});if(!s.ok){s.status===401&&(await this.client.logout(),console.error(s)),console.error("Failed to query keys",s);return}this.olmMachine.markRequestAsSent(t.id,t.type,await s.text())}else if(e.type===p.RequestType.KeysClaim){const t=e,s=await fetch(`${this.user.hostname}/_matrix/client/v3/keys/claim`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.user.access_token}`},body:t.body});if(!s.ok){s.status===401&&(await this.client.logout(),console.error(s)),console.error("Failed to claim keys",s);return}this.olmMachine.markRequestAsSent(t.id,t.type,await s.text())}else if(e.type===p.RequestType.ToDevice){const t=e,s=await fetch(`${this.user.hostname}/_matrix/client/v3/sendToDevice/${t.event_type}/${t.txn_id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.user.access_token}`},body:t.body});if(!s.ok){s.status===401&&(await this.client.logout(),console.error(s)),console.error("Failed to send to device",s);return}this.olmMachine.markRequestAsSent(t.id??t.txn_id,t.type,await s.text())}else if(e.type===p.RequestType.SignatureUpload){const t=e,s=await fetch(`${this.user.hostname}/_matrix/client/v3/keys/signatures/upload`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.user.access_token}`},body:t.body});if(!s.ok){s.status===401&&(await this.client.logout(),console.error(s)),console.error("Failed to upload signatures",s);return}this.olmMachine.markRequestAsSent(t.id,t.type,await s.text())}else if(e.type===p.RequestType.RoomMessage){const t=e,s=await fetch(`${this.user.hostname}/_matrix/client/v3/rooms/${t.room_id}/send/${t.event_type}/${t.txn_id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.user.access_token}`},body:t.body});if(!s.ok){s.status===401&&(await this.client.logout(),console.error(s)),console.error("Failed to send message",s);return}this.olmMachine.markRequestAsSent(t.id,t.type,await s.text())}else if(e.type===p.RequestType.KeysBackup){const t=e,s=await fetch(`${this.user.hostname}/_matrix/client/v3/room_keys/keys`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.user.access_token}`},body:t.body});if(!s.ok){s.status===401&&(await this.client.logout(),console.error(s)),console.error("Failed to backup keys",s);return}this.olmMachine.markRequestAsSent(t.id,t.type,await s.text())}}logoutE2ee(){this.missingSessionsBeingRequested=!1,this.outgoingRequestsBeingProcessed=!1}}class Le{constructor(e){this.client=e,this.e2ee=new Te(this.client,this)}access_token;device_id;mxid;hostname;slidingSyncHostname;e2ee;async logout(){if(!this.mxid)return new x;if(!this.access_token)return new x;if(!this.hostname)return new S;const e=await fetch(`${this.hostname}/_matrix/client/v3/logout`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.access_token}`}});if(!e.ok)return new xe(e);this.access_token=void 0,this.device_id=void 0,this.slidingSyncHostname=void 0}async setHostname(e){if(!e.startsWith("https://"))return new Ie;this.client.database||await this.client.createDatabase();const t=this.client.database?.transaction("loginInfo","readwrite");await t?.store.put({userId:this.mxid,hostname:e,slidingSyncHostname:this.slidingSyncHostname,access_token:this.access_token,device_id:this.device_id}),await t?.done,this.hostname=e}async getLoginFlows(){if(!this.hostname)return new S;const e=await fetch(`${this.hostname}/_matrix/client/v3/login`);return e.ok?await e.json():new X(e)}async getWellKnown(){if(!this.hostname)return new S;const e=await fetch(`${this.hostname}/.well-known/matrix/client`);return e.ok?await e.json():new X(e)}async passwordLogin(e,t,s=5){if(this.client.database||await this.client.createDatabase(),!e)return new Se;if(!t)return new Re;this.mxid=e,await this.setHostname(`https://${e.split(":")[1]}`);try{const a=await this.getWellKnown();if(a instanceof v)return a;if(a["m.homeserver"]?.base_url&&await this.setHostname(a["m.homeserver"].base_url),a["org.matrix.msc3575.proxy"]?.url){const u=this.client.database?.transaction("loginInfo","readwrite");await u?.store.put({userId:this.mxid,hostname:this.hostname,slidingSyncHostname:a["org.matrix.msc3575.proxy"].url,access_token:this.access_token,device_id:this.device_id}),await u?.done,this.slidingSyncHostname=a["org.matrix.msc3575.proxy"].url}else return new De}catch(a){console.warn(`No well-known found for ${this.hostname}:
${a}`)}const i=await this.getLoginFlows();if(i instanceof v)return i;if((i.flows.filter(a=>a.type==="m.login.password")?.length||0)==0)return new ke;const r=await fetch(`${this.hostname}/_matrix/client/v3/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"m.login.password",identifier:{type:"m.id.user",user:e},user:e,password:t})});if(!r.ok)return new Y(r);const o=await r.json();if(Pe(o))return new Y(void 0,o);if(ve(o)&&(console.error(`Rate limited. Retrying in ${o.retry_after_ms}ms. ${s} tries left.`),await this.passwordLogin(e,t,s-1)),Me(o)){const a=this.client.database?.transaction("loginInfo","readwrite");await a?.store.put({userId:o.user_id,hostname:this.hostname,slidingSyncHostname:this.slidingSyncHostname,access_token:o.access_token,device_id:o.device_id}),await a?.done,this.access_token=o.access_token,this.device_id=o.device_id,this.mxid=o.user_id,await this.e2ee.initOlmMachine(new p.UserId(this.mxid),new p.DeviceId(this.device_id))}}}function Me(n){return n.access_token!==void 0}function Pe(n){return n.errcode!==void 0}var V={exports:{}},M=typeof Reflect=="object"?Reflect:null,G=M&&typeof M.apply=="function"?M.apply:function(e,t,s){return Function.prototype.apply.call(e,t,s)},N;M&&typeof M.ownKeys=="function"?N=M.ownKeys:Object.getOwnPropertySymbols?N=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:N=function(e){return Object.getOwnPropertyNames(e)};function Ce(n){console&&console.warn&&console.warn(n)}var ae=Number.isNaN||function(e){return e!==e};function l(){l.init.call(this)}V.exports=l;V.exports.once=Ae;l.EventEmitter=l;l.prototype._events=void 0;l.prototype._eventsCount=0;l.prototype._maxListeners=void 0;var Q=10;function A(n){if(typeof n!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n)}Object.defineProperty(l,"defaultMaxListeners",{enumerable:!0,get:function(){return Q},set:function(n){if(typeof n!="number"||n<0||ae(n))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+n+".");Q=n}});l.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};l.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||ae(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function ce(n){return n._maxListeners===void 0?l.defaultMaxListeners:n._maxListeners}l.prototype.getMaxListeners=function(){return ce(this)};l.prototype.emit=function(e){for(var t=[],s=1;s<arguments.length;s++)t.push(arguments[s]);var i=e==="error",r=this._events;if(r!==void 0)i=i&&r.error===void 0;else if(!i)return!1;if(i){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var u=r[e];if(u===void 0)return!1;if(typeof u=="function")G(u,this,t);else for(var m=u.length,c=le(u,m),s=0;s<m;++s)G(c[s],this,t);return!0};function ue(n,e,t,s){var i,r,o;if(A(t),r=n._events,r===void 0?(r=n._events=Object.create(null),n._eventsCount=0):(r.newListener!==void 0&&(n.emit("newListener",e,t.listener?t.listener:t),r=n._events),o=r[e]),o===void 0)o=r[e]=t,++n._eventsCount;else if(typeof o=="function"?o=r[e]=s?[t,o]:[o,t]:s?o.unshift(t):o.push(t),i=ce(n),i>0&&o.length>i&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=n,a.type=e,a.count=o.length,Ce(a)}return n}l.prototype.addListener=function(e,t){return ue(this,e,t,!1)};l.prototype.on=l.prototype.addListener;l.prototype.prependListener=function(e,t){return ue(this,e,t,!0)};function je(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function de(n,e,t){var s={fired:!1,wrapFn:void 0,target:n,type:e,listener:t},i=je.bind(s);return i.listener=t,s.wrapFn=i,i}l.prototype.once=function(e,t){return A(t),this.on(e,de(this,e,t)),this};l.prototype.prependOnceListener=function(e,t){return A(t),this.prependListener(e,de(this,e,t)),this};l.prototype.removeListener=function(e,t){var s,i,r,o,a;if(A(t),i=this._events,i===void 0)return this;if(s=i[e],s===void 0)return this;if(s===t||s.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,s.listener||t));else if(typeof s!="function"){for(r=-1,o=s.length-1;o>=0;o--)if(s[o]===t||s[o].listener===t){a=s[o].listener,r=o;break}if(r<0)return this;r===0?s.shift():Oe(s,r),s.length===1&&(i[e]=s[0]),i.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this};l.prototype.off=l.prototype.removeListener;l.prototype.removeAllListeners=function(e){var t,s,i;if(s=this._events,s===void 0)return this;if(s.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):s[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete s[e]),this;if(arguments.length===0){var r=Object.keys(s),o;for(i=0;i<r.length;++i)o=r[i],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=s[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this};function he(n,e,t){var s=n._events;if(s===void 0)return[];var i=s[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?Ne(i):le(i,i.length)}l.prototype.listeners=function(e){return he(this,e,!0)};l.prototype.rawListeners=function(e){return he(this,e,!1)};l.listenerCount=function(n,e){return typeof n.listenerCount=="function"?n.listenerCount(e):me.call(n,e)};l.prototype.listenerCount=me;function me(n){var e=this._events;if(e!==void 0){var t=e[n];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}l.prototype.eventNames=function(){return this._eventsCount>0?N(this._events):[]};function le(n,e){for(var t=new Array(e),s=0;s<e;++s)t[s]=n[s];return t}function Oe(n,e){for(;e+1<n.length;e++)n[e]=n[e+1];n.pop()}function Ne(n){for(var e=new Array(n.length),t=0;t<e.length;++t)e[t]=n[t].listener||n[t];return e}function Ae(n,e){return new Promise(function(t,s){function i(o){n.removeListener(e,r),s(o)}function r(){typeof n.removeListener=="function"&&n.removeListener("error",i),t([].slice.call(arguments))}fe(n,e,r,{once:!0}),e!=="error"&&$e(n,i,{once:!0})})}function $e(n,e,t){typeof n.on=="function"&&fe(n,"error",e,t)}function fe(n,e,t,s){if(typeof n.on=="function")s.once?n.once(e,t):n.on(e,t);else if(typeof n.addEventListener=="function")n.addEventListener(e,function i(r){s.once&&n.removeEventListener(e,i),t(r)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}var Be=V.exports;const J=Ee(Be);function mt(n){return n.type==="m.room.message"&&n.content.msgtype==="m.text"}function lt(n){return n.type==="m.room.message"&&n.content.msgtype==="m.notice"}function ft(n){return n.type==="m.room.message"&&n.content.msgtype==="m.image"}function pt(n){return n.type==="m.room.message"&&n.content.msgtype==="m.video"}function gt(n){return n.type==="m.room.message"&&n.content.msgtype==="m.audio"}function ee(n){return n.state_key!==void 0}function te(n){return n.type==="m.room.member"}function Ue(n){return n.type==="m.room.create"}function qe(n){return n.type==="m.room.avatar"}function He(n){return n.type==="m.space.child"}function Fe(n){return n.type==="m.space.parent"}function Ve(n){return n.type==="m.room.topic"}var pe=(n=>(n[n.Online=0]="Online",n[n.Offline=1]="Offline",n[n.Unknown=2]="Unknown",n))(pe||{});class L extends J{constructor(e,t,s,i){super(),this.roomID=e,this.hostname=t,this.client=s,this.e2ee=i}events=[];pendingEvents=[];stateEvents=[];name;notification_count=0;notification_highlight_count=0;joined_count=0;invited_count=0;is_dm=!1;has_all_users=!1;windowPos={};addEvents(e){console.log("Adding events"),e.forEach(t=>{t.unsigned?.transaction_id&&(this.pendingEvents=this.pendingEvents.filter(s=>s.unsigned?.transaction_id!==t.unsigned?.transaction_id)),this.events.push(t)}),this.emit("events",this.getEvents())}addStateEvents(e){e.forEach(t=>{const s=this.stateEvents.findIndex(i=>i.state_key===t.state_key&&i.type===t.type);s!==-1?this.stateEvents[s]=t:this.stateEvents.push(t)}),this.emit("state_events",this.stateEvents)}getStateEvents(){return this.stateEvents}isTombstoned(){let e=!1;return this.stateEvents.forEach(t=>{t.type==="m.room.tombstone"&&(e=!0)}),e}getAvatarURL(){let e;return this.stateEvents.forEach(t=>{if(qe(t)){const s=t.content.url;s?.startsWith("mxc://")&&(e=this.client.convertMXC(s))}}),e}isSpace(){let e=!1;return this.stateEvents.forEach(t=>{Ue(t)&&(e=t.content.type==="m.space")}),e}setName(e){this.name=e}getName(){return this.name?this.name:this.roomID}getTopic(){let e;return this.stateEvents.forEach(t=>{Ve(t)&&(e=t.content.topic)}),e}setNotificationCount(e){this.notification_count=e}getNotificationCount(){return this.notification_count}setNotificationHighlightCount(e){this.notification_highlight_count=e}getNotificationHighlightCount(){return this.notification_highlight_count}setJoinedCount(e){this.joined_count=e}getJoinedCount(){return this.joined_count}setInvitedCount(e){this.invited_count=e}getInvitedCount(){return this.invited_count}getSpaceChildrenIDs(){const e=[];return this.stateEvents.forEach(t=>{He(t)&&e.push(t.state_key)}),e}getSpaceParentIDs(){const e=[];return this.stateEvents.forEach(t=>{Fe(t)&&e.push({roomID:t.state_key,canonical:t.content.canonical||!1})}),e}setDM(e){this.is_dm=e}isDM(){return this.is_dm}get presence(){return pe.Unknown}getEvents(){return[...this.events,...this.pendingEvents]}getPureEvents(){return this.events}getMemberName(e){let t=e;return this.stateEvents.forEach(s=>{s.type==="m.room.member"&&s.state_key===e&&s.content.membership=="join"&&(t=s.content.displayname)}),t}getMemberAvatar(e,t=64){let s;return this.stateEvents.forEach(i=>{if(i.type==="m.room.member"&&i.state_key===e&&i.content.membership=="join"){const r=i.content.avatar_url;r?.startsWith("mxc://")&&(s=this.client.convertMXC(r,t))}}),s}isBot(e){let t=!1;return this.stateEvents.forEach(s=>{s.type==="m.room.member"&&s.state_key===e&&s.content.membership=="join"&&(s.content["dev.nordgedanken.msc4015"]&&(t=s.content["dev.nordgedanken.msc4015"]),s.content.bot&&(t=s.content.bot))}),t}async joinedMembers(){if(!this.has_all_users){if(!this.client.hostname)return new S;if(!this.client.accessToken)return new oe;const e=await fetch(`${this.client.hostname}/_matrix/client/v3/rooms/${this.roomID}/members`,{headers:{Authorization:`Bearer ${this.client.accessToken}`}});if(!e.ok)return e.status===404||e.status===403?this.stateEvents.filter(s=>{if(te(s)&&s.content.membership=="join")return s}):new re(e);const t=await e.json();this.stateEvents=[...this.stateEvents,...t.chunk],this.has_all_users=!0}return this.stateEvents.filter(e=>{if(te(e)&&e.content.membership=="join")return e})}isEncrypted(){let e=!1;return this.stateEvents.forEach(t=>{t.type==="m.room.encryption"&&t.content.algorithm==="m.megolm.v1.aes-sha2"&&t.state_key===""&&(e=!0,this.has_all_users=!0)}),e}deletePendingByEventID(e){this.pendingEvents=this.pendingEvents.filter(t=>t.eventID!==e),this.emit("events",this.getEvents())}async sendHtmlMessage(e,t,s){const i=Date.now().toString(),r={type:"m.room.message",unsigned:{transaction_id:i},origin_server_ts:i,sender:this.client.mxid,event_id:i,content:{msgtype:"m.text",body:t,format:"org.matrix.custom.html",formatted_body:e}};if(this.pendingEvents.push(r),this.emit("events",this.getEvents()),s(),this.isEncrypted()){console.log("Sending encrypted message"),await this.e2ee.getMissingSessions(),await this.e2ee.shareKeysForRoom(this);const o=await this.e2ee.encryptRoomEvent(new p.RoomId(this.roomID),"m.room.message",JSON.stringify(r.content)),a=await fetch(`${this.hostname}/_matrix/client/v3/rooms/${this.roomID}/send/m.room.encrypted/${r.unsigned?.transaction_id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.client.accessToken}`},body:o});if(!a.ok)return this.deletePendingByEventID(r.event_id),new O(a);const u=await a.json();return this.deletePendingByEventID(r.event_id),u.event_id}else{const o=await fetch(`${this.hostname}/_matrix/client/v3/rooms/${this.roomID}/send/m.room.message/${r.unsigned?.transaction_id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.client.accessToken}`},body:JSON.stringify(r.content)});if(!o.ok)return this.deletePendingByEventID(r.event_id),new O(o);const a=await o.json();return this.deletePendingByEventID(r.event_id),a.event_id}}async sendTextMessage(e,t){const s=Date.now().toString(),i={type:"m.room.message",unsigned:{transaction_id:s},origin_server_ts:s,event_id:s,sender:this.client.mxid,content:{msgtype:"m.text",body:e}};if(this.pendingEvents.push(i),this.emit("events",this.getEvents()),t(),this.isEncrypted()){console.log("Sending encrypted message2"),await this.e2ee.getMissingSessions(),await this.e2ee.shareKeysForRoom(this);const r=await this.e2ee.encryptRoomEvent(new p.RoomId(this.roomID),"m.room.message",JSON.stringify(i.content)),o=await fetch(`${this.hostname}/_matrix/client/v3/rooms/${this.roomID}/send/m.room.encrypted/${i.unsigned?.transaction_id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.client.accessToken}`},body:r});if(!o.ok)return this.deletePendingByEventID(i.event_id),new O(o);const a=await o.json();return this.deletePendingByEventID(i.event_id),a.event_id}else{const r=await fetch(`${this.hostname}/_matrix/client/v3/rooms/${this.roomID}/send/m.room.message/${i.unsigned?.transaction_id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.client.accessToken}`},body:JSON.stringify(i.content)});if(!r.ok)return this.deletePendingByEventID(i.event_id),new O(r);const o=await r.json();return this.deletePendingByEventID(i.event_id),o.event_id}}getJoinedMemberIDs(){const e=[];return this.stateEvents.forEach(t=>{t.type==="m.room.member"&&t.content.membership==="join"&&e.push(t.state_key)}),e}getEncryptionSettings(){let e;return this.stateEvents.forEach(t=>{t.type==="m.room.encryption"&&t.state_key===""&&(e||(e=new p.EncryptionSettings),e.algorithm=t.content.algorithm==="m.megolm.v1.aes-sha2"?p.EncryptionAlgorithm.MegolmV1AesSha2:p.EncryptionAlgorithm.OlmV1Curve25519AesSha2,t.content.rotation_period_ms&&(e.rotationPeriod=BigInt(t.content.rotation_period_ms)),t.content.rotation_period_msgs&&(e.rotationPeriodMessages=BigInt(t.content.rotation_period_msgs))),t.type==="m.room.history_visibility"&&t.state_key===""&&(e||(e=new p.EncryptionSettings),e.historyVisibility=t.content.history_visibility)}),e&&(e.onlyAllowTrustedDevices=!1),e}isJoined(){let e=!1;return this.stateEvents.forEach(t=>{t.type==="m.room.member"&&t.state_key===this.client.mxid&&(e=t.content.membership==="join")}),e}}const Je=(n,e)=>e.some(t=>n instanceof t);let ne,se;function Ke(){return ne||(ne=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function We(){return se||(se=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const ge=new WeakMap,H=new WeakMap,ye=new WeakMap,B=new WeakMap,K=new WeakMap;function ze(n){const e=new Promise((t,s)=>{const i=()=>{n.removeEventListener("success",r),n.removeEventListener("error",o)},r=()=>{t(D(n.result)),i()},o=()=>{s(n.error),i()};n.addEventListener("success",r),n.addEventListener("error",o)});return e.then(t=>{t instanceof IDBCursor&&ge.set(t,n)}).catch(()=>{}),K.set(e,n),e}function Xe(n){if(H.has(n))return;const e=new Promise((t,s)=>{const i=()=>{n.removeEventListener("complete",r),n.removeEventListener("error",o),n.removeEventListener("abort",o)},r=()=>{t(),i()},o=()=>{s(n.error||new DOMException("AbortError","AbortError")),i()};n.addEventListener("complete",r),n.addEventListener("error",o),n.addEventListener("abort",o)});H.set(n,e)}let F={get(n,e,t){if(n instanceof IDBTransaction){if(e==="done")return H.get(n);if(e==="objectStoreNames")return n.objectStoreNames||ye.get(n);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return D(n[e])},set(n,e,t){return n[e]=t,!0},has(n,e){return n instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in n}};function Ye(n){F=n(F)}function Ze(n){return n===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){const s=n.call(U(this),e,...t);return ye.set(s,e.sort?e.sort():[e]),D(s)}:We().includes(n)?function(...e){return n.apply(U(this),e),D(ge.get(this))}:function(...e){return D(n.apply(U(this),e))}}function Ge(n){return typeof n=="function"?Ze(n):(n instanceof IDBTransaction&&Xe(n),Je(n,Ke())?new Proxy(n,F):n)}function D(n){if(n instanceof IDBRequest)return ze(n);if(B.has(n))return B.get(n);const e=Ge(n);return e!==n&&(B.set(n,e),K.set(e,n)),e}const U=n=>K.get(n);function Qe(n,e,{blocked:t,upgrade:s,blocking:i,terminated:r}={}){const o=indexedDB.open(n,e),a=D(o);return s&&o.addEventListener("upgradeneeded",u=>{s(D(o.result),u.oldVersion,u.newVersion,D(o.transaction),u)}),t&&o.addEventListener("blocked",u=>t(u.oldVersion,u.newVersion,u)),a.then(u=>{r&&u.addEventListener("close",()=>r()),i&&u.addEventListener("versionchange",m=>i(m.oldVersion,m.newVersion,m))}).catch(()=>{}),a}function et(n,{blocked:e}={}){const t=indexedDB.deleteDatabase(n);return e&&t.addEventListener("blocked",s=>e(s.oldVersion,s)),D(t).then(()=>{})}const tt=["get","getKey","getAll","getAllKeys","count"],nt=["put","add","delete","clear"],q=new Map;function ie(n,e){if(!(n instanceof IDBDatabase&&!(e in n)&&typeof e=="string"))return;if(q.get(e))return q.get(e);const t=e.replace(/FromIndex$/,""),s=e!==t,i=nt.includes(t);if(!(t in(s?IDBIndex:IDBObjectStore).prototype)||!(i||tt.includes(t)))return;const r=async function(o,...a){const u=this.transaction(o,i?"readwrite":"readonly");let m=u.store;return s&&(m=m.index(a.shift())),(await Promise.all([m[t](...a),i&&u.done]))[0]};return q.set(e,r),r}Ye(n=>({...n,get:(e,t,s)=>ie(e,t)||n.get(e,t,s),has:(e,t)=>!!ie(e,t)||n.has(e,t)}));function st(n){return n.op==="SYNC"}function it(n){return n.op==="INSERT"}function ot(n){return n.op==="INVALIDATE"}function rt(n){return n.op==="DELETE"}class at extends J{constructor(e,t){super(),this.client=e,this.user=t}syncing=!1;syncPos;initialSync=!0;lastRanges;lastTxnID;to_device_since;mustUpdateTxnID=!0;rooms=new Set;abortController=new AbortController;applyStoredSyncInfo(e){this.syncPos=e.syncPos,this.initialSync=e.initialSync,this.lastRanges=e.lastRanges,this.lastTxnID=e.lastTxnID,this.to_device_since=e.to_device_since}logout(){this.stopSync(),this.abortController.abort(),this.rooms=new Set,this.initialSync=!0,this.syncPos=void 0,this.to_device_since=void 0}resetAbortController(){this.abortController=new AbortController}async startSync(){if(globalThis.IS_STORYBOOK&&await new Promise(t=>setTimeout(t,5e3)),!this.client.isLoggedIn)return new x;if(this.client.database||await this.client.createDatabase(),this.syncing)return;this.syncing=!0;let e=0;for(;this.syncing;)try{await this.sync()}catch(t){if(console.error(`Error: ${t}`),e>5){console.error("Too many retries, giving up"),this.stopSync();return}await new Promise(s=>setTimeout(s,3e4)),console.warn("Retrying sync"),e++}}stopSync(){this.syncing=!1}isIndexInRange(e,t){for(const s of t)if(s[0]<e&&e<=s[1])return!0;return!1}shiftRight(e,t,s,i){for(let r=s-1;r>i-1;r--)if(this.isIndexInRange(r,t)){const o=[...this.rooms].find(a=>a.windowPos[e]===r+1);o&&(o.windowPos[e]=r)}}shiftLeft(e,t,s,i){for(let r=i+1;r<s+1;r++)if(this.isIndexInRange(r,t)){const o=[...this.rooms].find(a=>a.windowPos[e]===r-1);o&&(o.windowPos[e]=r)}}async removeEntry(e,t,s){let i=-1;const r=[...this.rooms].map(o=>o.windowPos[e]);for(const o in r)Number(o)>i&&(i=Number(o));i<0||s>i||this.shiftLeft(e,t,i,s)}addEntry(e,t,s){let i=-1;const r=[...this.rooms].map(o=>o.windowPos[e]);for(const o in r)Number(o)>i&&(i=Number(o));i<0||s>i||this.shiftRight(e,t,i+1,s)}async sync(){if(!this.client.isLoggedIn)return new x;if(!this.user.slidingSyncHostname)return new S;Promise.all([this.user.e2ee.sendIdentifyAndOneTimeKeys()]).catch(c=>{console.error("Error sending identify and one time keys",c)});const e={overview:[[0,20]],spaces:[[0,20]]};for(const c of this.client.spaceOpen)c!=="other"&&c!=="dm"&&(e[c]=[[0,20]]);let t=1,s=10;if(!this.initialSync){for(const c in e){t=10,s=50;let _=new Set([...this.rooms].filter(d=>this.client.roomsInView.includes(d.roomID)).map(d=>d.windowPos[c]).sort().filter(d=>d!=null));if(this.client.getSpaces().find(d=>d.roomID===c)&&(_=new Set([...this.rooms].filter(d=>this.client.spacesInView.includes(d.roomID)).map(d=>d.windowPos[c]).sort().filter(d=>d!=null))),_.size!==0){const d=Math.min(..._),k=Math.max(..._);e[c]=[[Math.max(d-10,0),k+10]]}}e.e2ee=e.overview}this.lastRanges&&Object.entries(e).toString()!==Object.entries(this.lastRanges).toString()&&(console.log("Ranges changed, resetting sync txn_id",e),this.lastRanges=e,this.lastTxnID=Date.now().toString()),this.lastRanges||(this.lastRanges=e,this.lastTxnID=Date.now().toString()),this.mustUpdateTxnID&&(this.lastTxnID=Date.now().toString(),this.mustUpdateTxnID=!1);let i=`${this.user.slidingSyncHostname}/_matrix/client/unstable/org.matrix.msc3575/sync?timeout=5000`;this.syncPos&&(i=`${this.user.slidingSyncHostname}/_matrix/client/unstable/org.matrix.msc3575/sync?timeout=5000&pos=${this.syncPos}`);const r={txn_id:this.lastTxnID,lists:{spaces:{ranges:this.lastRanges.spaces,sort:["by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.tombstone",""],["m.room.avatar","*"],["m.room.topic","*"],["m.room.member","$LAZY"],["m.room.encryption",""],["m.room.history_visibility",""]],timeline_limit:0,filters:{room_types:["m.space"]}},overview:{ranges:this.lastRanges.overview,sort:["by_notification_level","by_recency","by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.tombstone",""],["m.room.avatar","*"],["m.room.topic","*"],["m.room.member","$LAZY"],["m.room.encryption",""],["m.room.history_visibility",""]],timeline_limit:t,filters:{not_room_types:["m.space"]}},e2ee:{ranges:this.lastRanges.overview,sort:["by_notification_level","by_recency","by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.tombstone",""],["m.room.avatar","*"],["m.room.topic","*"],["m.room.member","*"],["m.room.encryption",""],["m.room.history_visibility",""]],timeline_limit:t,filters:{not_room_types:["m.space"],is_encrypted:!0}}},bump_event_types:["m.room.message","m.room.encrypted"],extensions:{e2ee:{enabled:!0},to_device:{enabled:!0,since:this.to_device_since},typing:{enabled:!0,lists:["overview","e2ee"]},receipts:{enabled:!0,lists:["overview","e2ee"]}}};for(const c of this.client.spaceOpen)c!=="other"&&c!=="dm"&&(r.lists||(r.lists={}),r.lists[c]={slow_get_all_rooms:!0,ranges:this.lastRanges[c],sort:["by_notification_level","by_recency","by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.tombstone",""],["m.room.avatar","*"],["m.room.topic","*"],["m.room.member","$LAZY"],["m.room.encryption",""],["m.room.history_visibility",""]],timeline_limit:t,filters:{spaces:[c]}});this.client.currentRoom&&(r.room_subscriptions={},r.room_subscriptions[this.client.currentRoom]={sort:["by_notification_level","by_recency","by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.tombstone",""],["m.room.avatar","*"],["m.room.topic","*"],["m.room.member","$LAZY"],["m.room.encryption",""],["m.room.history_visibility",""]],timeline_limit:s,filters:{}});const o=await fetch(i,{method:"POST",signal:this.abortController.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.user.access_token}`},body:JSON.stringify(r)});if(!o.ok)if(o.status===400){if((await o.json()).errcode==="M_UNKNOWN_POS"){this.syncPos=void 0;const c=this.client.database?.transaction("syncInfo","readwrite");await c?.store.put({userId:this.user.mxid,syncPos:this.syncPos,initialSync:this.initialSync,lastRanges:this.lastRanges,lastTxnID:this.lastTxnID}),await c?.done}return}else return o.status===401?(await this.logout(),new Z(o)):new Z(o);const a=await o.json();this.syncPos=a.pos,a.extensions?.to_device&&(await this.user.e2ee.receiveSyncData(JSON.stringify(a.extensions.to_device.events||[]),new p.DeviceLists(a.extensions.e2ee?.device_lists?a.extensions.e2ee?.device_lists?.changed?.map(c=>new p.UserId(c)):[],a.extensions.e2ee?.device_lists?a.extensions.e2ee?.device_lists?.left?.map(c=>new p.UserId(c)):[]),new Map(Object.entries(a.extensions.e2ee?.device_one_time_keys_count||[])),new Set(a.extensions.e2ee?.device_unused_fallback_key_types)),this.to_device_since=a.extensions.to_device.next_batch),await this.user.e2ee.sendIdentifyAndOneTimeKeys();const u=this.client.database?.transaction("syncInfo","readwrite");await u?.store.put({userId:this.user.mxid,syncPos:this.syncPos,initialSync:this.initialSync,lastRanges:this.lastRanges,lastTxnID:this.lastTxnID,to_device_since:this.to_device_since}),await u?.done;let m=-1;for(const c in a.lists){const _=a.lists[c];if(_.ops){for(const d of _.ops)if(st(d)){const k=this.client.database?.transaction("rooms","readwrite");for(let I=d.range[0];I<=d.range[1];I++){const y=d.room_ids[I-d.range[0]];if(!y)break;const T=[...this.rooms].find(g=>g.roomID===y);if(T){T.windowPos[c]=I;continue}const w=new L(y,this.user.hostname,this.client,this.user.e2ee);w.setName(y),w.windowPos[c]=I,this.rooms.add(w),await k?.store.put({windowPos:w.windowPos,roomID:w.roomID,name:w.getName(),notification_count:w.getNotificationCount(),highlight_count:w.getNotificationHighlightCount(),joined_count:w.getJoinedCount(),invited_count:w.getInvitedCount(),avatarUrl:w.getAvatarURL(),isSpace:w.isSpace(),isDM:w.isDM(),stateEvents:w.getStateEvents(),events:w.getEvents()})}await k?.done}else if(it(d)){console.log("Got INSERT OP",d),[...this.rooms].find(g=>g.windowPos[c]===d.index)&&(m<0?this.addEntry(c,this.lastRanges[c],d.index):m>d.index?this.shiftRight(c,this.lastRanges[c],m,d.index):m<d.index&&this.shiftLeft(c,this.lastRanges[c],d.index,m)),m=-1;const I=this.client.database?.transaction("rooms","readwrite"),y=[...this.rooms].find(g=>g.roomID===d.room_id);if(y)y.windowPos[c]=d.index,await I?.store.put({windowPos:y.windowPos,roomID:y.roomID,name:y.getName(),notification_count:y.getNotificationCount(),highlight_count:y.getNotificationHighlightCount(),joined_count:y.getJoinedCount(),invited_count:y.getInvitedCount(),avatarUrl:y.getAvatarURL(),isSpace:y.isSpace(),isDM:y.isDM(),stateEvents:y.getStateEvents(),events:y.getEvents()});else{const g=await I?.store.get(d.room_id);let f=new L(d.room_id,this.user.hostname,this.client,this.user.e2ee);f.setName(d.room_id),f.windowPos[c]=d.index,g&&(console.warn("Room in db but not in obj list.",d.room_id,"Updating obj list."),f=new L(d.room_id,this.user.hostname,this.client,this.user.e2ee),f.setName(g.name),f.setNotificationCount(g.notification_count),f.setNotificationHighlightCount(g.highlight_count),f.setJoinedCount(g.joined_count),f.setInvitedCount(g.invited_count),f.setDM(g.isDM||!1)),this.rooms.add(f),await I?.store.put({windowPos:f.windowPos,roomID:f.roomID,name:f.getName(),notification_count:f.getNotificationCount(),highlight_count:f.getNotificationHighlightCount(),joined_count:f.getJoinedCount(),invited_count:f.getInvitedCount(),avatarUrl:f.getAvatarURL(),isSpace:f.isSpace(),isDM:f.isDM(),stateEvents:f.getStateEvents(),events:f.getEvents()})}const T=[...this.rooms].map(g=>g.roomID),w=T.filter((g,f)=>T.indexOf(g)!=f);w.length>0&&console.error("Duplicates found",w),await I?.done}else rt(d)?(console.log("Got DELETE OP",d),m!==-1&&await this.removeEntry(c,this.lastRanges[c],m),m=d.index):ot(d);m!==-1&&await this.removeEntry(c,this.lastRanges[c],m)}}for(const c in a.rooms){const _=a.rooms[c],d=_.name,k=_.notification_count,I=_.highlight_count,y=_.joined_count,T=_.invited_count,w=_.timeline,g=w?.filter(E=>ee(E)).map(E=>E),f=w?.filter(E=>!ee(E)).map(E=>E),C=_.required_state,W=_.is_dm;let h=[...this.rooms].find(E=>E.roomID===c);if(!h){console.warn("Could not find roomObj for roomID:",c);const E=this.client.database?.transaction("rooms","readwrite"),b=await E?.store.get(c);await E?.done,b?(console.warn("Room in db but not in obj list.",c,"Updating obj list."),h=new L(c,this.user.hostname,this.client,this.user.e2ee),h.setName(b.name),h.setNotificationCount(b.notification_count),h.setNotificationHighlightCount(b.highlight_count),h.setJoinedCount(b.joined_count),h.setInvitedCount(b.invited_count),h.setDM(b.isDM||!1),b.events&&h.addEvents(b.events),b.stateEvents&&h.addStateEvents(b.stateEvents),h.windowPos=b.windowPos):(console.warn("Could not find room in db. Creating new one."),h=new L(c,this.user.hostname,this.client,this.user.e2ee),this.rooms.add(h))}if(d&&h.setName(d),h.setNotificationCount(k),h.setNotificationHighlightCount(I),h.setJoinedCount(y),h.setInvitedCount(T),f&&h.addEvents(f),C&&h.addStateEvents(C),g&&h.addStateEvents(g),(C||g)&&h.isEncrypted()&&h.isJoined()){const b=[...C||[],...g||[]].filter(j=>j.type==="m.room.member"&&j.content.membership==="join").map(j=>new p.UserId(j.state_key));await this.user.e2ee.updateTrackedUsers(b)}W&&h.setDM(W);const z=this.client.database?.transaction("rooms","readwrite");await z?.store.put({windowPos:h.windowPos,roomID:h.roomID,name:h.getName(),notification_count:h.getNotificationCount(),highlight_count:h.getNotificationHighlightCount(),joined_count:h.getJoinedCount(),invited_count:h.getInvitedCount(),events:h.getPureEvents(),stateEvents:h.getStateEvents(),avatarUrl:h.getAvatarURL(),isSpace:h.isSpace(),isDM:h.isDM()}),await z?.done}this.initialSync&&(this.initialSync=!1,console.log("initialSyncComplete")),a.rooms&&Object.keys(a.rooms).length>0&&this.emit("rooms",this.rooms)}}class we extends J{static _instance;roomsInView=[];spacesInView=[];spaceOpen=[];database;profileInfo;currentRoom;user=new Le(this);sync=new at(this,this.user);get accessToken(){return this.user.access_token}get hostname(){return this.user.hostname}get isLoggedIn(){return this.user.access_token!==void 0}get mxid(){return this.user.mxid}onSyncRooms(e){this.emit("rooms",e)}async passwordLogin(e,t){const s=await this.user.passwordLogin(e,t);if(s instanceof v)return s;this.sync.on("rooms",i=>this.onSyncRooms(i))}convertMXC(e,t){return t?`${this.user.hostname}/_matrix/media/v3/thumbnail/${e.substring(6)}?width=${t}&height=${t}&method=scale`:`${this.user.hostname}/_matrix/media/v3/download/${e.substring(6)}`}setCurrentRoom(e){e!==this.currentRoom&&(this.currentRoom=e,console.log("Current room changed to",e,"restarting sync"),this.sync.mustUpdateTxnID=!0)}static async Instance(){let e=this._instance;if(!e){e=this._instance=new this,e.database||await e.createDatabase();const t=e.database?.transaction("loginInfo","readonly"),s=await t?.store.getAll();if(await t?.done,s&&s.length>0){e.user.mxid=s[0].userId,e.user.hostname=s[0].hostname,e.user.slidingSyncHostname=s[0].slidingSyncHostname,e.user.access_token=s[0].access_token,e.user.device_id=s[0].device_id,e.profileInfo={avatar_url:s[0].avatarUrl,displayname:s[0].displayName},e.user.mxid&&e.user.hostname&&e.user.access_token&&e.user.device_id&&await e.user.e2ee.initOlmMachine(new p.UserId(e.user.mxid),new p.DeviceId(e.user.device_id));const i=e.database?.transaction("syncInfo","readonly"),r=await i?.store.get(e.user.mxid);await i?.done,r&&e.sync.applyStoredSyncInfo(r);const o=e.database?.transaction("rooms","readonly"),a=await o?.store.getAll();await o?.done,a&&(e.sync.rooms=new Set(a.map(u=>{const m=new L(u.roomID,e.user.hostname,e,e.user.e2ee);return m.windowPos=u.windowPos,m.setInvitedCount(u.invited_count),m.setJoinedCount(u.joined_count),m.setNotificationCount(u.notification_count),m.setNotificationHighlightCount(u.highlight_count),m.setName(u.name),u.events&&m.addEvents(u.events),u.stateEvents&&m.addStateEvents(u.stateEvents),u.isDM&&m.setDM(u.isDM),m})),e.emit("rooms",e.sync.rooms))}e.setMaxListeners(60),e.sync.on("rooms",i=>e.onSyncRooms(i))}return e}async createDatabase(){this.database=await Qe("matrix",4,{upgrade(e,t){t<1&&(e.objectStoreNames.contains("rooms")&&e.deleteObjectStore("rooms"),e.objectStoreNames.contains("syncInfo")&&e.deleteObjectStore("syncInfo"),e.createObjectStore("rooms",{keyPath:"roomID"}),e.createObjectStore("loginInfo",{keyPath:"userId"}),e.createObjectStore("syncInfo",{keyPath:"userId"}))}})}async decryptRoomEvent(e,t){return this.isLoggedIn?this.user.e2ee.decryptRoomEvent(e,t):new x}async logout(){this.sync.logout(),this.sync.off("rooms",this.onSyncRooms);const e=await this.user.logout();if(e instanceof v)return e;if(this.user.e2ee.logoutE2ee(),this.user.mxid){const s=this.database?.transaction("syncInfo","readwrite");await s?.store.delete(this.user.mxid),await s?.done;const i=this.database?.transaction("loginInfo","readwrite");await i?.store.delete(this.user.mxid),await i?.done}const t=this.database?.transaction("rooms","readwrite");await t?.store.clear(),await t?.done,this.user.mxid=void 0,this.sync.resetAbortController(),await et("cetirizine-crypto",{blocked(){location.reload()}})}addInViewRoom(e){this.roomsInView.push(e)}removeInViewRoom(e){this.roomsInView=this.roomsInView.filter(t=>t!==e)}addInViewSpace(e){this.spacesInView.push(e)}removeInViewSpace(e){this.spacesInView=this.spacesInView.filter(t=>t!==e)}addSpaceOpen(e){e!=="other"&&(this.spaceOpen.push(e),console.log("Space opened",e,"restarting sync"),this.sync.mustUpdateTxnID=!0)}removeSpaceOpen(e){e!=="other"&&(this.spaceOpen=this.spaceOpen.filter(t=>t!==e),this.sync.mustUpdateTxnID=!0)}getRooms(){return this.sync.rooms}getSpaces(){return[...this.sync.rooms].filter(e=>e.isSpace()&&!e.isTombstoned()).sort((e,t)=>e.getName()<t.getName()?-1:e.getName()>t.getName()?1:0)}getSpacesWithRooms(){const e=this.getSpaces(),t=new Set;for(const s of e){const i=s.getSpaceChildrenIDs(),r=new Set([...this.getRooms()].filter(o=>i.includes(o.roomID)));t.add({spaceRoom:s,children:r})}for(const s of this.getRooms()){if(s.isSpace()||s.isTombstoned())continue;const i=s.getSpaceParentIDs();for(const r of i){const o=[...this.getRooms()].find(u=>u.roomID===r.roomID);if(!o)continue;const a=[...t].find(u=>u.spaceRoom.roomID===o.roomID);if(a){[...a.children].find(u=>u.roomID===s.roomID)||a.children.add(s);continue}t.add({spaceRoom:o,children:new Set([s])})}}return t}async startSync(){await this.sync.startSync()}async fetchProfileInfo(e){if(globalThis.IS_STORYBOOK&&await new Promise(r=>setTimeout(r,5e3)),this.profileInfo)return this.profileInfo;if(!this.user.hostname)return new S;if(this.database||await this.createDatabase(),!this.user.access_token)return new oe;const t=await fetch(`${this.user.hostname}/_matrix/client/v3/profile/${e}`,{headers:{Authorization:`Bearer ${this.user.access_token}`}});if(!t.ok)return t.status===404||t.status===403?{}:new re(t);const s=await t.json();s.avatar_url&&(s.avatar_url=this.convertMXC(s.avatar_url)),this.profileInfo=s;const i=this.database?.transaction("loginInfo","readwrite");return await i?.store.put({userId:this.user.mxid,device_id:this.user.device_id,hostname:this.user.hostname,slidingSyncHostname:this.user.slidingSyncHostname,access_token:this.user.access_token,displayName:s.displayname,avatarUrl:s.avatar_url}),await i?.done,s}}function ve(n){return n.retry_after_ms!==void 0}const _e=await we.Instance(),$=R.createContext(_e);function be(){const n=R.useContext($),[e,t]=R.useState(n.getRooms());return R.useEffect(()=>{const s=i=>{t(i)};return n.on("rooms",s),n.startSync(),()=>{n.off("rooms",s)}},[]),e}function ct(n){return[...be()].find(t=>t.roomID===n)}function ut(){const n=R.useContext($),[e,t]=R.useState(n.getSpacesWithRooms());return R.useEffect(()=>{const s=i=>{t(n.getSpacesWithRooms())};return n.on("rooms",s),n.startSync(),()=>{n.off("rooms",s)}},[]),e}function dt(){const n=R.useContext($),[e,t]=R.useState(n.profileInfo||{displayname:n.mxid||"Unknown"});return R.useEffect(()=>{n.fetchProfileInfo(n.mxid).then(s=>{s instanceof v||(s.displayname||(s.displayname=n.mxid||"Unknown"),t(s))})},[]),e}const yt=Object.freeze(Object.defineProperty({__proto__:null,MatrixClient:we,MatrixContext:$,defaultMatrixClient:_e,isRateLimitError:ve,useProfile:dt,useRoom:ct,useRooms:be,useSpaces:ut},Symbol.toStringTag,{value:"Module"}));export{$ as M,pe as O,v as S,lt as a,ft as b,gt as c,pt as d,dt as e,ut as f,be as g,yt as h,mt as i,ct as u};
