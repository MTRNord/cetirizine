import{r as c,j as t,e as be,o as ve,N as G,L as je,a as b,b as y,c as $,d as S,T as J,H as X,f as Q,g as Z,h as Y,Q as ee,C as T,i as te,k as R,l as k,m as E,U as _e,R as ye,n as Ie,p as Ce,q as Se,s as se,t as B,B as Re,I as Ee,u as Le,S as ke,v as De,w as Pe,x as Oe,y as Ae,z as Me,A as $e,D as Te,E as He,F as Ue,G as ze,J as A,K as Fe,M as Be,O as Ve,P as We,V as qe,W as Ke,X as Ge,Y as Je,Z as Xe,_ as V,$ as Qe,a0 as Ze,a1 as Ye,a2 as et}from"./vendor-0d0c5e06.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=n(i);fetch(i.href,r)}})();const tt=c.memo(({type:s="button",style:e="primary",onClick:n,children:o,readonly:i})=>e==="secondary"?t.jsx("button",{disabled:i,onClick:n,className:"button bg-orange-400 hover:bg-orange-500 ease-out duration-150 disabled:bg-slate-200 disabled:cursor-not-allowed",type:s,children:o}):e==="abort"?t.jsx("button",{disabled:i,onClick:n,className:"button bg-red-400 hover:bg-red-500 ease-out duration-150 disabled:bg-slate-200 disabled:cursor-not-allowed",type:s,children:o}):t.jsx("button",{disabled:i,onClick:n,className:"button bg-green-400 hover:bg-green-500 ease-out duration-150 disabled:bg-slate-200 disabled:cursor-not-allowed",type:s,children:o})),st=c.memo(({children:s})=>t.jsx("h1",{className:"text-black font-bold text-xl",children:s})),W=c.memo(({placeholder:s,password:e=!1,autoFocus:n=!1,value:o,readonly:i,onChange:r})=>t.jsx("input",{disabled:i,className:"text-base form-input rounded-lg disabled:bg-slate-200 disabled:cursor-not-allowed transition-colors ease-in-out delay-150",value:o,type:e?"password":"text",autoFocus:n,placeholder:s,onChange:r}));function ot(s){return s.op==="SYNC"}function nt(s){return s.op==="INSERT"}function it(s){return s.op==="INVALIDATE"}function at(s){return s.op==="DELETE"}function rt(s){return s.type==="m.room.create"}function ct(s){return s.type==="m.room.avatar"}function lt(s){return s.type==="m.space.child"}function dt(s){return s.type==="m.space.parent"}class M{constructor(e,n){this.roomID=e,this.hostname=n}events=[];stateEvents=[];name;notification_count=0;notification_highlight_count=0;joined_count=0;invited_count=0;windowPos={};addEvents(e){this.events.push(...e)}addStateEvents(e){this.stateEvents.push(...e)}getAvatarURL(){let e;return this.stateEvents.forEach(n=>{if(ct(n)){const o=n.content.url;o?.startsWith("mxc://")&&(e=`${this.hostname}/_matrix/media/r0/download/${o.substring(6)}`)}}),e}isSpace(){let e=!1;return this.stateEvents.forEach(n=>{rt(n)&&(e=n.content.type==="m.space")}),e}setName(e){this.name=e}getName(){return this.name?this.name:this.roomID}setNotificationCount(e){this.notification_count=e}getNotificationCount(){return this.notification_count}setNotificationHighlightCount(e){this.notification_highlight_count=e}getNotificationHighlightCount(){return this.notification_highlight_count}setJoinedCount(e){this.joined_count=e}getJoinedCount(){return this.joined_count}setInvitedCount(e){this.invited_count=e}getInvitedCount(){return this.invited_count}getSpaceChildrenIDs(){const e=[];return this.stateEvents.forEach(n=>{lt(n)&&e.push(n.state_key)}),e}getSpaceParentIDs(){const e=[];return this.stateEvents.forEach(n=>{dt(n)&&e.push({roomID:n.state_key,canonical:n.content.canonical||!1})}),e}isDM(){return!1}isOnline(){return!1}}class mt extends be{static _instance;access_token;device_id;mxid;hostname;slidingSyncHostname;syncing=!1;roomsInView=[];rooms=new Set;syncPos;initialSync=!0;database;profileInfo;lastRanges;lastTxnID;get isLoggedIn(){return this.access_token!==void 0}static async Instance(){let e=this._instance;if(!e){e=this._instance=new this,e.database||await e.createDatabase();const n=e.database?.transaction("loginInfo","readonly"),o=await n?.store.getAll();if(await n?.done,o&&o.length>0){e.mxid=o[0].userId,e.hostname=o[0].hostname,e.slidingSyncHostname=o[0].slidingSyncHostname,e.access_token=o[0].access_token,e.device_id=o[0].device_id,e.profileInfo={avatar_url:o[0].avatarUrl,displayname:o[0].displayName};const i=e.database?.transaction("syncInfo","readonly"),r=await i?.store.get(e.mxid);await i?.done,r&&(e.syncPos=r.syncPos,e.initialSync=r.initialSync,e.lastRanges=r.lastRanges,e.lastTxnID=r.lastTxnID);const a=e.database?.transaction("rooms","readonly"),h=await a?.store.getAll();await a?.done,h&&(e.rooms=new Set(h.map(x=>{const m=new M(x.roomID,e.hostname);return m.windowPos=x.windowPos,m.setInvitedCount(x.invited_count),m.setJoinedCount(x.joined_count),m.setNotificationCount(x.notification_count),m.setNotificationHighlightCount(x.highlight_count),m.setName(x.name),x.events&&m.addEvents(x.events),x.stateEvents&&m.addStateEvents(x.stateEvents),m})),e.emit("rooms",e.rooms))}}return e}async createDatabase(){this.database=await ve("matrix",3,{upgrade(e){e.objectStoreNames.contains("rooms")&&e.deleteObjectStore("rooms"),e.objectStoreNames.contains("syncInfo")&&e.deleteObjectStore("syncInfo"),e.createObjectStore("rooms",{keyPath:"roomID"}),e.createObjectStore("loginInfo",{keyPath:"userId"}),e.createObjectStore("syncInfo",{keyPath:"userId"})}})}async setHostname(e){if(!e.startsWith("https://"))throw Error("Hostname must start with 'https://'");this.database||await this.createDatabase();const n=this.database?.transaction("loginInfo","readwrite");await n?.store.put({userId:this.mxid,hostname:e,slidingSyncHostname:this.slidingSyncHostname,access_token:this.access_token,device_id:this.device_id}),await n?.done,this.hostname=e}async startSync(){if(!this.isLoggedIn)throw Error("Not logged in");if(this.database||await this.createDatabase(),!this.syncing)for(this.syncing=!0;this.syncing;)try{await this.sync()}catch(e){console.error(e);return}}stopSync(){this.syncing=!1}isIndexInRange(e,n){for(const o of n)if(o[0]<e&&e<=o[1])return!0;return!1}shiftRight(e,n,o,i){for(let r=o-1;r>i-1;r--)if(this.isIndexInRange(r,n)){const a=[...this.rooms].find(h=>h.windowPos[e]===r+1);a&&(a.windowPos[e]=r)}}shiftLeft(e,n,o,i){for(let r=i+1;r<o+1;r++)if(this.isIndexInRange(r,n)){const a=[...this.rooms].find(h=>h.windowPos[e]===r-1);a&&(a.windowPos[e]=r)}}removeEntry(e,n,o){let i=-1;const r=[...this.rooms].map(a=>a.windowPos[e]);for(const a in r)Number(a)>i&&(i=Number(a));i<0||o>i||this.shiftLeft(e,n,i,o)}addEntry(e,n,o){let i=-1;const r=[...this.rooms].map(a=>a.windowPos[e]);for(const a in r)Number(a)>i&&(i=Number(a));i<0||o>i||this.shiftRight(e,n,i+1,o)}async sync(){if(!this.isLoggedIn)throw Error("Not logged in");if(!this.slidingSyncHostname)throw Error("Hostname must be set first");let e={overview:[[0,10]],spaces:[[0,Number.MAX_SAFE_INTEGER]]},n=1;if(!this.initialSync)for(const m in e){n=10;const d=[...this.rooms].filter(l=>this.roomsInView.includes(l.roomID)).map(l=>l.windowPos[m]).sort();d.push(d[d.length-1]+1);const f=d.reduce((l,u,g,v)=>g===0?(l.push([u,u]),l):u===v[g-1]+1?(l[l.length-1][1]=u,l):(l.push([u,u]),l),[]);e[m]=f}this.lastRanges&&Object.entries(e).toString()!==Object.entries(this.lastRanges).toString()&&(console.log("Ranges changed, resetting sync txn_id"),this.lastRanges=e,this.lastTxnID=Date.now().toString()),this.lastRanges||(this.lastRanges=e,this.lastTxnID=Date.now().toString());let o=`${this.slidingSyncHostname}/_matrix/client/unstable/org.matrix.msc3575/sync?timeout=30000`;this.syncPos&&(o=`${this.slidingSyncHostname}/_matrix/client/unstable/org.matrix.msc3575/sync?timeout=30000&pos=${this.syncPos}`);const i=await fetch(o,{method:"POST",headers:{Authorization:`Bearer ${this.access_token}`},body:JSON.stringify({txn_id:this.lastTxnID,lists:{spaces:{slow_get_all_rooms:!0,sort:["by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.avatar","*"]],timeline_limit:n,filters:{room_types:["m.space"]}},overview:{ranges:this.lastRanges.overview,sort:["by_notification_level","by_recency","by_name"],required_state:[["m.space.child","*"],["m.space.parent","*"],["m.room.create",""],["m.room.avatar","*"]],timeline_limit:n,filters:{}}},bump_event_types:["m.room.message","m.room.encrypted"]})});if(!i.ok){if(i.status===400&&(await i.json()).errcode==="M_UNKNOWN_POS"){this.syncPos=void 0;const m=this.database?.transaction("syncInfo","readwrite");await m?.store.put({userId:this.mxid,syncPos:this.syncPos,initialSync:this.initialSync,lastRanges:this.lastRanges,lastTxnID:this.lastTxnID}),await m?.done}throw console.error(i),Error("Error syncing. See console for error.")}const r=await i.json();this.syncPos=r.pos;const a=this.database?.transaction("syncInfo","readwrite");await a?.store.put({userId:this.mxid,syncPos:this.syncPos,initialSync:this.initialSync,lastRanges:this.lastRanges,lastTxnID:this.lastTxnID}),await a?.done;let h=-1;for(const m in r.lists){const d=r.lists[m];if(d.ops){for(const f of d.ops)if(ot(f)){const l=this.database?.transaction("rooms","readwrite");for(let u=f.range[0];u<=f.range[1];u++){const g=f.room_ids[u-f.range[0]];if(!g)break;const v=[...this.rooms].find(w=>w.roomID===g);if(v){v.windowPos[m]=u;continue}const p=new M(g,this.hostname);p.setName(g),p.windowPos[m]=u,this.rooms.add(p),await l?.store.put({windowPos:p.windowPos,roomID:p.roomID,name:p.getName(),notification_count:p.getNotificationCount(),highlight_count:p.getNotificationHighlightCount(),joined_count:p.getJoinedCount(),invited_count:p.getInvitedCount(),avatarUrl:p.getAvatarURL(),isSpace:p.isSpace()})}await l?.done}else if(nt(f)){console.log("Got INSERT OP",f),[...this.rooms].find(w=>w.windowPos[m]===f.index)&&(h<0?this.addEntry(m,this.lastRanges[m],f.index):h>f.index?this.shiftRight(m,this.lastRanges[m],h,f.index):h<f.index&&this.shiftLeft(m,this.lastRanges[m],f.index,h)),h=-1;const u=this.database?.transaction("rooms","readwrite"),g=[...this.rooms].find(w=>w.roomID===f.room_id);if(g)g.windowPos[m]=f.index,await u?.store.put({windowPos:g.windowPos,roomID:g.roomID,name:g.getName(),notification_count:g.getNotificationCount(),highlight_count:g.getNotificationHighlightCount(),joined_count:g.getJoinedCount(),invited_count:g.getInvitedCount(),avatarUrl:g.getAvatarURL(),isSpace:g.isSpace()});else{const w=new M(f.room_id,this.hostname);w.setName(f.room_id),w.windowPos[m]=f.index,this.rooms.add(w),await u?.store.put({windowPos:w.windowPos,roomID:w.roomID,name:w.getName(),notification_count:w.getNotificationCount(),highlight_count:w.getNotificationHighlightCount(),joined_count:w.getJoinedCount(),invited_count:w.getInvitedCount(),avatarUrl:w.getAvatarURL(),isSpace:w.isSpace()})}const v=[...this.rooms].map(w=>w.roomID),p=v.filter((w,N)=>v.indexOf(w)!=N);p.length>0&&console.error("Duplicates found",p),await u?.done}else if(at(f)){console.log("Got DELETE OP",f);const l=[...this.rooms].find(u=>u.windowPos[m]===f.index);if(l){const u=this.database?.transaction("rooms","readwrite");await u?.store.delete(l.roomID),await u?.done,this.rooms.delete(l)}h!==-1&&this.removeEntry(m,this.lastRanges[m],h),h=f.index}else if(it(f)){const l=this.database?.transaction("rooms","readwrite");for(let u=f.range[0];u<=f.range[1];u++){const g=[...this.rooms].find(v=>v.windowPos[m]===u);g&&(await l?.store.delete(g.roomID),this.rooms.delete(g))}await l?.done}h!==-1&&this.removeEntry(m,this.lastRanges[m],h)}}const x=this.database?.transaction("rooms","readwrite");for(const m in r.rooms){const d=r.rooms[m],f=d.name,l=d.notification_count,u=d.highlight_count,g=d.joined_count,v=d.invited_count,p=d.timeline,w=d.required_state,N=[...this.rooms].find(I=>I.roomID===m);if(!N){console.error("Could not find roomObj for roomID",m);continue}f&&N.setName(f),N.setNotificationCount(l),N.setNotificationHighlightCount(u),N.setJoinedCount(g),N.setInvitedCount(v),p&&N.addEvents(p),w&&N.addStateEvents(w),await x?.store.put({windowPos:N.windowPos,roomID:N.roomID,name:N.getName(),notification_count:N.getNotificationCount(),highlight_count:N.getNotificationHighlightCount(),joined_count:N.getJoinedCount(),invited_count:N.getInvitedCount(),events:p,stateEvents:w,avatarUrl:N.getAvatarURL(),isSpace:N.isSpace()})}await x?.done,r.rooms&&Object.keys(r.rooms).length>0&&this.emit("rooms",this.rooms)}addInViewRoom(e){this.roomsInView.push(e)}removeInViewRoom(e){this.roomsInView=this.roomsInView.filter(n=>n!==e)}getRooms(){return this.rooms}getSpaces(){return[...this.rooms].filter(e=>e.isSpace()).sort((e,n)=>e.getName()<n.getName()?-1:e.getName()>n.getName()?1:0)}getSpacesWithRooms(){const e=this.getSpaces(),n=new Set;for(const o of e){const i=o.getSpaceChildrenIDs(),r=new Set([...this.getRooms()].filter(a=>i.includes(a.roomID)));n.add({spaceRoom:o,children:r})}for(const o of this.getRooms()){const i=o.getSpaceParentIDs();for(const r of i){const a=[...this.getRooms()].find(x=>x.roomID===r.roomID);if(!a)continue;const h=[...n].find(x=>x.spaceRoom.roomID===a.roomID);if(h){[...h.children].find(x=>x.roomID===o.roomID)||h.children.add(o);continue}n.add({spaceRoom:a,children:new Set([o])})}}return n}async getLoginFlows(){if(!this.hostname)throw Error("Hostname must be set first");const e=await fetch(`${this.hostname}/_matrix/client/v3/login`);if(!e.ok)throw console.error(e),Error("Error requesting login flows. See console for error.");return await e.json()}async getWellKnown(){if(!this.hostname)throw Error("Hostname must be set first");const e=await fetch(`${this.hostname}/.well-known/matrix/client`);if(!e.ok)throw console.error(e),Error("Error requesting login flows. See console for error.");return await e.json()}async passwordLogin(e,n,o=5){if(this.database||await this.createDatabase(),!e)throw Error("Username must be set");if(!n)throw Error("Password must be set");this.mxid=e,await this.setHostname(`https://${e.split(":")[1]}`);try{const h=await this.getWellKnown();if(h["m.homeserver"]?.base_url&&await this.setHostname(h["m.homeserver"].base_url),h["org.matrix.msc3575.proxy"]?.url){const x=this.database?.transaction("loginInfo","readwrite");await x?.store.put({userId:this.mxid,hostname:this.hostname,slidingSyncHostname:h["org.matrix.msc3575.proxy"].url,access_token:this.access_token,device_id:this.device_id}),await x?.done,this.slidingSyncHostname=h["org.matrix.msc3575.proxy"].url}else throw Error("No sliding sync proxy found")}catch(h){console.warn(`No well-known found for ${this.hostname}:
${h}`)}if(((await this.getLoginFlows()).flows.filter(h=>h.type==="m.login.password")?.length||0)==0)throw Error("Password login is not supported by this homeserver");const r=await fetch(`${this.hostname}/_matrix/client/r0/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"m.login.password",identifier:{type:"m.id.user",user:e},user:e,password:n})});if(!r.ok)throw console.error(r),Error("Error logging in. See console for error.");const a=await r.json();if(ft(a))throw Error(`Error logging in: ${a.errcode}: ${a.error}`);if(ut(a)&&(console.error(`Rate limited. Retrying in ${a.retry_after_ms}ms. ${o} tries left.`),await this.passwordLogin(e,n,o-1)),ht(a)){const h=this.database?.transaction("loginInfo","readwrite");await h?.store.put({userId:a.user_id,hostname:this.hostname,slidingSyncHostname:this.slidingSyncHostname,access_token:a.access_token,device_id:a.device_id}),await h?.done,this.access_token=a.access_token,this.device_id=a.device_id,this.mxid=a.user_id}}async fetchProfileInfo(e){if(this.profileInfo)return this.profileInfo;if(!this.hostname)throw Error("Hostname must be set first");if(this.database||await this.createDatabase(),!this.access_token)throw Error("Access token must be set first");const n=await fetch(`${this.hostname}/_matrix/client/r0/profile/${e}`,{headers:{Authorization:`Bearer ${this.access_token}`}});if(!n.ok){if(n.status===404||n.status===403)return{};throw console.error(n),Error("Error fetching profile info. See console for error.")}const o=await n.json();o.avatar_url=o.avatar_url?.replace("mxc://",`${this.hostname}/_matrix/media/r0/download/`),this.profileInfo=o;const i=this.database?.transaction("loginInfo","readwrite");return await i?.store.put({userId:this.mxid,device_id:this.device_id,hostname:this.hostname,slidingSyncHostname:this.slidingSyncHostname,access_token:this.access_token,displayName:o.displayname,avatarUrl:o.avatar_url}),await i?.done,o}}function ut(s){return s.retry_after_ms!==void 0}function ht(s){return s.access_token!==void 0}function ft(s){return s.errcode!==void 0}const oe=await mt.Instance(),L=c.createContext(oe);function gt(){const s=c.useContext(L),[e,n]=c.useState(s.getRooms());return c.useEffect(()=>{const o=i=>{n(i)};return s.on("rooms",o),s.startSync(),()=>{s.removeListener("rooms",o)}},[]),e}function pt(){const s=c.useContext(L),[e,n]=c.useState(s.getSpacesWithRooms());return c.useEffect(()=>{const o=i=>{n(s.getSpacesWithRooms())};return s.on("rooms",o),s.startSync(),()=>{s.removeListener("rooms",o)}},[]),e}function xt(){const s=c.useContext(L),[e,n]=c.useState({displayname:s.mxid||"Unknown"});return c.useEffect(()=>{s.fetchProfileInfo(s.mxid).then(o=>{o.displayname||(o.displayname=s.mxid||"Unknown"),n(o)})},[]),e}const wt=c.memo(()=>{const s=c.useContext(L),[e,n]=c.useState(!1),[o,i]=c.useState(""),[r,a]=c.useState(""),[h,x]=c.useState("");if(s.isLoggedIn)return t.jsx(G,{to:"/"});const m=async()=>{try{n(!0),await s.passwordLogin(r,h)}catch(d){i(d.toString())}n(!1)};return t.jsxs("form",{className:"flex flex-col rounded-md shadow p-4 bg-white gap-2 min-w-[30rem]",onSubmit:d=>{d.preventDefault(),m()},children:[t.jsx(st,{children:"Login"}),o?t.jsx("h2",{className:"text-red-500 font-normal text-sm",children:o}):t.jsx("div",{className:"min-h-[1.25rem]"}),t.jsx(W,{readonly:e,value:r,placeholder:"Username",onChange:d=>a(d.target.value)}),t.jsx(W,{readonly:e,value:h,password:!0,placeholder:"Password",onChange:d=>x(d.target.value)}),t.jsx(tt,{readonly:e,style:"primary",type:"submit",children:"Login"})]})}),Nt=c.memo(()=>t.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen bg-img",children:t.jsx(wt,{})})),H=c.memo(({avatarUrl:s,displayname:e,dm:n=!1,online:o=!1})=>s?t.jsxs("div",{className:"flex relative min-w-[2rem] min-h-[2rem] justify-center items-center m-0 mr-3 text-xl rounded-full text-white",children:[t.jsx("img",{className:"rounded-full w-8 h-8",alt:e,src:s}),n?o?t.jsx("div",{className:"bg-green-500 rounded-full w-3 h-3 absolute bottom-0 right-0"}):t.jsx("div",{className:"bg-red-500 rounded-full w-3 h-3 absolute bottom-0 right-0"}):t.jsx(t.Fragment,{})]}):t.jsxs("div",{className:"flex relative min-w-[2rem] min-h-[2rem] bg-orange-500 justify-center items-center m-0 mr-3 text-xl rounded-full text-white",children:[e[0].toUpperCase(),n?o?t.jsx("div",{className:"bg-green-500 rounded-full w-3 h-3 absolute bottom-0 right-0"}):t.jsx("div",{className:"bg-red-500 rounded-full w-3 h-3 absolute bottom-0 right-0"}):t.jsx(t.Fragment,{})]})),bt=/((https?:\/\/(www\.)?)|(www\.))[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_+.~#?&//=]*)/,vt=/(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))/,jt=[s=>{const e=bt.exec(s);return e&&{index:e.index,length:e[0].length,text:e[0],url:e[0]}},s=>{const e=vt.exec(s);return e&&{index:e.index,length:e[0].length,text:e[0],url:`mailto:${e[0]}`}}];function _t(){return t.jsx(je.AutoLinkPlugin,{matchers:jt})}const P=1,yt=new Set(["paragraph","quote","code","h1","h2","ul","ol"]),It={code:"Code Block",h1:"Large Heading",h2:"Small Heading",h3:"Heading",h4:"Heading",h5:"Heading",ol:"Numbered List",paragraph:"Normal",quote:"Quote",ul:"Bulleted List"},q=c.memo(()=>t.jsx("div",{className:"divider"}));function K(s,e){e?(s.style.opacity="1",s.style.top=`${e.top+e.height+window.pageYOffset+10}px`,s.style.left=`${e.left+window.pageXOffset-s.offsetWidth/2+e.width/2}px`):(s.style.opacity="0",s.style.top="-1000px",s.style.left="-1000px")}const Ct=c.memo(({editor:s})=>{const e=c.useRef(null),n=c.useRef(null),o=c.useRef(!1),[i,r]=c.useState(""),[a,h]=c.useState(!1),[x,m]=c.useState(null),d=c.useCallback(()=>{const l=b.$getSelection();if(b.$isRangeSelection(l)){const w=ne(l),N=w.getParent();y.$isLinkNode(N)?r(N.getURL()):y.$isLinkNode(w)?r(w.getURL()):r("")}const u=e.current,g=window.getSelection(),v=document.activeElement;if(u===null)return;const p=s.getRootElement();if(l!==null&&!g?.isCollapsed&&p!==null&&p.contains(g?.anchorNode)){const w=g?.getRangeAt(0);let N;if(g?.anchorNode===p){let I=p;for(;I.firstElementChild!=null;)I=I.firstElementChild;N=I.getBoundingClientRect()}else N=w?.getBoundingClientRect();o.current||K(u,N),m(l)}else(!v||v.className!=="link-input")&&(K(u,void 0),m(null),h(!1),r(""));return!0},[s]);c.useEffect(()=>$.mergeRegister(s.registerUpdateListener(({editorState:l})=>{l.read(()=>{d()})}),s.registerCommand(b.SELECTION_CHANGE_COMMAND,()=>(d(),!0),P)),[s,d]),c.useEffect(()=>{s.getEditorState().read(()=>{d()})},[s,d]),c.useEffect(()=>{a&&n.current&&n.current.focus()},[a]);const f=c.createElement("a",{href:i,target:"_blank",rel:"noopener noreferrer"},i);return t.jsx("div",{ref:e,className:"link-editor",children:a?t.jsx("input",{ref:n,className:"link-input",value:i,onChange:l=>{r(l.target.value)},onKeyDown:l=>{l.key==="Enter"?(l.preventDefault(),x!==null&&(i!==""&&s.dispatchCommand(y.TOGGLE_LINK_COMMAND,i),h(!1))):l.key==="Escape"&&(l.preventDefault(),h(!1))}}):t.jsx(t.Fragment,{children:t.jsxs("div",{className:"link-input",children:[f,t.jsx("div",{className:"link-edit",role:"button",tabIndex:0,onMouseDown:l=>l.preventDefault(),onClick:()=>{h(!0)}})]})})})}),St=c.memo(({onChange:s,className:e,options:n,value:o})=>t.jsxs("select",{className:e,onChange:s,value:o,children:[t.jsx("option",{hidden:!0,value:""}),n.map(i=>t.jsx("option",{value:i,children:i},i))]}));function ne(s){const e=s.anchor,n=s.focus,o=s.anchor.getNode(),i=s.focus.getNode();return o===i?o:s.isBackward()?S.$isAtNodeEnd(n)?o:i:S.$isAtNodeEnd(e)?i:o}const Rt=c.memo(({editor:s,blockType:e,toolbarRef:n,setShowBlockOptionsDropDown:o})=>{const i=c.useRef(null);c.useEffect(()=>{const l=i.current,u=n.current;if(l!==null&&u!==null){const g=v=>{const p=v.target;!l.contains(p)&&!u.contains(p)&&o(!1)};return document.addEventListener("click",g),()=>{document.removeEventListener("click",g)}}},[i,o,n]);const r=()=>{e!=="paragraph"&&s.update(()=>{const l=b.$getSelection();b.$isRangeSelection(l)&&S.$wrapNodes(l,()=>b.$createParagraphNode())}),o(!1)},a=()=>{e!=="h1"&&s.update(()=>{const l=b.$getSelection();b.$isRangeSelection(l)&&S.$wrapNodes(l,()=>k.$createHeadingNode("h1"))}),o(!1)},h=()=>{e!=="h2"&&s.update(()=>{const l=b.$getSelection();b.$isRangeSelection(l)&&S.$wrapNodes(l,()=>k.$createHeadingNode("h2"))}),o(!1)},x=()=>{e!=="ul"?s.dispatchCommand(R.INSERT_UNORDERED_LIST_COMMAND,void 0):s.dispatchCommand(R.REMOVE_LIST_COMMAND,void 0),o(!1)},m=()=>{e!=="ol"?s.dispatchCommand(R.INSERT_ORDERED_LIST_COMMAND,void 0):s.dispatchCommand(R.REMOVE_LIST_COMMAND,void 0),o(!1)},d=()=>{e!=="quote"&&s.update(()=>{const l=b.$getSelection();b.$isRangeSelection(l)&&S.$wrapNodes(l,()=>k.$createQuoteNode())}),o(!1)},f=()=>{e!=="code"&&s.update(()=>{const l=b.$getSelection();b.$isRangeSelection(l)&&S.$wrapNodes(l,()=>E.$createCodeNode())}),o(!1)};return t.jsxs("div",{className:"dropdown",ref:i,children:[t.jsxs("button",{className:"item",onClick:r,children:[t.jsx(J,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Normal"}),e==="paragraph"&&t.jsx("span",{className:"active"})]}),t.jsxs("button",{className:"item",onClick:a,children:[t.jsx(X,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Large Heading"}),e==="h1"&&t.jsx("span",{className:"active"})]}),t.jsxs("button",{className:"item",onClick:h,children:[t.jsx(Q,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Small Heading"}),e==="h2"&&t.jsx("span",{className:"active"})]}),t.jsxs("button",{className:"item",onClick:x,children:[t.jsx(Z,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Bullet List"}),e==="ul"&&t.jsx("span",{className:"active"})]}),t.jsxs("button",{className:"item",onClick:m,children:[t.jsx(Y,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Numbered List"}),e==="ol"&&t.jsx("span",{className:"active"})]}),t.jsxs("button",{className:"item",onClick:d,children:[t.jsx(ee,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Quote"}),e==="quote"&&t.jsx("span",{className:"active"})]}),t.jsxs("button",{className:"item",onClick:f,children:[t.jsx(T,{className:"icon",size:20}),t.jsx("span",{className:"text",children:"Code Block"}),e==="code"&&t.jsx("span",{className:"active"})]})]})}),Et=c.memo(()=>{const[s]=te.useLexicalComposerContext(),e=c.useRef(null),[n,o]=c.useState(!1),[i,r]=c.useState(!1),[a,h]=c.useState("paragraph"),[x,m]=c.useState(null),[d,f]=c.useState(!1),[l,u]=c.useState(""),[g,v]=c.useState(!1),[p,w]=c.useState(!1),[N,I]=c.useState(!1),[ie,ae]=c.useState(!1),[re,ce]=c.useState(!1),[le,de]=c.useState(!1),[me,ue]=c.useState(!1),O=c.useCallback(()=>{const j=b.$getSelection();if(b.$isRangeSelection(j)){const _=j.anchor.getNode(),C=_.getKey()==="root"?_:_.getTopLevelElementOrThrow(),z=C.getKey();if(s.getElementByKey(z)!==null)if(m(z),R.$isListNode(C)){const D=$.$getNearestNodeOfType(_,R.ListNode),Ne=D?D.getTag():C.getTag();h(Ne)}else{const D=k.$isHeadingNode(C)?C.getTag():C.getType();h(D),E.$isCodeNode(C)&&u(C.getLanguage()||E.getDefaultCodeLanguage())}I(j.hasFormat("bold")),ae(j.hasFormat("italic")),ce(j.hasFormat("underline")),de(j.hasFormat("strikethrough")),ue(j.hasFormat("code")),v(S.$isParentElementRTL(j));const F=ne(j),we=F.getParent();y.$isLinkNode(we)||y.$isLinkNode(F)?w(!0):w(!1)}},[s]);c.useEffect(()=>$.mergeRegister(s.registerUpdateListener(({editorState:j})=>{j.read(()=>{O()})}),s.registerCommand(b.SELECTION_CHANGE_COMMAND,(j,_)=>(O(),!1),P),s.registerCommand(b.CAN_UNDO_COMMAND,j=>(o(j),!1),P),s.registerCommand(b.CAN_REDO_COMMAND,j=>(r(j),!1),P)),[s,O]);const he=c.useMemo(()=>E.getCodeLanguages(),[]),fe=c.useCallback(j=>{s.update(()=>{if(x!==null){const _=b.$getNodeByKey(x);E.$isCodeNode(_)&&_.setLanguage(j.target.value)}})},[s,x]),ge=c.useCallback(()=>{p?s.dispatchCommand(y.TOGGLE_LINK_COMMAND,null):s.dispatchCommand(y.TOGGLE_LINK_COMMAND,"https://")},[s,p]),[pe,xe]=c.useState(null);return c.useEffect(()=>{const j=document.getElementsByClassName("editor-container")[0],_=document.createElement("div");return j.prepend(_),xe(_),()=>{j.removeChild(_)}},[]),t.jsxs("div",{className:"toolbar",ref:e,children:[t.jsx("button",{disabled:!n,onClick:()=>{s.dispatchCommand(b.UNDO_COMMAND,void 0)},className:"toolbar-item spaced","aria-label":"Undo",children:t.jsx(_e,{className:"format",size:20})}),t.jsx("button",{disabled:!i,onClick:()=>{s.dispatchCommand(b.REDO_COMMAND,void 0)},className:"toolbar-item","aria-label":"Redo",children:t.jsx(ye,{className:"format",size:20})}),t.jsx(q,{}),yt.has(a)&&t.jsxs(t.Fragment,{children:[t.jsxs("button",{className:"toolbar-item block-controls",onClick:()=>f(!d),"aria-label":"Formatting Options",children:[a==="h1"?t.jsx(X,{className:"icon",size:20}):a==="h2"?t.jsx(Q,{className:"icon",size:20}):a==="h3"?t.jsx(Ie,{className:"icon",size:20}):a==="h4"?t.jsx(Ce,{className:"icon",size:20}):a==="h5"?t.jsx(Se,{className:"icon",size:20}):a==="code"?t.jsx(T,{className:"icon",size:20}):a==="paragraph"?t.jsx(J,{className:"icon",size:20}):a==="ol"?t.jsx(Y,{className:"icon",size:20}):a==="ul"?t.jsx(Z,{className:"icon",size:20}):a==="quote"?t.jsx(ee,{className:"icon",size:20}):t.jsx(t.Fragment,{}),t.jsx("span",{className:"text",children:It[a]}),t.jsx(se,{size:20})]}),d&&B.createPortal(t.jsx(Rt,{editor:s,blockType:a,toolbarRef:e,setShowBlockOptionsDropDown:f}),pe),t.jsx(q,{})]}),a==="code"?t.jsxs(t.Fragment,{children:[t.jsx(St,{className:"toolbar-item code-language",onChange:fe,options:he,value:l}),t.jsx("i",{className:"chevron-down inside"})]}):t.jsxs(t.Fragment,{children:[t.jsx("button",{onClick:()=>{s.dispatchCommand(b.FORMAT_TEXT_COMMAND,"bold")},className:"toolbar-item spaced "+(N?"active":""),"aria-label":"Format Bold",children:t.jsx(Re,{className:"format",size:20})}),t.jsx("button",{onClick:()=>{s.dispatchCommand(b.FORMAT_TEXT_COMMAND,"italic")},className:"toolbar-item spaced "+(ie?"active":""),"aria-label":"Format Italics",children:t.jsx(Ee,{className:"format",size:20})}),t.jsx("button",{onClick:()=>{s.dispatchCommand(b.FORMAT_TEXT_COMMAND,"underline")},className:"toolbar-item spaced "+(re?"active":""),"aria-label":"Format Underline",children:t.jsx(Le,{className:"format",size:20})}),t.jsx("button",{onClick:()=>{s.dispatchCommand(b.FORMAT_TEXT_COMMAND,"strikethrough")},className:"toolbar-item spaced "+(le?"active":""),"aria-label":"Format Strikethrough",children:t.jsx(ke,{className:"format",size:20})}),t.jsx("button",{onClick:()=>{s.dispatchCommand(b.FORMAT_TEXT_COMMAND,"code")},className:"toolbar-item spaced "+(me?"active":""),"aria-label":"Insert Code",children:t.jsx(T,{className:"format",size:20})}),t.jsx("button",{onClick:ge,className:"toolbar-item spaced "+(p?"active":""),"aria-label":"Insert Link",children:t.jsx(De,{className:"format",size:20})}),p&&B.createPortal(t.jsx(Ct,{editor:s}),document.body)," "]})]})});function Lt(){const[s]=te.useLexicalComposerContext();return c.useEffect(()=>E.registerCodeHighlighting(s),[s]),null}const kt={ltr:"ltr",rtl:"rtl",placeholder:"editor-placeholder",paragraph:"editor-paragraph",quote:"editor-quote",heading:{h1:"editor-heading-h1",h2:"editor-heading-h2",h3:"editor-heading-h3",h4:"editor-heading-h4",h5:"editor-heading-h5"},list:{nested:{listitem:"editor-nested-listitem"},ol:"editor-list-ol",ul:"editor-list-ul",listitem:"editor-listitem"},image:"editor-image",link:"editor-link",text:{bold:"editor-text-bold",italic:"editor-text-italic",overflowed:"editor-text-overflowed",hashtag:"editor-text-hashtag",underline:"editor-text-underline",strikethrough:"editor-text-strikethrough",underlineStrikethrough:"editor-text-underlineStrikethrough",code:"editor-text-code"},code:"editor-code",codeHighlight:{atrule:"editor-tokenAttr",attr:"editor-tokenAttr",boolean:"editor-tokenProperty",builtin:"editor-tokenSelector",cdata:"editor-tokenComment",char:"editor-tokenSelector",class:"editor-tokenFunction","class-name":"editor-tokenFunction",comment:"editor-tokenComment",constant:"editor-tokenProperty",deleted:"editor-tokenProperty",doctype:"editor-tokenComment",entity:"editor-tokenOperator",function:"editor-tokenFunction",important:"editor-tokenVariable",inserted:"editor-tokenSelector",keyword:"editor-tokenAttr",namespace:"editor-tokenVariable",number:"editor-tokenProperty",operator:"editor-tokenOperator",prolog:"editor-tokenComment",property:"editor-tokenProperty",punctuation:"editor-tokenPunctuation",regex:"editor-tokenVariable",selector:"editor-tokenSelector",string:"editor-tokenSelector",symbol:"editor-tokenProperty",tag:"editor-tokenProperty",url:"editor-tokenOperator",variable:"editor-tokenVariable"}};function Dt(){return t.jsx("div",{className:"editor-placeholder",id:"editor-placeholder",children:"Enter message..."})}const Pt=c.memo(({namespace:s,onChange:e,onError:n})=>{const o={namespace:s,theme:kt,onError:n,nodes:[k.HeadingNode,R.ListNode,R.ListItemNode,k.QuoteNode,E.CodeNode,E.CodeHighlightNode,A.TableNode,A.TableCellNode,A.TableRowNode,y.AutoLinkNode,y.LinkNode]};return t.jsx(Pe.LexicalComposer,{initialConfig:o,children:t.jsxs("div",{className:"editor-container",children:[t.jsx(Et,{}),t.jsxs("div",{className:"editor-inner",children:[t.jsx(Oe.RichTextPlugin,{contentEditable:t.jsx(Ae.ContentEditable,{className:"editor-input",ariaLabelledBy:"editor-placeholder"}),placeholder:t.jsx(Dt,{}),ErrorBoundary:Me}),t.jsx($e.OnChangePlugin,{onChange:e}),t.jsx(Te.HistoryPlugin,{}),t.jsx(He.LinkPlugin,{}),t.jsx(Lt,{}),t.jsx(_t,{}),t.jsx(Ue.MarkdownShortcutPlugin,{transformers:ze.TRANSFORMERS})]})]})})}),Ot=c.memo(({roomId:s,avatarUrl:e,displayname:n,dm:o=!1,online:i=!1,active:r=!1,onClick:a,hidden:h})=>{const{ref:x,inView:m}=Fe({triggerOnce:!0,rootMargin:"200px 0px",skip:h}),d=c.useContext(L);return c.useEffect(()=>{m?d.addInViewRoom(s):d.removeInViewRoom(s)},[m]),t.jsx("div",{ref:x,onClick:a,className:"w-full cursor-pointer",children:m&&(r?t.jsxs("div",{className:"flex flex-row gap-2 p-1 bg-gray-300 hover:bg-gray-400 rounded-lg duration-200 ease-in-out items-center",children:[t.jsx(H,{avatarUrl:e,displayname:n,dm:o,online:i}),t.jsx("span",{title:n,className:"text-slate-900 font-normal text-base capitalize max-w-[32ch] overflow-hidden text-ellipsis w-full whitespace-nowrap",children:n})]}):t.jsxs("div",{className:"flex flex-row gap-2 p-1 hover:bg-gray-300 rounded-lg duration-200 ease-in-out items-center",children:[t.jsx(H,{avatarUrl:e,displayname:n,dm:o,online:i}),t.jsx("span",{title:n,className:"text-slate-900 font-normal text-base capitalize max-w-[32ch] overflow-hidden text-ellipsis w-full whitespace-nowrap",children:n})]}))})});const At=c.memo(({sectionID:s,rooms:e,onClick:n,activeRoom:o,hidden:i})=>{const r=e.map(a=>t.jsx(Ot,{roomId:a.roomID,hidden:i,avatarUrl:a.avatarUrl,displayname:a.displayname,dm:a.dm,online:a.online,active:a.roomID===o,onClick:()=>{n(a.roomID)}},`${a.roomID}+${s}`));return t.jsx(t.Fragment,{children:r})}),U=c.memo(({section:s,onRoomClick:e,activeRoom:n})=>{const[o,i]=c.useState(!0);return t.jsxs("div",{className:"flex flex-col gap-1 pl-4",children:[t.jsxs("div",{className:"flex flex-row gap-2 py-1  items-center justify-start cursor-pointer h-8 text-slate-600",onClick:()=>i(r=>!r),children:[o?t.jsx(Be,{size:14}):t.jsx(se,{size:14}),t.jsx("span",{className:"font-normal text-sm capitalize max-w-[32ch] overflow-hidden text-ellipsis w-full whitespace-nowrap",children:s.sectionName})]}),!o&&t.jsx(At,{hidden:o,sectionID:s.roomID,rooms:s.rooms,onClick:e,activeRoom:n}),!o&&s.subsections.map(r=>t.jsx(U,{section:r,onRoomClick:e,activeRoom:n},r.roomID))]},s.roomID)}),Mt=c.memo(({sections:s,rooms:e})=>{const[n,o]=c.useState(void 0),i=Ve();return t.jsxs("div",{className:"flex flex-col gap-1 flex-1 p-2 min-w-[33ch] h-full overflow-y-auto overflow-x-hidden scrollbarSmall",children:[s.map(r=>t.jsx(U,{section:r,onRoomClick:a=>{o(a),i(`/${encodeURI(a)}`)},activeRoom:n},r.roomID)),t.jsx(U,{section:{sectionName:"Others",roomID:"other",subsections:[],rooms:e},onRoomClick:r=>{o(r),i(`/${encodeURI(r)}`)},activeRoom:n})]})});const $t=c.memo(()=>{const s=xt(),e=pt(),n=gt(),o=c.useContext(L),i=[...e].filter(({spaceRoom:d})=>{const f=![...e].some(({children:u})=>[...u].some(g=>g.roomID===d.roomID)),l=d.getSpaceParentIDs().length===0;return f&&l}),r=[...n].filter(d=>{const f=![...e].some(({children:g})=>[...g].some(v=>v.roomID===d.roomID)),l=d.getSpaceParentIDs().length===0,u=!d.isSpace();return f&&l&&u}),a=i.map(d=>{const f=[...d.children].filter(u=>!u.isSpace()).map(u=>({roomID:u.roomID,displayname:u.getName(),avatarUrl:u.getAvatarURL(),dm:u.isDM(),online:u.isOnline()})),l=u=>{const g=[...e].find(v=>v.spaceRoom.roomID===u.roomID);if(g){const v=[...g?.children].map(p=>({roomID:p.roomID,displayname:p.getName(),avatarUrl:p.getAvatarURL(),dm:p.isDM(),online:p.isOnline()}));return{sectionName:u.getName(),rooms:v,roomID:u.roomID,subsections:[...g?.children].filter(p=>p.isSpace()).map(l).filter(p=>p!==void 0)}}};return{sectionName:d.spaceRoom.getName(),rooms:f,roomID:d.spaceRoom.roomID,subsections:[...d.children].filter(u=>u.isSpace()).map(l)}}),h=r.filter(d=>!d.isSpace()).map(d=>({roomID:d.roomID,displayname:d.getName(),avatarUrl:d.getAvatarURL(),dm:d.isDM(),online:d.isOnline()})),x=h.map(d=>d.roomID),m=x.filter((d,f)=>x.indexOf(d)!==f);return m.length>0&&console.error("otherRooms has duplicates",m),t.jsxs("div",{className:"flex flex-row w-full gap-2 min-h-screen h-screen",children:[t.jsxs("div",{className:"flex flex-col bg-gradient-to-br from-slate-100 via-gray-200 to-orange-200 border-r-[1px] border-slate-300",children:[t.jsxs("div",{className:"flex flex-row gap-2 m-2 p-1 items-center border-b-2",children:[t.jsx(H,{displayname:s.displayname||o.mxid,avatarUrl:s?.avatar_url,dm:!1,online:!1}),t.jsxs("div",{className:"flex flex-row justify-between items-center w-full",children:[t.jsx("span",{className:"text-base font-semibold",children:s?.displayname}),t.jsx(We,{size:28,stroke:"unset",className:"stroke-slate-600 rounded-full hover:bg-slate-300 p-1 cursor-pointer"})]})]}),t.jsx(Mt,{sections:a,rooms:h})]}),t.jsxs("div",{className:"flex-1 flex flex-col",children:[t.jsx("div",{className:"flex-1"}),t.jsx(Pt,{namespace:"Editor",onChange:()=>{},onError:d=>console.error(d)})]})]})}),Tt=({children:s})=>c.useContext(L).isLoggedIn?s:t.jsx(G,{to:"login"});qe.init({locateFile:()=>Ke}).then(()=>{console.log("Using WebAssembly Olm")}).catch(s=>(console.log("Failed to load Olm: trying legacy version",s),new Promise((e,n)=>{const o=document.createElement("script");o.src=Ge,o.onload=e,o.onerror=n,document.body.appendChild(o)}).then(()=>window.Olm.init()).then(()=>{console.log("Using legacy Olm")}).catch(e=>{console.log("Both WebAssembly and asm.js Olm failed!",e)})));function Ht(){return t.jsx(Je,{basename:"/cetirizine/",children:t.jsxs(Xe,{children:[t.jsx(V,{path:"/:roomIdOrAlias?",element:t.jsx(Tt,{children:t.jsx($t,{})})}),t.jsx(V,{path:"/login",element:t.jsx(Nt,{})})]})})}const Ut=c.memo(Ht);Qe();Ze();const zt=document.getElementById("root"),Ft=Ye(zt);Ft.render(t.jsx(et.StrictMode,{children:t.jsx(L.Provider,{value:oe,children:t.jsx(Ut,{})})}));
